import{u as Z}from"./api-d479bee2.js";import{_ as x,d as ee,F as te,R as ae,D as oe,u as se,q as le,a as L,r as I,o as ne,s as ie,m as v,e as m,f as y,c as a,w as o,g as r,p as T,i as n,k as M,v as W,j as f,t as C,x as Y}from"./index-827e089e.js";import{P as re}from"./PageHeader-2fef59b0.js";import{U as de}from"./UploadOutlined-3141d868.js";import"./axios-3a665b0f.js";const ue=ee({name:"NovelProcessorView",components:{PageHeader:re,UploadOutlined:de,FileTextOutlined:te,ReadOutlined:ae,DownloadOutlined:oe},setup(){const t=Z(),e=se(),j=le(),d=L({voiceId:"female_young",ttsEngine:"neural",emotionType:"neutral",emotionIntensity:.5,speedScale:1,pitchScale:1,splitByChapter:!0,mergeAudio:!0,useCharacterVoiceMapping:!0,enableEmotionDetection:!0}),u=L({id:"",name:"",size:0,path:""}),P=I([]),E=I([]),$=I(!1),_=[{title:"角色名称",dataIndex:"name",key:"name"},{title:"声音",dataIndex:"voice_name",key:"voice"},{title:"属性",dataIndex:"attributes",key:"attributes"}],w=I(!1),p=I(""),k=I("pending"),V=I(0),g=L({total_chapters:0,processed_chapters:0,estimated_time_remaining:0});ne(async()=>{F();const s=e.query.id;s&&await c(s)}),ie(()=>e.query.id,async(s,l)=>{s&&s!==l&&await c(s)});const F=async()=>{try{const s=await t.getNovels();s&&Array.isArray(s)&&(E.value=s.map(l=>{var S,b;return{value:l.id,label:l.name,gender:(S=l.attributes)==null?void 0:S.gender,age:(b=l.attributes)==null?void 0:b.age_group}}))}catch(s){console.error("获取声音列表失败",s)}},c=async s=>{try{const l=await t.getNovelDetails(s);l&&(u.id=s,u.name=l.name,u.size=l.size,u.path=l.path,l.config&&(d.voiceId=l.config.defaultVoice||"female_young",d.splitByChapter=l.config.splitByChapter!==!1,d.useCharacterVoiceMapping=l.config.useVoiceMapping!==!1,d.enableEmotionDetection=l.config.detectEmotion!==!1),A(),v.success(`已加载小说: ${l.name}`))}catch(l){v.error(`加载小说信息失败: ${l.message||"未知错误"}`)}},A=async()=>{try{const s=await t.getCharacterMappings();s&&Array.isArray(s)&&(P.value=s)}catch(s){console.error("获取角色声音映射失败",s)}},q=()=>{$.value=!0},h=()=>{j.push("/character-mapper")},z=s=>s.type==="text/plain"||s.name.endsWith(".txt")||s.name.endsWith(".md")?s.size/1024/1024>10?(v.error("文件大小不能超过10MB!"),!1):!0:(v.error("只能上传TXT或MD文件!"),!1),D=async({file:s})=>{w.value=!0;try{const l=await t.uploadNovel(s);l&&l.success?(v.success("文件上传成功"),u.id=l.id||"",u.name=s.name,u.size=s.size,u.path=l.file_path):v.error((l==null?void 0:l.message)||"文件上传失败")}catch(l){v.error("文件上传失败: "+(l.message||"未知错误")),console.error("上传错误",l)}finally{w.value=!1}},O=async()=>{if(!u.path&&!u.id){v.warning("请先上传小说文件或从列表选择小说");return}w.value=!0;try{const s={novel_id:u.id,novel_path:u.path,voice_id:d.voiceId,tts_engine:d.ttsEngine,emotion_type:d.emotionType,emotion_intensity:d.emotionIntensity,speed_scale:d.speedScale,pitch_scale:d.pitchScale,split_by_chapter:d.splitByChapter,merge_audio:d.mergeAudio,use_character_mapping:d.useCharacterVoiceMapping,enable_emotion_detection:d.enableEmotionDetection},l=await t.processNovel(u.path||u.id,s);l&&l.task_id?(v.success("任务提交成功"),p.value=l.task_id,k.value="pending",V.value=0,B()):v.error((l==null?void 0:l.message)||"任务提交失败")}catch(s){v.error("任务提交失败: "+(s.message||"未知错误")),console.error("处理错误",s)}finally{w.value=!1}},B=async()=>{if(p.value)try{const s=await t.getTaskDetails(p.value);s&&(k.value=s.status,V.value=s.progress||0,s.details&&(g.total_chapters=s.details.total_chapters||0,g.processed_chapters=s.details.processed_chapters||0,g.estimated_time_remaining=s.details.estimated_time_remaining||0),k.value==="processing"||k.value==="pending"?setTimeout(B,3e3):k.value==="completed"?v.success("小说处理完成"):k.value==="failed"&&v.error(s.message||"小说处理失败"))}catch(s){console.error("获取任务状态失败",s),setTimeout(B,5e3)}};return{formState:d,fileInfo:u,processing:w,taskId:p,taskStatus:k,taskProgress:V,taskDetails:g,availableVoices:E,characterVoiceMappings:P,mappingModalVisible:$,mappingColumns:_,uploadNovel:D,processNovel:O,resetForm:()=>{d.voiceId="female_young",d.ttsEngine="neural",d.emotionType="neutral",d.emotionIntensity=.5,d.speedScale=1,d.pitchScale=1,d.splitByChapter=!0,d.mergeAudio=!0,d.useCharacterVoiceMapping=!0,d.enableEmotionDetection=!0,u.id="",u.name="",u.size=0,u.path="",p.value="",k.value="pending",V.value=0},beforeUpload:z,downloadResults:()=>{p.value&&window.open(`${t.baseUrl}/api/download/${p.value}`,"_blank")},formatFileSize:s=>{if(s===0)return"0 B";const l=1024,S=["B","KB","MB","GB"],b=Math.floor(Math.log(s)/Math.log(l));return parseFloat((s/Math.pow(l,b)).toFixed(2))+" "+S[b]},formatTime:s=>{if(!s||s<=0)return"0秒";const l=Math.floor(s/3600),S=Math.floor(s%3600/60),b=Math.floor(s%60);let U="";return l>0&&(U+=`${l}小时`),S>0&&(U+=`${S}分钟`),b>0&&(U+=`${b}秒`),U},getStatusColor:s=>({pending:"blue",processing:"orange",completed:"green",failed:"red"})[s]||"default",getStatusText:s=>({pending:"等待中",processing:"处理中",completed:"已完成",failed:"失败"})[s]||s,showCharacterMappings:q,goToCharacterMapper:h}}}),pe={class:"novel-processor"},me={key:1,class:"file-info"},fe={key:0,class:"empty-status"},ge={key:1,class:"task-status"},ce={class:"task-header"},_e={class:"task-title"},ve={class:"task-info"},ye={key:0,class:"task-actions"},ke={key:0,class:"empty-mappings"},be={key:1},Se={key:1},Ce={style:{"margin-top":"16px","text-align":"right"}};function Me(t,e,j,d,u,P){const E=r("page-header"),$=r("upload-outlined"),_=r("a-button"),w=r("a-upload"),p=r("a-form-item"),k=r("a-alert"),V=r("a-divider"),g=r("a-select-option"),F=r("a-select"),c=r("a-col"),A=r("a-radio"),q=r("a-radio-group"),h=r("a-row"),z=r("a-slider"),D=r("a-switch"),O=r("a-space"),B=r("a-form"),R=r("a-card"),G=r("read-outlined"),N=r("a-tag"),H=r("a-progress"),K=r("download-outlined"),X=r("a-list-item-meta"),s=r("a-list-item"),l=r("a-list"),S=r("a-empty"),b=r("a-table"),U=r("a-modal");return m(),y("div",pe,[a(E,{title:"小说处理",subtitle:"将小说文本转换为有声书"}),a(h,{gutter:16},{default:o(()=>[a(c,{span:16},{default:o(()=>[a(R,{title:"上传小说"},{default:o(()=>[a(B,{model:t.formState,layout:"vertical"},{default:o(()=>[t.fileInfo.name?M("",!0):(m(),T(p,{key:0,label:"选择小说文件"},{default:o(()=>[a(w,{name:"file",multiple:!1,showUploadList:!1,customRequest:t.uploadNovel,beforeUpload:t.beforeUpload,disabled:t.processing},{default:o(()=>[a(_,{disabled:t.processing},{default:o(()=>[a($),e[12]||(e[12]=n(" 点击上传小说文件 "))]),_:1,__:[12]},8,["disabled"])]),_:1},8,["customRequest","beforeUpload","disabled"])]),_:1})),t.fileInfo.name?(m(),y("div",me,[a(k,{message:`当前小说: ${t.fileInfo.name} (${t.formatFileSize(t.fileInfo.size)})`,type:"info","show-icon":"",class:"mb-16"},null,8,["message"]),a(_,{size:"small",type:"link",onClick:t.resetForm},{default:o(()=>e[13]||(e[13]=[n("选择其他小说")])),_:1,__:[13]},8,["onClick"])])):M("",!0),a(V,{orientation:"left"},{default:o(()=>e[14]||(e[14]=[n("语音设置")])),_:1,__:[14]}),a(h,{gutter:16},{default:o(()=>[a(c,{span:12},{default:o(()=>[a(p,{label:"音色选择"},{default:o(()=>[a(F,{value:t.formState.voiceId,"onUpdate:value":e[0]||(e[0]=i=>t.formState.voiceId=i),placeholder:"选择音色",disabled:t.processing,options:t.availableVoices,"show-search":"",optionFilterProp:"label"},{default:o(()=>[t.availableVoices.length===0?(m(),y(W,{key:0},[a(g,{value:"female_young"},{default:o(()=>e[15]||(e[15]=[n("年轻女声")])),_:1,__:[15]}),a(g,{value:"female_mature"},{default:o(()=>e[16]||(e[16]=[n("成熟女声")])),_:1,__:[16]}),a(g,{value:"male_young"},{default:o(()=>e[17]||(e[17]=[n("年轻男声")])),_:1,__:[17]}),a(g,{value:"male_middle"},{default:o(()=>e[18]||(e[18]=[n("中年男声")])),_:1,__:[18]}),a(g,{value:"male_elder"},{default:o(()=>e[19]||(e[19]=[n("老年男声")])),_:1,__:[19]})],64)):M("",!0)]),_:1},8,["value","disabled","options"])]),_:1})]),_:1}),a(c,{span:12},{default:o(()=>[a(p,{label:"语音技术"},{default:o(()=>[a(q,{value:t.formState.ttsEngine,"onUpdate:value":e[1]||(e[1]=i=>t.formState.ttsEngine=i),disabled:t.processing},{default:o(()=>[a(A,{value:"standard"},{default:o(()=>e[20]||(e[20]=[n("标准语音")])),_:1,__:[20]}),a(A,{value:"neural"},{default:o(()=>e[21]||(e[21]=[n("神经网络语音")])),_:1,__:[21]})]),_:1},8,["value","disabled"])]),_:1})]),_:1})]),_:1}),a(h,{gutter:16},{default:o(()=>[a(c,{span:8},{default:o(()=>[a(p,{label:"情感类型"},{default:o(()=>[a(F,{value:t.formState.emotionType,"onUpdate:value":e[2]||(e[2]=i=>t.formState.emotionType=i),placeholder:"选择情感类型",disabled:t.processing||!t.formState.enableEmotionDetection},{default:o(()=>[a(g,{value:"neutral"},{default:o(()=>e[22]||(e[22]=[n("中性")])),_:1,__:[22]}),a(g,{value:"happy"},{default:o(()=>e[23]||(e[23]=[n("开心")])),_:1,__:[23]}),a(g,{value:"sad"},{default:o(()=>e[24]||(e[24]=[n("悲伤")])),_:1,__:[24]}),a(g,{value:"angry"},{default:o(()=>e[25]||(e[25]=[n("愤怒")])),_:1,__:[25]}),a(g,{value:"surprised"},{default:o(()=>e[26]||(e[26]=[n("惊讶")])),_:1,__:[26]})]),_:1},8,["value","disabled"])]),_:1})]),_:1}),a(c,{span:8},{default:o(()=>[a(p,{label:"情感强度"},{default:o(()=>[a(z,{value:t.formState.emotionIntensity,"onUpdate:value":e[3]||(e[3]=i=>t.formState.emotionIntensity=i),min:0,max:1,step:.1,disabled:t.processing||!t.formState.enableEmotionDetection},null,8,["value","disabled"])]),_:1})]),_:1}),a(c,{span:8},{default:o(()=>[a(p,{label:"情感检测"},{default:o(()=>[a(D,{checked:t.formState.enableEmotionDetection,"onUpdate:checked":e[4]||(e[4]=i=>t.formState.enableEmotionDetection=i),disabled:t.processing},null,8,["checked","disabled"])]),_:1})]),_:1})]),_:1}),a(h,{gutter:16},{default:o(()=>[a(c,{span:12},{default:o(()=>[a(p,{label:"语速调节"},{default:o(()=>[a(z,{value:t.formState.speedScale,"onUpdate:value":e[5]||(e[5]=i=>t.formState.speedScale=i),min:.5,max:2,step:.1,disabled:t.processing},null,8,["value","disabled"])]),_:1})]),_:1}),a(c,{span:12},{default:o(()=>[a(p,{label:"音调调节"},{default:o(()=>[a(z,{value:t.formState.pitchScale,"onUpdate:value":e[6]||(e[6]=i=>t.formState.pitchScale=i),min:.5,max:2,step:.1,disabled:t.processing},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1}),a(V,{orientation:"left"},{default:o(()=>e[27]||(e[27]=[n("高级设置")])),_:1,__:[27]}),a(h,{gutter:16},{default:o(()=>[a(c,{span:8},{default:o(()=>[a(p,{label:"分章节处理"},{default:o(()=>[a(D,{checked:t.formState.splitByChapter,"onUpdate:checked":e[7]||(e[7]=i=>t.formState.splitByChapter=i),disabled:t.processing},null,8,["checked","disabled"])]),_:1})]),_:1}),a(c,{span:8},{default:o(()=>[a(p,{label:"自动合并音频"},{default:o(()=>[a(D,{checked:t.formState.mergeAudio,"onUpdate:checked":e[8]||(e[8]=i=>t.formState.mergeAudio=i),disabled:t.processing},null,8,["checked","disabled"])]),_:1})]),_:1}),a(c,{span:8},{default:o(()=>[a(p,{label:"使用角色声音映射"},{default:o(()=>[a(D,{checked:t.formState.useCharacterVoiceMapping,"onUpdate:checked":e[9]||(e[9]=i=>t.formState.useCharacterVoiceMapping=i),disabled:t.processing},null,8,["checked","disabled"]),t.formState.useCharacterVoiceMapping?(m(),T(_,{key:0,type:"link",size:"small",onClick:t.showCharacterMappings},{default:o(()=>e[28]||(e[28]=[n(" 查看映射 ")])),_:1,__:[28]},8,["onClick"])):M("",!0)]),_:1})]),_:1})]),_:1}),a(p,null,{default:o(()=>[a(O,null,{default:o(()=>[a(_,{type:"primary",onClick:t.processNovel,loading:t.processing,disabled:!t.fileInfo.name},{default:o(()=>e[29]||(e[29]=[n(" 处理小说 ")])),_:1,__:[29]},8,["onClick","loading","disabled"]),a(_,{onClick:t.resetForm,disabled:t.processing},{default:o(()=>e[30]||(e[30]=[n("重置")])),_:1,__:[30]},8,["onClick","disabled"])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(c,{span:8},{default:o(()=>[a(R,{title:"处理进度"},{default:o(()=>[t.taskId?(m(),y("div",ge,[f("div",ce,[f("div",_e,"任务ID: "+C(t.taskId),1),a(N,{color:t.getStatusColor(t.taskStatus)},{default:o(()=>[n(C(t.getStatusText(t.taskStatus)),1)]),_:1},8,["color"])]),a(H,{percent:t.taskProgress,status:t.taskStatus==="failed"?"exception":t.taskStatus==="completed"?"success":"active"},null,8,["percent","status"]),f("div",ve,[f("p",null,[e[32]||(e[32]=f("strong",null,"小说名称:",-1)),n(" "+C(t.fileInfo.name),1)]),f("p",null,[e[33]||(e[33]=f("strong",null,"总章节数:",-1)),n(" "+C(t.taskDetails.total_chapters||0),1)]),f("p",null,[e[34]||(e[34]=f("strong",null,"已处理章节:",-1)),n(" "+C(t.taskDetails.processed_chapters||0),1)]),f("p",null,[e[35]||(e[35]=f("strong",null,"预计剩余时间:",-1)),n(" "+C(t.formatTime(t.taskDetails.estimated_time_remaining)),1)])]),t.taskStatus==="completed"?(m(),y("div",ye,[a(_,{type:"primary",onClick:t.downloadResults},{default:o(()=>[a(K),e[36]||(e[36]=n(" 下载所有文件 "))]),_:1,__:[36]},8,["onClick"])])):M("",!0)])):(m(),y("div",fe,[a(G,{style:{fontSize:"64px",color:"#d9d9d9"}}),e[31]||(e[31]=f("p",null,"提交任务后将在此处显示进度",-1))]))]),_:1}),t.formState.useCharacterVoiceMapping?(m(),T(R,{key:0,title:"角色声音映射",class:"mt-16"},{default:o(()=>[t.characterVoiceMappings.length===0?(m(),y("div",ke,[e[38]||(e[38]=f("p",null,"暂无角色声音映射",-1)),a(_,{type:"link",onClick:t.goToCharacterMapper},{default:o(()=>e[37]||(e[37]=[n("前往设置角色声音映射")])),_:1,__:[37]},8,["onClick"])])):(m(),y("div",be,[a(l,{size:"small"},{default:o(()=>[(m(!0),y(W,null,Y(t.characterVoiceMappings,i=>(m(),T(s,{key:i.name},{default:o(()=>[a(X,{title:i.name},{description:o(()=>[a(N,{color:"blue"},{default:o(()=>[n(C(i.voice_name),1)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024))),128))]),_:1}),a(_,{type:"link",onClick:t.goToCharacterMapper,class:"mt-16"},{default:o(()=>e[39]||(e[39]=[n(" 管理角色声音映射 ")])),_:1,__:[39]},8,["onClick"])]))]),_:1})):M("",!0)]),_:1})]),_:1}),a(U,{visible:t.mappingModalVisible,"onUpdate:visible":e[11]||(e[11]=i=>t.mappingModalVisible=i),title:"角色声音映射",footer:null,width:"600px"},{default:o(()=>[t.characterVoiceMappings.length===0?(m(),T(S,{key:0,description:"暂无角色声音映射"},{description:o(()=>e[40]||(e[40]=[f("div",null,[f("p",null,"没有找到角色声音映射"),f("p",null,'请先在"角色声音映射"页面配置角色与声音的对应关系')],-1)])),default:o(()=>[a(_,{type:"primary",onClick:t.goToCharacterMapper},{default:o(()=>e[41]||(e[41]=[n(" 前往配置 ")])),_:1,__:[41]},8,["onClick"])]),_:1})):(m(),y("div",Se,[a(b,{columns:t.mappingColumns,dataSource:t.characterVoiceMappings,pagination:!1,size:"small"},{bodyCell:o(({column:i,record:J})=>[i.key==="voice"?(m(),T(N,{key:0,color:"blue"},{default:o(()=>[n(C(J.voice_name),1)]),_:2},1024)):M("",!0),i.key==="attributes"?(m(!0),y(W,{key:1},Y(J.attributes,Q=>(m(),T(N,{key:Q},{default:o(()=>[n(C(Q),1)]),_:2},1024))),128)):M("",!0)]),_:1},8,["columns","dataSource"]),f("div",Ce,[a(_,{type:"primary",onClick:t.goToCharacterMapper},{default:o(()=>e[42]||(e[42]=[n(" 管理映射 ")])),_:1,__:[42]},8,["onClick"]),a(_,{onClick:e[10]||(e[10]=i=>t.mappingModalVisible=!1),style:{"margin-left":"8px"}},{default:o(()=>e[43]||(e[43]=[n(" 关闭 ")])),_:1,__:[43]})])]))]),_:1},8,["visible"])])}const De=x(ue,[["render",Me],["__scopeId","data-v-9a4268dc"]]);export{De as default};
