import{a as C}from"./axios-3a665b0f.js";import{c as i,A as se,_ as re,d as le,P as ie,J as ce,H as de,r as _,a as ue,B as me,o as pe,e as f,f as S,w as r,m as l,M as ve,g as c,p as M,i as y,k as A,t as L,v as Y,x as ae,j as I}from"./index-827e089e.js";import{U as fe}from"./UploadOutlined-3141d868.js";var ge={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M136 384h56c4.4 0 8-3.6 8-8V200h176c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H196c-37.6 0-68 30.4-68 68v180c0 4.4 3.6 8 8 8zm512-184h176v176c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V196c0-37.6-30.4-68-68-68H648c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zM376 824H200V648c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v180c0 37.6 30.4 68 68 68h180c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm512-184h-56c-4.4 0-8 3.6-8 8v176H648c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h180c37.6 0 68-30.4 68-68V648c0-4.4-3.6-8-8-8zm16-164H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"}}]},name:"scan",theme:"outlined"};const _e=ge;function te(a){for(var n=1;n<arguments.length;n++){var p=arguments[n]!=null?Object(arguments[n]):{},v=Object.keys(p);typeof Object.getOwnPropertySymbols=="function"&&(v=v.concat(Object.getOwnPropertySymbols(p).filter(function(k){return Object.getOwnPropertyDescriptor(p,k).enumerable}))),v.forEach(function(k){ye(a,k,p[k])})}return a}function ye(a,n,p){return n in a?Object.defineProperty(a,n,{value:p,enumerable:!0,configurable:!0,writable:!0}):a[n]=p,a}var Z=function(n,p){var v=te({},n,p.attrs);return i(se,te({},v,{icon:_e}),null)};Z.displayName="ScanOutlined";Z.inheritAttrs=!1;const he=Z;const be=le({name:"CharacterMapperView",components:{PlusOutlined:ie,EditOutlined:ce,DeleteOutlined:de,UploadOutlined:fe,ScanOutlined:he},setup(){const a=_(!1),n=_(!1),p=_([]),v=_([]),k=[{title:"角色名称",dataIndex:"name",key:"name",sorter:(t,s)=>t.name.localeCompare(s.name)},{title:"声音",dataIndex:"voice_name",key:"voice",sorter:(t,s)=>(t.voice_name||"").localeCompare(s.voice_name||"")},{title:"属性",dataIndex:"attributes",key:"attributes"},{title:"操作",key:"action",width:150}],d=ue({name:"",voice_id:void 0,attributes:[]}),h=_(!1),w=_(!1),g=_("create"),V=_(""),O=_(""),T=_(!1),z=_([]),H=me(()=>v.value.map(t=>{var s,e;return{value:t.id,label:t.name,gender:(s=t.attributes)==null?void 0:s.gender,age:(e=t.attributes)==null?void 0:e.age_group}})),F=[{value:"protagonist",label:"主角"},{value:"antagonist",label:"反派"},{value:"supporting",label:"配角"},{value:"male",label:"男性"},{value:"female",label:"女性"},{value:"child",label:"儿童"},{value:"young",label:"青年"},{value:"middle",label:"中年"},{value:"old",label:"老年"}],$=async()=>{var t,s;a.value=!0;try{const e=await C.get("/api/characters");e.data&&e.data.success?p.value=e.data.characters||[]:l.error("获取角色列表失败: "+(e.data.message||"未知错误"))}catch(e){l.error("获取角色列表失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}finally{a.value=!1}},P=async()=>{var t,s;n.value=!0;try{const e=await C.get("/api/voices/list");e.data&&e.data.success?v.value=e.data.voices||[]:l.error("获取声音列表失败: "+(e.data.message||"未知错误"))}catch(e){l.error("获取声音列表失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}finally{n.value=!1}},j=()=>{d.name="",d.voice_id=void 0,d.attributes=[],g.value="create",h.value=!0},B=async()=>{var t,s;if(!d.name.trim()){l.warning("请输入角色名称");return}w.value=!0;try{const e=await C.post("/api/characters/map",{name:d.name,voice_id:d.voice_id,attributes:d.attributes});e.data&&e.data.success?(l.success("角色创建成功"),h.value=!1,$()):l.error("创建角色失败: "+(e.data.message||"未知错误"))}catch(e){l.error("创建角色失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}finally{w.value=!1}},D=t=>{l.info(`已选择角色: ${t.name}`)},E=t=>{d.name=t.name,d.voice_id=t.voice_id,d.attributes=t.attributes||[],V.value=t.name,g.value="edit",h.value=!0},R=async()=>{var t,s;if(!d.name.trim()){l.warning("请输入角色名称");return}w.value=!0;try{const e=await C.put(`/api/characters/${encodeURIComponent(V.value)}`,{name:d.name,voice_id:d.voice_id,attributes:d.attributes});e.data&&e.data.success?(l.success("角色更新成功"),h.value=!1,$()):l.error("更新角色失败: "+(e.data.message||"未知错误"))}catch(e){l.error("更新角色失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}finally{w.value=!1}},X=t=>{ve.confirm({title:"确认删除",content:`确定要删除角色"${t.name}"吗？此操作不可恢复。`,okText:"删除",okType:"danger",cancelText:"取消",async onOk(){var s,e;try{const o=await C.delete(`/api/characters/${encodeURIComponent(t.name)}`);o.data&&o.data.success?(l.success("角色已删除"),p.value=p.value.filter(u=>u.name!==t.name)):l.error("删除角色失败: "+(o.data.message||"未知错误"))}catch(o){l.error("删除角色失败: "+(((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||o.message||"未知错误"))}}})},q=t=>{if(!(t.type==="text/plain"||/\.txt$/i.test(t.name)))return l.error("只能上传TXT文本文件！"),!1;const e=new FileReader;return e.onload=o=>{O.value=o.target.result},e.readAsText(t),!1},J=async()=>{var t,s;if(!O.value.trim()){l.warning("请输入小说文本");return}T.value=!0,z.value=[];try{const e=await C.post("/api/characters/analyze",{text:O.value});if(e.data&&e.data.success){const o=e.data.characters||{},u=Object.entries(o).map(([m,b])=>({name:m,count:b})).sort((m,b)=>b.count-m.count);z.value=u,u.length===0?l.info("未识别出任何角色"):l.success(`成功识别出 ${u.length} 个角色`)}else l.error("分析角色失败: "+(e.data.message||"未知错误"))}catch(e){l.error("分析角色失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}finally{T.value=!1}},G=t=>{d.name=t.name,d.voice_id=void 0,d.attributes=[],g.value="create",h.value=!0},Q=async()=>{var t,s;if(z.value.length===0){l.warning("没有可映射的角色");return}if(v.value.length===0){l.warning("没有可用的声音，请先添加声音");return}try{l.loading("正在为角色分配声音...",0);const e=await C.post("/api/characters/analyze",{text:O.value,suggest_voices:!0});if(e.data&&e.data.success){const o=e.data.suggestions||{};let u=0;for(const m of z.value){let b=null;if(o[m.name]&&o[m.name].length>0)b=o[m.name][0];else{const N=m.name.toLowerCase(),ne=/先生|男|爸|哥|弟|叔|爷/.test(N),oe=/女士|女|妈|姐|妹|婶|奶/.test(N),W=v.value.filter(K=>{var x,ee;return!!(ne&&((x=K.attributes)==null?void 0:x.gender)==="male"||oe&&((ee=K.attributes)==null?void 0:ee.gender)==="female")});W.length>0?b=W[Math.floor(Math.random()*W.length)].id:b=v.value[Math.floor(Math.random()*v.value.length)].id}try{await C.post("/api/characters/map",{name:m.name,voice_id:b}),u++}catch(N){console.error(`映射角色 ${m.name} 失败:`,N)}}l.destroy(),u>0?(l.success(`成功映射 ${u} 个角色`),$()):l.warning("没有成功映射任何角色")}else l.destroy(),l.error("获取声音推荐失败: "+(e.data.message||"未知错误"))}catch(e){l.destroy(),l.error("角色映射失败: "+(((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"未知错误"))}},U=(t,s)=>((s==null?void 0:s.label)??"").toLowerCase().includes(t.toLowerCase());return pe(()=>{$(),P()}),{loading:a,voicesLoading:n,characterList:p,characterColumns:k,characterForm:d,modalVisible:h,modalLoading:w,modalMode:g,novelText:O,analyzing:T,analyzedCharacters:z,voiceOptions:H,attributeOptions:F,showCreateModal:j,createCharacter:B,selectCharacter:D,editCharacter:E,updateCharacter:R,confirmDeleteCharacter:X,beforeNovelUpload:q,analyzeNovel:J,mapAnalyzedCharacter:G,mapAllCharacters:Q,filterVoiceOption:U}}}),Ce={class:"character-mapper-container"},ke=["onClick"],we={class:"analyzer-buttons"},Oe={key:0,class:"analyzer-results"},ze=["onClick"];function $e(a,n,p,v,k,d){const h=c("a-page-header"),w=c("plus-outlined"),g=c("a-button"),V=c("a-tag"),O=c("edit-outlined"),T=c("delete-outlined"),z=c("a-space"),H=c("a-table"),F=c("a-card"),$=c("a-col"),P=c("a-textarea"),j=c("upload-outlined"),B=c("a-upload"),D=c("scan-outlined"),E=c("a-divider"),R=c("a-list-item-meta"),X=c("a-list-item"),q=c("a-list"),J=c("a-spin"),G=c("a-row"),Q=c("a-input"),U=c("a-form-item"),t=c("a-select"),s=c("a-form"),e=c("a-modal");return f(),S("div",Ce,[i(h,{title:"角色声音映射","sub-title":"为小说角色分配合适的声音"}),i(G,{gutter:24},{default:r(()=>[i($,{span:16},{default:r(()=>[i(F,{title:"角色管理",class:"character-card"},{default:r(()=>[i(H,{dataSource:a.characterList,columns:a.characterColumns,loading:a.loading,rowKey:"name",pagination:{pageSize:10}},{headerCell:r(({column:o})=>[o.key==="action"?(f(),M(g,{key:0,type:"primary",size:"small",onClick:a.showCreateModal},{icon:r(()=>[i(w)]),default:r(()=>[n[6]||(n[6]=y(" 添加角色 "))]),_:1,__:[6]},8,["onClick"])):A("",!0)]),bodyCell:r(({column:o,record:u})=>[o.key==="name"?(f(),S("a",{key:0,onClick:m=>a.selectCharacter(u)},L(u.name),9,ke)):o.key==="voice"?(f(),S(Y,{key:1},[u.voice_name?(f(),M(V,{key:0,color:"blue"},{default:r(()=>[y(L(u.voice_name),1)]),_:2},1024)):(f(),M(V,{key:1,color:"red"},{default:r(()=>n[7]||(n[7]=[y("未设置")])),_:1,__:[7]}))],64)):o.key==="attributes"?(f(!0),S(Y,{key:2},ae(u.attributes||[],m=>(f(),M(V,{key:m},{default:r(()=>[y(L(m),1)]),_:2},1024))),128)):o.key==="action"?(f(),M(z,{key:3},{default:r(()=>[i(g,{type:"link",size:"small",onClick:m=>a.editCharacter(u)},{icon:r(()=>[i(O)]),default:r(()=>[n[8]||(n[8]=y(" 编辑 "))]),_:2,__:[8]},1032,["onClick"]),i(g,{type:"link",size:"small",danger:"",onClick:m=>a.confirmDeleteCharacter(u)},{icon:r(()=>[i(T)]),default:r(()=>[n[9]||(n[9]=y(" 删除 "))]),_:2,__:[9]},1032,["onClick"])]),_:2},1024)):A("",!0)]),_:1},8,["dataSource","columns","loading"])]),_:1})]),_:1}),i($,{span:8},{default:r(()=>[i(F,{title:"小说角色分析",class:"analyzer-card"},{default:r(()=>[n[14]||(n[14]=I("p",null,"上传或粘贴小说文本，自动识别其中的角色，并为角色推荐合适的声音。",-1)),i(P,{value:a.novelText,"onUpdate:value":n[0]||(n[0]=o=>a.novelText=o),placeholder:"在此处粘贴小说文本（段落或章节）",rows:6,"allow-clear":""},null,8,["value"]),I("div",we,[i(B,{beforeUpload:a.beforeNovelUpload,showUploadList:!1,accept:".txt"},{default:r(()=>[i(g,{style:{"margin-right":"8px"}},{icon:r(()=>[i(j)]),default:r(()=>[n[10]||(n[10]=y(" 上传TXT "))]),_:1,__:[10]})]),_:1},8,["beforeUpload"]),i(g,{type:"primary",disabled:!a.novelText.trim(),loading:a.analyzing,onClick:a.analyzeNovel},{icon:r(()=>[i(D)]),default:r(()=>[n[11]||(n[11]=y(" 分析角色 "))]),_:1,__:[11]},8,["disabled","loading","onClick"])]),a.analyzedCharacters.length>0?(f(),M(E,{key:0},{default:r(()=>n[12]||(n[12]=[y("分析结果")])),_:1,__:[12]})):A("",!0),i(J,{spinning:a.analyzing},{default:r(()=>[a.analyzedCharacters.length>0?(f(),S("div",Oe,[I("p",null,"共识别出 "+L(a.analyzedCharacters.length)+" 个角色：",1),i(q,{size:"small",bordered:""},{default:r(()=>[(f(!0),S(Y,null,ae(a.analyzedCharacters,o=>(f(),M(X,{key:o.name},{actions:r(()=>[I("a",{key:"map",onClick:u=>a.mapAnalyzedCharacter(o)},"分配声音",8,ze)]),default:r(()=>[i(R,{title:o.name},{description:r(()=>[y(" 出现次数: "+L(o.count),1)]),_:2},1032,["title"])]),_:2},1024))),128))]),_:1}),i(g,{type:"primary",style:{"margin-top":"16px"},onClick:a.mapAllCharacters},{default:r(()=>n[13]||(n[13]=[y(" 一键映射全部角色 ")])),_:1,__:[13]},8,["onClick"])])):A("",!0)]),_:1},8,["spinning"])]),_:1,__:[14]})]),_:1})]),_:1}),i(e,{visible:a.modalVisible,"onUpdate:visible":n[4]||(n[4]=o=>a.modalVisible=o),title:a.modalMode==="create"?"添加角色":"编辑角色",onOk:n[5]||(n[5]=o=>a.modalMode==="create"?a.createCharacter():a.updateCharacter()),"confirm-loading":a.modalLoading,width:"600px"},{default:r(()=>[i(s,{model:a.characterForm,layout:"vertical"},{default:r(()=>[i(U,{label:"角色名称",name:"name",rules:[{required:!0,message:"请输入角色名称"}]},{default:r(()=>[i(Q,{value:a.characterForm.name,"onUpdate:value":n[1]||(n[1]=o=>a.characterForm.name=o),placeholder:"输入角色名称"},null,8,["value"])]),_:1}),i(U,{label:"选择声音",name:"voice_id"},{default:r(()=>[i(t,{value:a.characterForm.voice_id,"onUpdate:value":n[2]||(n[2]=o=>a.characterForm.voice_id=o),placeholder:"选择声音",style:{width:"100%"},options:a.voiceOptions,loading:a.voicesLoading,"allow-clear":"","show-search":"","filter-option":a.filterVoiceOption},null,8,["value","options","loading","filter-option"])]),_:1}),i(U,{label:"角色属性",name:"attributes"},{default:r(()=>[i(t,{value:a.characterForm.attributes,"onUpdate:value":n[3]||(n[3]=o=>a.characterForm.attributes=o),mode:"tags",placeholder:"输入角色属性",style:{width:"100%"},options:a.attributeOptions,"allow-clear":""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading"])])}const Te=re(be,[["render",$e],["__scopeId","data-v-8050122c"]]);export{Te as default};
