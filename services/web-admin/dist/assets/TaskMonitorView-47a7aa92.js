import{_ as q,d as E,z as F,D as G,u as H,q as J,r as I,B as j,o as Q,C as W,e as i,f as v,c as a,w as s,g as u,i as d,j as f,p as k,t as p,k as y}from"./index-827e089e.js";import{u as X}from"./api-d479bee2.js";import"./axios-3a665b0f.js";const Y=E({name:"TaskMonitorView",components:{ReloadOutlined:F,DownloadOutlined:G},setup(){H(),J();const e=X(),o=I(!1),P=I(!1),L=I("all"),_=I(null),S=I([]),T=I(!1);let c=null;const h=[{title:"任务ID",dataIndex:"taskId",key:"taskId",width:"25%",ellipsis:!0},{title:"类型",dataIndex:"type",key:"type",width:"10%"},{title:"状态",dataIndex:"status",key:"status",width:"15%"},{title:"进度",dataIndex:"progress",key:"progress",width:"25%"},{title:"操作",key:"action",width:"15%"}],$=j(()=>S.value.filter(t=>t.status==="pending"||t.status==="processing")),z=j(()=>S.value.filter(t=>t.status==="completed")),w=t=>({pending:"blue",processing:"processing",completed:"success",failed:"error"})[t]||"default",b=t=>({pending:"等待中",processing:"处理中",completed:"已完成",failed:"失败"})[t]||"未知",A=t=>t==="failed"?"exception":t==="completed"?"success":"active",D=t=>t?new Date(t*1e3).toLocaleString():"-",M=t=>{if(!t)return"0秒";const r=Math.floor(t/3600),V=Math.floor(t%3600/60),O=Math.floor(t%60);let K="";return r>0&&(K+=`${r}小时`),V>0&&(K+=`${V}分钟`),(O>0||K==="")&&(K+=`${O}秒`),K},C=async()=>{o.value=!0;try{const t=await e.getAllTasks();t&&Array.isArray(t.tasks)&&(S.value=t.tasks.map(r=>({taskId:r.task_id,type:r.type==="novel"?"小说处理":"语音合成",status:r.status,progress:r.progress||0,created_at:r.created_at,updated_at:r.updated_at})))}catch(t){console.error("加载任务列表失败",t)}finally{o.value=!1}},B=async t=>{P.value=!0;try{const r=await e.getTaskDetails(t);r&&(_.value=r,r.status==="processing"?R():m())}catch(r){console.error("加载任务详情失败",r)}finally{P.value=!1}},g=async()=>{if(_.value)try{const t=await e.getTaskDetails(_.value.taskId);t&&(_.value=t,t.status!=="processing"&&t.status!=="pending"&&(m(),C()))}catch(t){console.error("刷新任务详情失败",t)}},U=()=>{C(),_.value&&g()},N=t=>{const r=`${e.baseUrl}/api/download/${t}.zip`;window.open(r,"_blank")},R=()=>{T.value=!0,m(),c=setInterval(()=>{g()},5e3)},m=()=>{c&&(clearInterval(c),c=null),T.value=!1},n=()=>{T.value?m():R()},l=(t,r,V)=>{console.log("Table params:",t,r,V)};return Q(()=>{C();const t=setInterval(C,3e4);W(()=>{clearInterval(t),m()})}),{apiStore:e,loading:o,detailLoading:P,activeTab:L,tasks:S,processingTasks:$,completedTasks:z,currentTask:_,columns:h,pollingActive:T,getStatusColor:w,getStatusText:b,getProgressStatus:A,formatTime:D,formatDuration:M,viewTaskDetail:B,refreshTasks:U,downloadResult:N,togglePolling:n,handleTableChange:l}}}),Z={class:"task-monitor"},x={key:0},ee={key:1},te={key:0,class:"mt-16"},se={class:"task-message"},ae={key:1,class:"mt-16"},oe={key:0,class:"audio-preview mt-16"},ne=["src"],le={class:"preview-info"},re={key:2,class:"mt-16"};function ie(e,o,P,L,_,S){const T=u("reload-outlined"),c=u("a-button"),h=u("a-card"),$=u("a-col"),z=u("a-row"),w=u("a-tag"),b=u("a-progress"),A=u("a-space"),D=u("a-table"),M=u("a-tab-pane"),C=u("a-tabs"),B=u("a-empty"),g=u("a-descriptions-item"),U=u("a-descriptions"),N=u("download-outlined"),R=u("a-divider"),m=u("a-alert");return i(),v("div",Z,[a(z,{gutter:16,class:"mb-16"},{default:s(()=>[a($,{span:24},{default:s(()=>[a(h,{title:"任务监控",bordered:!1},{extra:s(()=>[a(c,{type:"primary",onClick:e.refreshTasks},{icon:s(()=>[a(T)]),default:s(()=>[o[2]||(o[2]=d(" 刷新 "))]),_:1,__:[2]},8,["onClick"])]),default:s(()=>[o[3]||(o[3]=f("p",null,"查看所有任务的进度与状态，支持实时监控",-1))]),_:1,__:[3]})]),_:1})]),_:1}),a(z,{gutter:16},{default:s(()=>[a($,{span:16},{default:s(()=>[a(h,{loading:e.loading},{default:s(()=>[a(C,{activeKey:e.activeTab,"onUpdate:activeKey":o[0]||(o[0]=n=>e.activeTab=n)},{default:s(()=>[a(M,{key:"all",tab:"所有任务"},{default:s(()=>[a(D,{columns:e.columns,"data-source":e.tasks,pagination:{pageSize:5},rowKey:n=>n.taskId,onChange:e.handleTableChange},{bodyCell:s(({column:n,record:l})=>[n.key==="status"?(i(),k(w,{key:0,color:e.getStatusColor(l.status)},{default:s(()=>[d(p(e.getStatusText(l.status)),1)]),_:2},1032,["color"])):n.key==="progress"?(i(),k(b,{key:1,percent:Math.floor(l.progress*100),size:"small",status:e.getProgressStatus(l.status)},null,8,["percent","status"])):n.key==="action"?(i(),k(A,{key:2},{default:s(()=>[a(c,{type:"link",onClick:t=>e.viewTaskDetail(l.taskId)},{default:s(()=>o[4]||(o[4]=[d(" 查看 ")])),_:2,__:[4]},1032,["onClick"]),l.status==="completed"?(i(),k(c,{key:0,type:"link",onClick:t=>e.downloadResult(l.taskId)},{default:s(()=>o[5]||(o[5]=[d(" 下载 ")])),_:2,__:[5]},1032,["onClick"])):y("",!0)]),_:2},1024)):y("",!0)]),_:1},8,["columns","data-source","rowKey","onChange"])]),_:1}),a(M,{key:"processing",tab:"处理中"},{default:s(()=>[a(D,{columns:e.columns,"data-source":e.processingTasks,pagination:{pageSize:5},rowKey:n=>n.taskId},{bodyCell:s(({column:n,record:l})=>[n.key==="status"?(i(),k(w,{key:0,color:e.getStatusColor(l.status)},{default:s(()=>[d(p(e.getStatusText(l.status)),1)]),_:2},1032,["color"])):n.key==="progress"?(i(),k(b,{key:1,percent:Math.floor(l.progress*100),size:"small",status:e.getProgressStatus(l.status)},null,8,["percent","status"])):n.key==="action"?(i(),k(c,{key:2,type:"link",onClick:t=>e.viewTaskDetail(l.taskId)},{default:s(()=>o[6]||(o[6]=[d(" 查看 ")])),_:2,__:[6]},1032,["onClick"])):y("",!0)]),_:1},8,["columns","data-source","rowKey"])]),_:1}),a(M,{key:"completed",tab:"已完成"},{default:s(()=>[a(D,{columns:e.columns,"data-source":e.completedTasks,pagination:{pageSize:5},rowKey:n=>n.taskId},{bodyCell:s(({column:n,record:l})=>[n.key==="status"?(i(),k(w,{key:0,color:e.getStatusColor(l.status)},{default:s(()=>[d(p(e.getStatusText(l.status)),1)]),_:2},1032,["color"])):n.key==="progress"?(i(),k(b,{key:1,percent:Math.floor(l.progress*100),size:"small",status:e.getProgressStatus(l.status)},null,8,["percent","status"])):n.key==="action"?(i(),k(A,{key:2},{default:s(()=>[a(c,{type:"link",onClick:t=>e.viewTaskDetail(l.taskId)},{default:s(()=>o[7]||(o[7]=[d(" 查看 ")])),_:2,__:[7]},1032,["onClick"]),a(c,{type:"link",onClick:t=>e.downloadResult(l.taskId)},{default:s(()=>o[8]||(o[8]=[d(" 下载 ")])),_:2,__:[8]},1032,["onClick"])]),_:2},1024)):y("",!0)]),_:1},8,["columns","data-source","rowKey"])]),_:1})]),_:1},8,["activeKey"])]),_:1},8,["loading"])]),_:1}),a($,{span:8},{default:s(()=>[a(h,{title:"任务详情",loading:e.detailLoading},{default:s(()=>[e.currentTask?(i(),v("div",ee,[a(U,{bordered:"",column:1},{default:s(()=>[a(g,{label:"任务ID"},{default:s(()=>[d(p(e.currentTask.taskId),1)]),_:1}),a(g,{label:"状态"},{default:s(()=>[a(w,{color:e.getStatusColor(e.currentTask.status)},{default:s(()=>[d(p(e.getStatusText(e.currentTask.status)),1)]),_:1},8,["color"])]),_:1}),a(g,{label:"进度"},{default:s(()=>[a(b,{percent:Math.floor(e.currentTask.progress*100),status:e.getProgressStatus(e.currentTask.status)},null,8,["percent","status"])]),_:1}),a(g,{label:"创建时间"},{default:s(()=>[d(p(e.formatTime(e.currentTask.created_at)),1)]),_:1}),a(g,{label:"小说路径"},{default:s(()=>[d(p(e.currentTask.novel_path),1)]),_:1}),a(g,{label:"输出目录"},{default:s(()=>[d(p(e.currentTask.output_dir),1)]),_:1})]),_:1}),e.currentTask.status==="processing"?(i(),v("div",te,[f("div",null,[o[9]||(o[9]=f("span",{class:"progress-label"},"章节进度:",-1)),d(" "+p(e.currentTask.current_chapter||0)+"/"+p(e.currentTask.total_chapters||0),1)]),f("div",se,p(e.currentTask.message),1),a(c,{block:"",type:"primary",loading:e.pollingActive,onClick:e.togglePolling},{default:s(()=>[d(p(e.pollingActive?"停止自动刷新":"开始自动刷新"),1)]),_:1},8,["loading","onClick"])])):y("",!0),e.currentTask.status==="completed"?(i(),v("div",ae,[a(c,{block:"",type:"primary",onClick:o[1]||(o[1]=n=>e.downloadResult(e.currentTask.taskId))},{icon:s(()=>[a(N)]),default:s(()=>[o[10]||(o[10]=d(" 下载结果 "))]),_:1,__:[10]}),e.currentTask.result&&e.currentTask.result.preview_file?(i(),v("div",oe,[o[11]||(o[11]=f("div",{class:"preview-title"},"音频预览:",-1)),a(R,{style:{margin:"8px 0"}}),f("audio",{controls:"",style:{width:"100%"},src:`${e.apiStore.baseUrl}/api/download/${e.currentTask.result.preview_file}`},null,8,ne),f("div",le,[f("p",null,"总生成章节: "+p(e.currentTask.result.completed_chapters||0),1),f("p",null,"总时长: "+p(e.formatDuration(e.currentTask.result.total_duration||0)),1)])])):y("",!0)])):y("",!0),e.currentTask.status==="failed"?(i(),v("div",re,[a(m,{type:"error","show-icon":"",message:e.currentTask.error},null,8,["message"])])):y("",!0)])):(i(),v("div",x,[a(B,{description:"请选择任务查看详情"})]))]),_:1},8,["loading"])]),_:1})]),_:1})])}const ce=q(Y,[["render",ie],["__scopeId","data-v-47e8ddb2"]]);export{ce as default};
