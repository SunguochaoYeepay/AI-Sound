<template>
  <div class="music-library">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">
            <SoundOutlined style="margin-right: 12px" />
            ËÉåÊôØÈü≥‰πê
          </h1>
          <p class="page-description">ÁÆ°ÁêÜÈ°πÁõÆ‰∏≠‰ΩøÁî®ÁöÑËÉåÊôØÈü≥‰πêÔºåÊîØÊåÅ‰∏ä‰º†„ÄÅÂàÜÁ±ª„ÄÅÈ¢ÑËßàÂíåÊô∫ËÉΩÊé®Ëçê</p>
        </div>
        
        <div class="action-section">
          <!-- ÁÆÄÂåñ‰∏∫Âçï‰∏ÄÁõ¥Êé•ÁîüÊàêÊåâÈíÆ -->
          <a-button type="primary" @click="showDirectGenerationModal = true">
              <SoundOutlined />
            ÂêàÊàêÈü≥‰πê
            </a-button>
          <a-button @click="showUploadModal = true">
            <PlusOutlined />
            ‰∏ä‰º†Èü≥‰πê
          </a-button>
          <a-button @click="refreshData" :loading="refreshing">
            <ReloadOutlined />
            Âà∑Êñ∞
          </a-button>
        </div>
      </div>
    </div>

    <!-- ÁªüËÆ°Âç°Áâá -->
    <a-row :gutter="16" class="stats-cards">
      <a-col :span="6">
        <a-card size="small">
          <a-statistic
            title="ÊÄªÈü≥‰πêÊï∞"
            :value="stats.total_music"
            :value-style="{ color: '#1890ff' }"
          >
            <template #prefix>
              <SoundOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>
      <a-col :span="6">
        <a-card size="small">
          <a-statistic
            title="Èü≥‰πêÂàÜÁ±ª"
            :value="stats.total_categories"
            :value-style="{ color: '#52c41a' }"
          >
            <template #prefix>
              <AppstoreOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>
      <a-col :span="6">
        <a-card size="small">
          <a-statistic
            title="ÊÄªÊó∂Èïø"
            :value="formatDuration(stats.total_duration)"
            :value-style="{ color: '#faad14' }"
          >
            <template #prefix>
              <ClockCircleOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>
      <a-col :span="6">
        <a-card size="small">
          <a-statistic
            title="ÊÄªÂ§ßÂ∞è"
            :value="formatFileSize(stats.total_size)"
            :value-style="{ color: '#722ed1' }"
          >
            <template #prefix>
              <DatabaseOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>
    </a-row>

    <!-- Èü≥‰πêÂàóË°® -->
    <a-card title="Èü≥‰πêÂàóË°®" class="music-table">
      <a-table
        :dataSource="musicList"
        :columns="tableColumns"
        :pagination="pagination"
        :loading="loading"
        row-key="id"
        @change="handleTableChange"
      >
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'name'">
            <div class="music-info">
              <div class="music-name">{{ record.name }}</div>
              <div class="music-description" v-if="record.description">{{ record.description }}</div>
            </div>
          </template>
          
          <template v-else-if="column.key === 'category'">
            <a-tag color="blue">{{ record.category?.name || record.category_name || 'Êú™ÂàÜÁ±ª' }}</a-tag>
          </template>
          
          <template v-else-if="column.key === 'duration'">
            {{ formatDuration(record.duration) }}
          </template>
          
          <template v-else-if="column.key === 'file_size'">
            {{ formatFileSize(record.file_size) }}
          </template>
          
          <template v-else-if="column.key === 'actions'">
            <a-space>
              <!-- Êí≠ÊîæÊåâÈíÆ - Ê†πÊçÆÈü≥‰πêÁ±ªÂûãÂíåÁä∂ÊÄÅÊòæÁ§∫ -->
              <a-tooltip :title="getPlayButtonTooltip(record)">
                <a-button 
                  size="small" 
                  type="text" 
                  @click="playMusic(record)"
                  :disabled="!canPlayMusic(record)"
                  :loading="audioStore.loading && audioStore.currentAudio?.id === getMusicId(record)"
                  :type="audioStore.isCurrentlyPlaying(getMusicId(record)) ? 'primary' : 'default'"
                >
                  <PlayCircleOutlined v-if="!audioStore.isCurrentlyPlaying(getMusicId(record))" />
                  <PauseCircleOutlined v-else />
                </a-button>
              </a-tooltip>
              
              <!-- ‰∏ãËΩΩÊåâÈíÆ - Âè™ÊúâÂ∑≤ÂÆåÊàêÁöÑÈü≥‰πêÊâçËÉΩ‰∏ãËΩΩ -->
              <a-tooltip :title="getDownloadButtonTooltip(record)">
                <a-button 
                  size="small" 
                  type="text" 
                  @click="downloadMusic(record)"
                  :disabled="!canDownloadMusic(record)"
                >
                  <DownloadOutlined />
                </a-button>
              </a-tooltip>
              
              <!-- Âà†Èô§ÊåâÈíÆ -->
              <a-tooltip title="Âà†Èô§">
                <a-button size="small" type="text" danger @click="deleteMusic(record)">
                  <DeleteOutlined />
                </a-button>
              </a-tooltip>
            </a-space>
          </template>
        </template>
      </a-table>
    </a-card>

    <!-- Êô∫ËÉΩÁîüÊàêÊ®°ÊÄÅÊ°ÜÂ∑≤ÁßªÈô§ - ÂäüËÉΩÂ§çÊùÇÔºåÂêéÊúü‰ºòÂåñ -->

    <!-- Âü∫‰∫éÊèèËø∞ÁöÑÁõ¥Êé•ÁîüÊàêÊäΩÂ±â -->
    <a-drawer
      v-model:open="showDirectGenerationModal"
      title="üéµ ÂêàÊàêËÉåÊôØÈü≥‰πê"
      width="600px"
      placement="right"
      @close="() => { showDirectGenerationModal = false; resetDirectForm() }"
    >
      <template #extra>
        <a-space>
          <a-button @click="() => { showDirectGenerationModal = false; resetDirectForm() }">ÂèñÊ∂à</a-button>
          <a-button 
            type="primary" 
            @click="handleDirectGeneration"
            :loading="generating"
            :disabled="!directForm.musicName.trim() || !directForm.lyrics.trim() || !isServiceHealthy"
          >
            ÂºÄÂßãÂêàÊàê
          </a-button>
        </a-space>
      </template>
      <div class="direct-generation-form">
        <a-form :model="directForm" layout="vertical">
          <a-form-item label="Èü≥‰πêÂêçÁß∞" required>
            <a-input
              v-model:value="directForm.musicName"
              placeholder="ËØ∑ËæìÂÖ•Èü≥‰πêÂêçÁß∞ÔºàÂøÖÂ°´Ôºâ"
              :maxlength="100"
              show-count
              :status="!directForm.musicName.trim() ? 'error' : ''"
            />
          </a-form-item>
          
          <a-form-item label="Ê≠åËØçÂÜÖÂÆπ" required>
            <SongStructureHelper 
              v-model="directForm.lyrics"
            />
          </a-form-item>
          
          <a-form-item label="Èü≥‰πêÊèèËø∞ (ÂèØÈÄâ)">
            <a-textarea
              v-model:value="directForm.description"
              placeholder="ÊèèËø∞Èü≥‰πêÁöÑÁâπÂæÅÔºåÂ¶ÇÔºöfemale, warm, pop, sad, piano, the bpm is 120"
              :rows="3"
              :maxLength="500"
              show-count
            />
            <div class="description-tips">
        
              
              <a-alert 
                message="‚è∞ ÈáçË¶ÅÊèêÁ§∫" 
                description="Èü≥‰πêÂêàÊàêÈúÄË¶ÅÊ∂àËÄóÂ§ßÈáèËÆ°ÁÆóËµÑÊ∫êÔºåÂçïÊ¨°ÂêàÊàêÂèØËÉΩÈúÄË¶Å5-15ÂàÜÈíüÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ„ÄÇÂêàÊàêÊúüÈó¥ËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢ÊàñËøõË°åÂÖ∂‰ªñÈ´òË¥üËΩΩÊìç‰Ωú„ÄÇ"
                type="warning" 
                show-icon 
                style="margin-top: 8px;"
              />
            </div>
          </a-form-item>
          
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="Èü≥‰πêÈ£éÊ†º">
                <a-select
                  v-model:value="directForm.genre"
                  placeholder="ÈÄâÊã©È£éÊ†º"
                >
                  <a-select-option value="Pop">ÊµÅË°å (Pop)</a-select-option>
                  <a-select-option value="R&B">R&B</a-select-option>
                  <a-select-option value="Dance">ËàûÊõ≤ (Dance)</a-select-option>
                  <a-select-option value="Jazz">ÁàµÂ£´ (Jazz)</a-select-option>
                  <a-select-option value="Folk">Ê∞ëË∞£ (Folk)</a-select-option>
                  <a-select-option value="Rock">ÊëáÊªö (Rock)</a-select-option>
                  <a-select-option value="Chinese Style">‰∏≠ÂõΩÈ£é</a-select-option>
                  <a-select-option value="Chinese Tradition">‰∏≠ÂõΩ‰º†Áªü</a-select-option>
                  <a-select-option value="Metal">ÈáëÂ±û (Metal)</a-select-option>
                  <a-select-option value="Reggae">Èõ∑È¨º (Reggae)</a-select-option>
                  <a-select-option value="Chinese Opera">‰∏≠ÂõΩÊàèÊõ≤</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            
            <a-col :span="12">
              <a-form-item label="Èü≥ÈáèÁ≠âÁ∫ß">
                <a-slider
                  v-model:value="directForm.volumeLevel"
                  :min="-30"
                  :max="0"
                  :step="1"
                  :tooltip-formatter="(val) => `${val}dB`"
                />
                <div style="text-align: center; font-size: 12px; color: #666;">
                  {{ directForm.volumeLevel }}dB
                </div>
              </a-form-item>
            </a-col>
          </a-row>
          
          <!-- È´òÁ∫ßÂèÇÊï∞ -->
          <a-divider>È´òÁ∫ßÂèÇÊï∞</a-divider>
          <a-row :gutter="16">
            <a-col :span="8">
              <a-form-item label="CFGÁ≥ªÊï∞ (0.1-3.0)">
                <a-input-number
                  v-model:value="directForm.cfg_coef"
                  :min="0.1"
                  :max="3.0"
                  :step="0.1"
                  style="width: 100%;"
            />
          </a-form-item>
            </a-col>
            
            <a-col :span="8">
              <a-form-item label="Ê∏©Â∫¶ (0.1-2.0)">
                <a-input-number
                  v-model:value="directForm.temperature"
                  :min="0.1"
                  :max="2.0"
                  :step="0.1"
                  style="width: 100%;"
                />
              </a-form-item>
            </a-col>
            
            <a-col :span="8">
              <a-form-item label="Top-K (1-100)">
                <a-input-number
                  v-model:value="directForm.top_k"
                  :min="1"
                  :max="100"
                  :step="1"
                  style="width: 100%;"
                />
              </a-form-item>
            </a-col>
          </a-row>
          
          <!-- Èü≥‰πêÂêçÁß∞Â≠óÊÆµÂ∑≤ÁßªÈô§ - ÂêéÁ´ØAPI‰∏çÈúÄË¶ÅÊ≠§ÂèÇÊï∞ -->
        </a-form>
        
        <!-- ÊúçÂä°Áä∂ÊÄÅ -->
        <div class="service-status-section">
          <a-alert 
            v-if="!isServiceHealthy"
            message="‚ö†Ô∏è SongGenerationÊúçÂä°‰∏çÂèØÁî®" 
            description="Èü≥‰πêÁîüÊàêÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØïÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ"
            type="warning" 
            show-icon 
          />
          <a-alert 
            v-else
            message="‚úÖ Èü≥‰πêÂêàÊàêÊúçÂä°Ê≠£Â∏∏" 
            description="SongGeneration v1.0 ËøêË°å‰∏≠ÔºåÂèØ‰ª•ÂºÄÂßãÂêàÊàêÈü≥‰πê„ÄÇÊîØÊåÅÂü∫‰∫éÊñáÊú¨ÊèèËø∞ÁöÑÁõ¥Êé•ÂêàÊàê„ÄÇ"
            type="success" 
            show-icon 
          />
        </div>
      </div>
    </a-drawer>

    <!-- ‰∏ä‰º†Èü≥‰πêÊ®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="showUploadModal"
      title="‰∏ä‰º†Èü≥‰πê"
      @ok="handleUpload"
      @cancel="() => { 
        showUploadModal = false
        // ÈáçÁΩÆË°®Âçï
        Object.assign(uploadData, {
          name: '',
          description: '',
          category_id: categories.value.length > 0 ? categories.value[0].id : 1,
          fileList: []
        })
      }"
      :confirm-loading="uploading"
    >
      <a-form :model="uploadData" layout="vertical">
        <a-form-item label="Èü≥‰πêÂêçÁß∞" required>
          <a-input v-model:value="uploadData.name" placeholder="ËØ∑ËæìÂÖ•Èü≥‰πêÂêçÁß∞" />
        </a-form-item>
        
        <a-form-item label="Èü≥‰πêÂàÜÁ±ª">
          <a-select v-model:value="uploadData.category_id" placeholder="ËØ∑ÈÄâÊã©Èü≥‰πêÂàÜÁ±ª">
            <a-select-option v-for="category in categories" :key="category.id" :value="category.id">
              {{ category.name }}
            </a-select-option>
          </a-select>
        </a-form-item>
        
        <a-form-item label="ÊèèËø∞">
          <a-textarea v-model:value="uploadData.description" placeholder="ËØ∑ËæìÂÖ•Èü≥‰πêÊèèËø∞" :rows="3" />
        </a-form-item>
        
        <a-form-item label="Èü≥‰πêÊñá‰ª∂" required>
          <a-upload
            v-model:file-list="uploadData.fileList"
            :before-upload="beforeUpload"
            accept="audio/*"
          >
            <a-button>
              <UploadOutlined />
              ÈÄâÊã©Êñá‰ª∂
            </a-button>
          </a-upload>
        </a-form-item>
      </a-form>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { message, Modal } from 'ant-design-vue'
import {
  SoundOutlined,
  AppstoreOutlined,
  ClockCircleOutlined,
  DatabaseOutlined,
  PlusOutlined,
  ReloadOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  DownloadOutlined,
  DeleteOutlined,
  UploadOutlined,
  BookOutlined,
  EditOutlined,
  DownOutlined
} from '@ant-design/icons-vue'
import { getAudioService } from '@/utils/audioService'
import { useAudioPlayerStore } from '@/stores/audioPlayer'
import { backgroundMusicAPI, musicGenerationAPI } from '@/api'
import SongStructureHelper from '@/components/synthesis-center/SongStructureHelper.vue'
// import { booksAPI, chaptersAPI } from '@/api'  // ÁßªÈô§ - Êô∫ËÉΩÁîüÊàêÂäüËÉΩÂ∑≤ÁßªÈô§

// È°µÈù¢Áä∂ÊÄÅ
const loading = ref(false)
const refreshing = ref(false)
const showUploadModal = ref(false)
const uploading = ref(false)
// const showSmartGenerationModal = ref(false)  // Êô∫ËÉΩÁîüÊàêÂ∑≤ÁßªÈô§
const showDirectGenerationModal = ref(false)
const generating = ref(false)
const isServiceHealthy = ref(true)

// Èü≥È¢ëÊúçÂä°
const audioService = getAudioService()
const audioStore = useAudioPlayerStore()

// Êï∞ÊçÆÁä∂ÊÄÅ
const musicList = ref([])
const stats = reactive({
  total_music: 0,
  total_categories: 0,
  total_duration: 0,
  total_size: 0
})

// ÂàÜÈ°µÁä∂ÊÄÅ
const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true
})

// ‰∏ä‰º†Êï∞ÊçÆ
const uploadData = reactive({
  name: '',
  description: '',
  category_id: 1,
  fileList: []
})

// Èü≥‰πêÂàÜÁ±ªÊï∞ÊçÆ
const categories = ref([])

// Êô∫ËÉΩÁîüÊàêË°®ÂçïÂ∑≤ÁßªÈô§ - ÂäüËÉΩÂ§çÊùÇÔºåÂêéÊúü‰ºòÂåñ
// const smartForm = reactive({
//   selectedBook: null,
//   selectedChapter: null,
//   duration: 120,
//   volumeLevel: -12,
//   name: ''
// })

// Áõ¥Êé•ÁîüÊàêË°®ÂçïÔºà‰∏éSongGeneration DemoÂÆåÂÖ®‰∏ÄËá¥Ôºâ
const directForm = reactive({
  musicName: '',  // Èü≥‰πêÂêçÁß∞ - ÂøÖÂ°´
  lyrics: '',  // Ê≠åËØç - ÂøÖÂ°´
  genre: 'Pop',  // Èü≥‰πêÈ£éÊ†º - ÈªòËÆ§ÊµÅË°åÈü≥‰πê
  description: '',  // Èü≥‰πêÊèèËø∞ - ÂèØÈÄâ
  cfg_coef: 1.5,  // CFGÁ≥ªÊï∞
  temperature: 0.9,  // Ê∏©Â∫¶
  top_k: 50,  // Top-K
  volumeLevel: -12  // AI-SoundÁâπÊúâÁöÑÈü≥ÈáèÁ∫ßÂà´
})

// ‰π¶Á±çÂíåÁ´†ËäÇÊï∞ÊçÆÂ∑≤ÁßªÈô§ - Êô∫ËÉΩÁîüÊàêÂäüËÉΩÁßªÈô§
// const books = ref([])
// const chapters = ref([])
// const chapterPreview = ref('')
// const booksLoading = ref(false)
// const chaptersLoading = ref(false)

// Ë°®Ê†ºÂàóÂÆö‰πâ
const tableColumns = [
  {
    title: 'Èü≥‰πêÂêçÁß∞',
    dataIndex: 'name',
    key: 'name',
    width: 200
  },
  {
    title: 'ÂàÜÁ±ª',
    dataIndex: 'category_name',
    key: 'category',
    width: 100
  },
  {
    title: 'Êó∂Èïø',
    dataIndex: 'duration',
    key: 'duration',
    width: 80
  },
  {
    title: 'Â§ßÂ∞è',
    dataIndex: 'file_size',
    key: 'file_size',
    width: 80
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 150,
    fixed: 'right'
  }
]

// ÊñπÊ≥ï
const refreshData = async () => {
  refreshing.value = true
  try {
    await loadMusicList()
    await loadStats()
    message.success('Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäü')
  } catch (error) {
    message.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•')
  } finally {
    refreshing.value = false
  }
}

const loadMusicList = async () => {
  loading.value = true
  try {
    console.log('üîç ÂºÄÂßãÂä†ËΩΩÈü≥‰πêÂàóË°®ÔºàËÉåÊôØÈü≥‰πê + ÁîüÊàê‰ªªÂä°Ôºâ...')
    
    // üéØ ÂêåÊó∂Ëé∑ÂèñËÉåÊôØÈü≥‰πêÂíåÈü≥‰πêÁîüÊàê‰ªªÂä°
    const [backgroundResponse, generationResponse] = await Promise.allSettled([
      backgroundMusicAPI.getMusic({
        page: pagination.current,
        page_size: pagination.pageSize,
        active_only: true
      }),
      fetch(`/api/v1/music-generation-async/music-tasks?page=${pagination.current}&page_size=${pagination.pageSize}`)
        .then(res => res.json())
    ])
    
    let allItems = []
    let totalCount = 0
    
    // Â§ÑÁêÜËÉåÊôØÈü≥‰πêÊï∞ÊçÆ
    if (backgroundResponse.status === 'fulfilled' && backgroundResponse.value.data) {
      const bgItems = backgroundResponse.value.data.items || []
      allItems = allItems.concat(bgItems.map(item => ({
        ...item,
        type: 'background_music',
        category_name: item.category?.name || item.category_name || 'ËÉåÊôØÈü≥‰πê',
        status: 'completed'
      })))
      totalCount += backgroundResponse.value.data.total || 0
    } else {
      console.warn('‚ùå ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•:', backgroundResponse.reason)
    }
    
    // Â§ÑÁêÜÈü≥‰πêÁîüÊàê‰ªªÂä°Êï∞ÊçÆ
    if (generationResponse.status === 'fulfilled' && generationResponse.value.success) {
      const genItems = generationResponse.value.data.items || []
      allItems = allItems.concat(genItems.map(item => ({
        ...item,
        type: 'generation_task',
        // ‚úÖ ‰øÆÂ§çÔºö‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÈü≥‰πêÂêçÁß∞ÔºåÂä†‰∏äÁä∂ÊÄÅÂõæÊ†á
        name: item.status === 'pending' ? `üéµ ${item.name}` :
              item.status === 'processing' ? `üéµ ${item.name} (${Math.round((item.progress || 0) * 100)}%)` :
              item.status === 'completed' ? `‚úÖ ${item.name}` :
              item.status === 'failed' ? `‚ùå ${item.name}` :
              item.name,
        category_name: item.custom_style || 'Èü≥‰πêÁîüÊàê',  // È£éÊ†º‰Ωú‰∏∫ÂàÜÁ±ªÊòæÁ§∫
        duration: item.duration || 0,
        file_size: item.file_size || 0
      })))
      totalCount += generationResponse.value.data.total || 0
    } else {
      console.warn('‚ùå Èü≥‰πêÁîüÊàê‰ªªÂä°Âä†ËΩΩÂ§±Ë¥•:', generationResponse.reason)
    }
    
    // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
    allItems.sort((a, b) => {
      const aTime = new Date(a.created_at || 0).getTime()
      const bTime = new Date(b.created_at || 0).getTime()
      return bTime - aTime
    })
    
    // üîß Â§ÑÁêÜÊï∞ÊçÆÊ†ºÂºèÔºåÁ°Æ‰øùÂ≠óÊÆµÊ≠£Á°ÆÊò†Â∞Ñ
    musicList.value = allItems.map(item => ({
      ...item,
      category_name: item.category_name || 'Êú™ÂàÜÁ±ª'
    }))
    
    pagination.total = totalCount
    console.log(`üìã Âä†ËΩΩ‰∫Ü ${musicList.value.length} Êù°Èü≥‰πêËÆ∞ÂΩï (ËÉåÊôØÈü≥‰πê+ÁîüÊàê‰ªªÂä°)`)
    console.log('üîç Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆ:', musicList.value.length > 0 ? musicList.value[0] : 'Êó†Êï∞ÊçÆ')
  } catch (error) {
    console.error('‚ùå Âä†ËΩΩÈü≥‰πêÂàóË°®Â§±Ë¥•:', error)
    
    // üîß ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÔºå‰∏çÂÜçÈªòËÆ§‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
    if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
      message.error('Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºåËØ∑Á°Æ‰øùÊúçÂä°Ê≠£Âú®ËøêË°åÂú®8001Á´ØÂè£')
    } else if (error.response?.status === 404) {
      message.error('APIÁ´ØÁÇπ‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØË∑ØÁî±ÈÖçÁΩÆ')
    } else {
      message.error(`Âä†ËΩΩÈü≥‰πêÂàóË°®Â§±Ë¥•: ${error.response?.data?.detail || error.message}`)
    }
    
    // Ê∏ÖÁ©∫ÂàóË°®ÔºåËÆ©Áî®Êà∑Áü•ÈÅìÊ≤°ÊúâÊï∞ÊçÆ
    musicList.value = []
    pagination.total = 0
    
    console.log('üí° ÊèêÁ§∫ÔºöÂ¶ÇÊûúÂêéÁ´ØÊúçÂä°Êú™ÂêØÂä®ÔºåËØ∑ËøêË°å cd platform/backend && python main.py')
  } finally {
    loading.value = false
  }
}

const loadStats = async () => {
  try {
    console.log('üìä ÂºÄÂßãÂä†ËΩΩÁªüËÆ°‰ø°ÊÅØ...')
    const response = await backgroundMusicAPI.getStats()
    
    if (response.data) {
      Object.assign(stats, response.data)
      console.log('‚úÖ ÁªüËÆ°‰ø°ÊÅØÂä†ËΩΩÊàêÂäü:', response.data)
    }
  } catch (error) {
    console.error('‚ùå Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error)
    
    // üîß ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ‰∏∫0ÔºåËÄå‰∏çÊòØÊ®°ÊãüÊï∞ÊçÆ
    Object.assign(stats, {
      total_music: 0,
      total_categories: 0,
      total_duration: 0,
      total_size: 0
    })
    
    console.log('üí° ÁªüËÆ°‰ø°ÊÅØÊó†Ê≥ïÂä†ËΩΩÔºåÊòæÁ§∫‰∏∫0')
  }
}

const loadCategories = async () => {
  try {
    console.log('üîç ÂºÄÂßãÂä†ËΩΩÈü≥‰πêÂàÜÁ±ª...')
    const response = await backgroundMusicAPI.getCategories(true)
    console.log('‚úÖ ÂàÜÁ±ªAPIÂìçÂ∫î:', response)
    
    if (response.data) {
      categories.value = response.data
      // ËÆæÁΩÆÈªòËÆ§ÂàÜÁ±ªID
      if (categories.value.length > 0 && !uploadData.category_id) {
        uploadData.category_id = categories.value[0].id
      }
      console.log(`üìã Âä†ËΩΩ‰∫Ü ${categories.value.length} ‰∏™Èü≥‰πêÂàÜÁ±ª`)
    }
  } catch (error) {
    console.error('‚ùå Âä†ËΩΩÈü≥‰πêÂàÜÁ±ªÂ§±Ë¥•:', error)
    message.error('Âä†ËΩΩÈü≥‰πêÂàÜÁ±ªÂ§±Ë¥•')
  }
}

const handleTableChange = (pag) => {
  pagination.current = pag.current
  pagination.pageSize = pag.pageSize
  loadMusicList()
}

// üéØ ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÈü≥‰πêÂîØ‰∏ÄID
const getMusicId = (music) => {
  if (music.type === 'generation_task') {
    return `generation_task_${music.id}`
  } else {
    return `background_music_${music.id}`
  }
}

// üéØ ËæÖÂä©ÂáΩÊï∞ÔºöÂà§Êñ≠ÊòØÂê¶ÂèØ‰ª•Êí≠Êîæ
const canPlayMusic = (music) => {
  if (music.type === 'generation_task') {
    // ÁîüÊàê‰ªªÂä°ÂøÖÈ°ªÊòØÂ∑≤ÂÆåÊàêÁä∂ÊÄÅ‰∏îÊúâÈü≥È¢ëURL
    return music.status === 'completed' && music.audio_url
  } else {
    // ËÉåÊôØÈü≥‰πêÈªòËÆ§ÂèØ‰ª•Êí≠Êîæ
    return true
  }
}

// üéØ ËæÖÂä©ÂáΩÊï∞ÔºöÂà§Êñ≠ÊòØÂê¶ÂèØ‰ª•‰∏ãËΩΩ
const canDownloadMusic = (music) => {
  if (music.type === 'generation_task') {
    // ÁîüÊàê‰ªªÂä°ÂøÖÈ°ªÊòØÂ∑≤ÂÆåÊàêÁä∂ÊÄÅ‰∏îÊúâÈü≥È¢ëURL
    return music.status === 'completed' && music.audio_url
  } else {
    // ËÉåÊôØÈü≥‰πêÈªòËÆ§ÂèØ‰ª•‰∏ãËΩΩ
    return true
  }
}

// üéØ ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÊí≠ÊîæÊåâÈíÆÊèêÁ§∫
const getPlayButtonTooltip = (music) => {
  if (!canPlayMusic(music)) {
    if (music.type === 'generation_task') {
      if (music.status === 'pending') return 'ÂêàÊàêÂáÜÂ§á‰∏≠ÔºåÊöÇÊó∂Êó†Ê≥ïÊí≠Êîæ'
      if (music.status === 'processing') return `Ê≠£Âú®ÂêàÊàê‰∏≠ ${Math.round((music.progress || 0) * 100)}%ÔºåËØ∑Á≠âÂæÖ`
      if (music.status === 'failed') return 'ÂêàÊàêÂ§±Ë¥•ÔºåÊó†Ê≥ïÊí≠Êîæ'
      return 'Èü≥È¢ëÊñá‰ª∂‰∏çÂèØÁî®'
    }
    return 'Êó†Ê≥ïÊí≠Êîæ'
  }
  
  const audioId = getMusicId(music)
  return audioStore.isCurrentlyPlaying(audioId) ? 'ÊöÇÂÅú' : 'Êí≠Êîæ'
}

// üéØ ËæÖÂä©ÂáΩÊï∞ÔºöËé∑Âèñ‰∏ãËΩΩÊåâÈíÆÊèêÁ§∫
const getDownloadButtonTooltip = (music) => {
  if (!canDownloadMusic(music)) {
    if (music.type === 'generation_task') {
      if (music.status === 'pending') return 'ÂêàÊàêÂáÜÂ§á‰∏≠ÔºåÊöÇÊó∂Êó†Ê≥ï‰∏ãËΩΩ'
      if (music.status === 'processing') return `Ê≠£Âú®ÂêàÊàê‰∏≠ ${Math.round((music.progress || 0) * 100)}%ÔºåËØ∑Á≠âÂæÖ`
      if (music.status === 'failed') return 'ÂêàÊàêÂ§±Ë¥•ÔºåÊó†Ê≥ï‰∏ãËΩΩ'
      return 'Èü≥È¢ëÊñá‰ª∂‰∏çÂèØÁî®'
    }
    return 'Êó†Ê≥ï‰∏ãËΩΩ'
  }
  return '‰∏ãËΩΩ'
}

const playMusic = async (music) => {
  try {
    // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•Êí≠Êîæ
    if (!canPlayMusic(music)) {
      message.warning(getPlayButtonTooltip(music))
      return
    }
    
    const audioId = getMusicId(music)
    
    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êí≠ÊîæËøôÈ¶ñÈü≥‰πêÔºåÂàôÊöÇÂÅú
    if (audioStore.isCurrentlyPlaying(audioId)) {
      audioStore.pause()
      return
    }
    
    // Â¶ÇÊûúÊòØÂêå‰∏ÄÈ¶ñÈü≥‰πê‰ΩÜÊöÇÂÅú‰∫ÜÔºåÂàôÊÅ¢Â§çÊí≠Êîæ
    if (audioStore.currentAudio?.id === audioId && !audioStore.isPlaying) {
      audioStore.resume()
      return
    }
    
    // Ê†πÊçÆÈü≥‰πêÁ±ªÂûãÊûÑÂª∫Êí≠Êîæ‰ø°ÊÅØ
    let audioInfo
    if (music.type === 'generation_task') {
      // Èü≥‰πêÁîüÊàê‰ªªÂä°
      audioInfo = {
        id: audioId,
        title: music.name,
        url: music.audio_url, // Áõ¥Êé•‰ΩøÁî®‰ªªÂä°ÁöÑÈü≥È¢ëURL
        type: 'generation_task',
        metadata: {
          taskId: music.task_id,
          musicId: music.id,
          category: music.category_name || 'AIÁîüÊàê',
          duration: music.duration,
          fileSize: music.file_size,
          description: music.content,
          onEnded: () => {
            console.log(`AIÁîüÊàêÈü≥‰πê ${music.name} Êí≠ÊîæÂÆåÊàê`)
          }
        }
      }
    } else {
      // ËÉåÊôØÈü≥‰πê
      audioInfo = {
        id: audioId,
        title: music.name,
        url: `/api/v1/background-music/music/${music.id}/download`,
        type: 'background_music',
        metadata: {
          musicId: music.id,
          category: music.category?.name || music.category_name || 'ËÉåÊôØÈü≥‰πê',
          duration: music.duration,
          fileSize: music.file_size,
          description: music.description,
          onEnded: () => {
            console.log(`ËÉåÊôØÈü≥‰πê ${music.name} Êí≠ÊîæÂÆåÊàê`)
          }
        }
      }
    }
    
    await audioStore.playAudio(audioInfo)
    console.log('üéµ ÂºÄÂßãÊí≠ÊîæÈü≥‰πê:', music.name)
  } catch (error) {
    console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error)
    message.error(`Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•: ${error.message}`)
  }
}

const downloadMusic = async (music) => {
  try {
    // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•‰∏ãËΩΩ
    if (!canDownloadMusic(music)) {
      message.warning(getDownloadButtonTooltip(music))
      return
    }
    
    // Ê†πÊçÆÈü≥‰πêÁ±ªÂûãÊûÑÂª∫‰∏ãËΩΩURL
    let downloadUrl
    let filename
    
    if (music.type === 'generation_task') {
      // Èü≥‰πêÁîüÊàê‰ªªÂä°
      downloadUrl = music.audio_url
      filename = `AIÁîüÊàê_${music.custom_style}_${music.id}.wav`
    } else {
      // ËÉåÊôØÈü≥‰πê
      downloadUrl = `/api/v1/background-music/music/${music.id}/download`
      filename = `${music.name}.mp3`
    }
    
    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
    const link = document.createElement('a')
    link.href = downloadUrl
    link.download = filename
    link.target = '_blank'
    
    // Ëß¶Âèë‰∏ãËΩΩ
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    message.success(`Ê≠£Âú®‰∏ãËΩΩ: ${music.name}`)
  } catch (error) {
    console.error('‰∏ãËΩΩÈü≥‰πêÂ§±Ë¥•:', error)
    message.error('‰∏ãËΩΩÈü≥‰πêÂ§±Ë¥•')
  }
}

const deleteMusic = (music) => {
  const musicType = music.type === 'generation_task' ? 'AIÁîüÊàêÈü≥‰πê' : 'ËÉåÊôØÈü≥‰πê'
  
  Modal.confirm({
    title: 'Á°ÆËÆ§Âà†Èô§',
    content: `Á°ÆÂÆöË¶ÅÂà†Èô§${musicType} "${music.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
    onOk: async () => {
      try {
        if (music.type === 'generation_task') {
          // Âà†Èô§Èü≥‰πêÁîüÊàê‰ªªÂä°
          await fetch(`/api/v1/music-generation-async/task/${music.task_id}`, {
            method: 'DELETE'
          })
        } else {
          // Âà†Èô§ËÉåÊôØÈü≥‰πê
          await backgroundMusicAPI.deleteMusic(music.id)
        }
        
        message.success('Âà†Èô§ÊàêÂäü')
        await loadMusicList()
        await loadStats()
      } catch (error) {
        console.error('Âà†Èô§Èü≥‰πêÂ§±Ë¥•:', error)
        message.error(`Âà†Èô§Èü≥‰πêÂ§±Ë¥•: ${error.message}`)
      }
    }
  })
}

const beforeUpload = (file) => {
  const isValidType = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/mp4'].includes(file.type)
  if (!isValidType) {
    message.error('Âè™ÊîØÊåÅ MP3„ÄÅWAV„ÄÅOGG„ÄÅM4A Ê†ºÂºèÁöÑÈü≥È¢ëÊñá‰ª∂')
    return false
  }
  
  const isLt50M = file.size / 1024 / 1024 < 50
  if (!isLt50M) {
    message.error('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá 50MB')
    return false
  }
  
  // Ëá™Âä®Â°´ÂÖ•Êñá‰ª∂Âêç
  if (!uploadData.name) {
    uploadData.name = file.name.replace(/\.[^/.]+$/, '')
  }
  
  return false // ÈòªÊ≠¢Ëá™Âä®‰∏ä‰º†
}

const handleUpload = async () => {
  try {
    uploading.value = true
    
    if (uploadData.fileList.length === 0) {
      message.error('ËØ∑ÈÄâÊã©Èü≥‰πêÊñá‰ª∂')
      return
    }
    
    if (!uploadData.name.trim()) {
      message.error('ËØ∑ËæìÂÖ•Èü≥‰πêÂêçÁß∞')
      return
    }
    
    const file = uploadData.fileList[0].originFileObj || uploadData.fileList[0]
    
    // Ë∞ÉÁî®ÂÆûÈôÖÁöÑ‰∏ä‰º†API
    const musicData = {
      name: uploadData.name,
      description: uploadData.description || '',
      category_id: uploadData.category_id
    }
    
    console.log('üîÑ ÂºÄÂßã‰∏ä‰º†Èü≥‰πê:', musicData)
    const response = await backgroundMusicAPI.uploadMusic(musicData, file)
    
    console.log('‚úÖ ‰∏ä‰º†ÊàêÂäü:', response)
    message.success('‰∏ä‰º†ÊàêÂäü')
    showUploadModal.value = false
    
    // ÈáçÁΩÆË°®Âçï
    Object.assign(uploadData, {
      name: '',
      description: '',
      category_id: categories.value.length > 0 ? categories.value[0].id : 1,
      fileList: []
    })
    
    // ÈáçÊñ∞Âä†ËΩΩÈü≥‰πêÂàóË°®
    await loadMusicList()
  } catch (error) {
    console.error('‚ùå ‰∏ä‰º†Â§±Ë¥•:', error)
    message.error('‰∏ä‰º†Â§±Ë¥•: ' + (error.response?.data?.detail || error.message))
  } finally {
    uploading.value = false
  }
}

// Êô∫ËÉΩÁîüÊàêÂ§ÑÁêÜÂ∑≤ÁßªÈô§ - ÂäüËÉΩÂ§çÊùÇÔºåÂêéÊúü‰ºòÂåñ
// const handleSmartGeneration = async () => {
//   // Âü∫‰∫éÁ´†ËäÇÂÜÖÂÆπÁöÑÊô∫ËÉΩÈü≥‰πêÁîüÊàêÂäüËÉΩÂ∑≤ÁßªÈô§
//   // ÂêéÁª≠‰ºòÂåñÔºöÂàÜÊûêÂ∞èËØ¥ÂÜÖÂÆπ ‚Üí ÁîüÊàêÈü≥‰πêÊ≠åËØç ‚Üí ÈÖçÁΩÆÈü≥ÊïàÁ≠â
//   // ÊöÇÊó∂Âè™‰øùÁïôÁõ¥Êé•ÁîüÊàêÂäüËÉΩ
// }

// Áõ¥Êé•ÁîüÊàêÂ§ÑÁêÜÔºàÂü∫‰∫éÊèèËø∞Ôºâ
const handleDirectGeneration = async () => {
  try {
    // È™åËØÅË°®Âçï
    if (!directForm.lyrics.trim()) {
      message.error('ËØ∑ËæìÂÖ•Ê≠åËØçÂÜÖÂÆπ')
      return
    }
    
    generating.value = true
    
    console.log('üéµ ÂºÄÂßãÁõ¥Êé•ÁîüÊàêËÉåÊôØÈü≥‰πê:', directForm)
    
    // üîß ‰øÆÂ§çÔºö‰ΩøÁî®ÂºÇÊ≠•Èü≥‰πêÁîüÊàêAPIÔºåÈÅøÂÖç60ÁßíHTTPË∂ÖÊó∂
    // ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÔºåËÆ©Vite‰ª£ÁêÜÂ§ÑÁêÜÔºàÂºÄÂèëÊó∂‰ª£ÁêÜÂà∞8001ÔºåÁîü‰∫ßÊó∂‰ª£ÁêÜÂà∞8000Ôºâ
            const response = await fetch('/api/v1/music-generation-async/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: directForm.musicName.trim(),
        lyrics: directForm.lyrics,
        genre: directForm.genre,
        description: directForm.description,
        cfg_coef: directForm.cfg_coef,
        temperature: directForm.temperature,
        top_k: directForm.top_k,
        volume_level: directForm.volumeLevel,
        target_duration: 30  // ÈªòËÆ§30ÁßíÈü≥‰πê
      })
    })

    if (!response.ok) {
      const errorText = await response.text().catch(() => '')
      let errorDetail = `HTTP ${response.status}`
      
      try {
        const errorJson = JSON.parse(errorText)
        errorDetail = errorJson.detail || errorJson.message || errorDetail
      } catch {
        errorDetail = errorText || errorDetail
      }
      
      throw new Error(`ÂêØÂä®‰ªªÂä°Â§±Ë¥•: ${errorDetail}`)
    }

    const result = await response.json()
    console.log('üéµ ÂºÇÊ≠•Èü≥‰πêÁîüÊàê‰ªªÂä°Â∑≤ÂêØÂä®:', result.task_id)
    
    // üîß Âè™ÊúâÁúüÊ≠£ÊàêÂäüÊâçÂÖ≥Èó≠Á™óÂè£
    if (result.task_id) {
      message.success('üéµ Èü≥‰πêÁîüÊàê‰ªªÂä°Â∑≤ÂêØÂä®ÔºåÊ≠£Âú®ÂêàÊàê‰∏≠...')
      
      // üéØ Á´ãÂç≥Âà∑Êñ∞Èü≥‰πêÂàóË°®ÔºàÊòæÁ§∫"ÂêàÊàê‰∏≠"Áä∂ÊÄÅÔºâ
      await refreshData()
      
      // ÂÖ≥Èó≠ÁîüÊàêÂØπËØùÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
      showDirectGenerationModal.value = false
      resetDirectForm()
      
      console.log('‚úÖ Áõ¥Êé•ËÉåÊôØÈü≥‰πêÁîüÊàê‰ªªÂä°ÂêØÂä®ÂÆåÊàê:', result)
    } else {
      throw new Error('‰ªªÂä°ÂêØÂä®Â§±Ë¥•ÔºöÊúçÂä°Âô®Êú™ËøîÂõûtask_id')
    }
    
  } catch (error) {
    console.error('‚ùå Áõ¥Êé•ËÉåÊôØÈü≥‰πêÁîüÊàêÂ§±Ë¥•:', error)
    
    // üîß Ê†∏ÂøÉ‰øÆÂ§çÔºöÈîôËØØÊó∂‰∏çÂÖ≥Èó≠Á™óÂè£ÔºÅÔºÅÔºÅ
    let errorMessage = error.message
    
    // Ê†πÊçÆÈîôËØØÁ±ªÂûãÊèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫
    if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
      errorMessage = '‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏ËøêË°åÔºàÁ´ØÂè£8001Ôºâ'
    } else if (error.message.includes('502')) {
      errorMessage = 'üîÑ SongGenerationÊúçÂä°ÂøôÁ¢åÔºåËØ∑Á®çÂêéÈáçËØï'
    } else if (error.message.includes('500')) {
      errorMessage = '‚ö†Ô∏è ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Ê£ÄÊü•Ê≠åËØçÊ†ºÂºèÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò'
    } else if (error.message.includes('404')) {
      errorMessage = '‚ùå APIÊé•Âè£‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØË∑ØÁî±ÈÖçÁΩÆ'
    }
    
    message.error(`ÁîüÊàêÂ§±Ë¥•: ${errorMessage}`, 10) // ÈîôËØØ‰ø°ÊÅØÊòæÁ§∫10Áßí
    
    console.error('üîç ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ:', {
      error: error.message,
      stack: error.stack,
      formData: directForm
    })
    
    // ‚úÖ ‰∏çÂÖ≥Èó≠Á™óÂè£ÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞ÈîôËØØÂπ∂ÈáçËØï
    // showDirectGenerationModal.value = false // ËøôË°åË¢´Ê≥®ÈáäÊéâ‰∫ÜÔºÅ
    
  } finally {
    generating.value = false
  }
}

// Êô∫ËÉΩÁîüÊàêÈáçÁΩÆË°®ÂçïÂ∑≤ÁßªÈô§
// const resetSmartForm = () => {
//   // Êô∫ËÉΩÁîüÊàêË°®ÂçïÈáçÁΩÆÂäüËÉΩÂ∑≤ÁßªÈô§
// }

const resetDirectForm = () => {
  Object.assign(directForm, {
    musicName: '',
    lyrics: '',
    genre: 'Pop',
    description: '',
    cfg_coef: 1.5,
    temperature: 0.9,
    top_k: 50,
    volumeLevel: -12
  })
}

// ‰π¶Á±çÂíåÁ´†ËäÇÁõ∏ÂÖ≥ÊñπÊ≥ïÂ∑≤ÁßªÈô§ - Êô∫ËÉΩÁîüÊàêÂäüËÉΩÁßªÈô§
// const loadBooks = async () => {
//   // Âä†ËΩΩ‰π¶Á±çÂàóË°®ÂäüËÉΩÂ∑≤ÁßªÈô§
// }
// 
// const onBookChange = async (bookId) => {
//   // ‰π¶Á±çÈÄâÊã©ÂèòÂåñÂ§ÑÁêÜÂ∑≤ÁßªÈô§
// }
// 
// const onChapterChange = async (chapterId) => {
//   // Á´†ËäÇÈÄâÊã©ÂèòÂåñÂ§ÑÁêÜÂ∑≤ÁßªÈô§
// }

// Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
const checkServiceHealth = async () => {
  try {
    // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂÅ•Â∫∑Ê£ÄÊü•API
    // const response = await musicGenerationAPI.getServiceHealth()
    // isServiceHealthy.value = response.data.status === 'healthy'
    isServiceHealthy.value = true // ÊöÇÊó∂ËÆæ‰∏∫true
  } catch (error) {
    console.error('Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅÂ§±Ë¥•:', error)
    isServiceHealthy.value = false
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∞
const formatDuration = (seconds) => {
  if (!seconds || isNaN(seconds)) return '00:00'
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}

const formatFileSize = (bytes) => {
  if (!bytes || isNaN(bytes)) return '0 B'
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(1024))
  return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`
}

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
  refreshData()
  loadCategories()
  checkServiceHealth()
  // loadBooks()  // ÁßªÈô§ - Êô∫ËÉΩÁîüÊàêÂäüËÉΩÂ∑≤ÁßªÈô§
})
</script>

<style scoped>
.music-library {
  padding: 0;
}

.page-header {
  margin-bottom: 24px;
  padding: 32px;
  background: linear-gradient(135deg, #722ed1 0%, #531dab 100%);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(114, 46, 209, 0.3);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.title-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.page-title {
  display: flex;
  align-items: center;
  margin: 0;
  font-size: 28px;
  font-weight: 600;
  color: white;
}

.page-description {
  margin: 0;
  color: rgba(255, 255, 255, 0.85);
  font-size: 14px;
  line-height: 1.5;
}

.action-section {
  display: flex;
  gap: 16px;
}

.stats-cards {
  margin-bottom: 16px;
}

.music-table {
  margin-bottom: 16px;
}

.music-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.music-name {
  font-weight: 500;
  color: #262626;
}

.music-description {
  font-size: 12px;
  color: #8c8c8c;
  margin: 0;
}

.music-generation-form {
  padding: 24px;
}

.description-tips {
  margin-top: 8px;
}

.service-status-section {
  margin-top: 24px;
}
</style>