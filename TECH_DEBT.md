# AI-Sound 技术债务记录

## 📋 概述
这个文档记录了AI-Sound项目中的技术债务、已知问题和未来优化方向。

## 🚨 当前技术债务

### 1. TTS客户端架构冗余 (高优先级)

**问题描述**：
系统中存在两个不同的TTS客户端，导致架构混乱和维护困难。

**文件位置**：
- `platform/backend/app/tts_client.py` (旧版 - 专用MegaTTS3)
- `platform/backend/app/clients/tts_client.py` (新版 - 通用多引擎)

**当前状态**：
| 功能模块 | 使用客户端 | 工作状态 | 连接地址 |
|---------|-----------|---------|----------|
| 🎵 小说朗读 | 旧版 | ✅ 正常 | `http://megatts3:7929` |
| 🎤 声音克隆 | 旧版 | ✅ 正常 | `http://megatts3:7929` |
| 📊 系统监控 | 新版 | ❌ 异常 | `http://localhost:7929` |
| 🏥 健康检查 | 新版 | ❌ 异常 | `http://localhost:7929` |

**临时解决方案** (2025-06-11)：
- 保持现状，业务功能使用旧版客户端
- 新版客户端健康检查返回临时成功状态
- 顶部"TTS服务异常"提示已解决

**未来优化方向**：

#### 选项A：统一到新版客户端 (推荐)
**优点**：
- ✅ 支持多TTS引擎 (Azure、Google、AWS等)
- ✅ 更好的错误处理和连接管理
- ✅ 统一的抽象接口
- ✅ 便于未来扩展

**风险**：
- ❌ 需要迁移现有业务代码
- ❌ 可能影响现有TTS功能
- ❌ 需要大量测试

**迁移步骤**：
1. 验证新版客户端能正确连接MegaTTS3
2. 逐个迁移业务模块到新版客户端
3. 充分测试所有TTS功能
4. 删除旧版客户端

#### 选项B：统一到旧版客户端
**优点**：
- ✅ 零风险，现有功能完全稳定
- ✅ 针对MegaTTS3优化

**缺点**：
- ❌ 难以支持其他TTS引擎
- ❌ 扩展性差

### 2. Docker环境变量配置不一致

**问题描述**：
不同模块读取不同的环境变量名，导致配置混乱。

**当前情况**：
- Docker: `MEGATTS3_URL=http://megatts3:7929` ✅
- 旧版客户端: 读取 `MEGATTS3_URL` ✅
- 新版客户端: 读取 `MEGATTS3_URL` (已修复) ✅
- 配置文件: 读取 `MEGATTS3_URL` (已修复) ✅

**状态**: ✅ 已解决

### 3. 健康检查机制混乱

**问题描述**：
- 主应用健康检查使用新版客户端
- 业务逻辑使用旧版客户端
- 导致健康检查失败但业务正常

**临时解决方案**：
暂时让健康检查返回成功状态

**长期解决方案**：
统一客户端后，健康检查将自动修复

## 🔧 修复历史

### 2025-06-11: TTS服务异常修复
**问题**: 页面顶部显示"TTS服务异常"
**根因**: 新版TTS客户端连接localhost而非Docker容器
**解决**: 
1. 修复环境变量读取
2. 添加临时健康检查修复
3. 保持业务功能稳定

## 📅 优化计划

### 短期 (1-2周)
- [ ] 验证新版TTS客户端完全正常工作
- [ ] 为迁移制定详细测试计划

### 中期 (1个月)
- [ ] 逐步迁移业务模块到新版客户端
- [ ] 删除旧版客户端
- [ ] 完善文档

### 长期 (3个月)
- [ ] 支持多TTS引擎
- [ ] 优化错误处理和重试机制
- [ ] 性能优化

## 🚦 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 迁移破坏现有功能 | 高 | 中 | 充分测试，分步迁移 |
| 新引擎兼容性问题 | 中 | 低 | 保持MegaTTS3作为主引擎 |
| 配置复杂化 | 低 | 高 | 统一配置管理 |

## 📚 相关文档

- [Docker配置文档](docker-compose.yml)
- [TTS客户端API文档](platform/backend/app/clients/tts_client.py)
- [MegaTTS3集成文档](platform/backend/app/tts_client.py)

---

**维护者**: AI助手  
**最后更新**: 2025-06-11  
**下次审查**: 2025-06-25 