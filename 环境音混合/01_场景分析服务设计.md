# åœºæ™¯åˆ†ææœåŠ¡è®¾è®¡

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

ä»å°è¯´æ–‡æœ¬ä¸­æ™ºèƒ½æå–åœºæ™¯ä¿¡æ¯ï¼Œä¸ºç¯å¢ƒéŸ³ç”Ÿæˆæä¾›ç²¾ç¡®çš„ä¸Šä¸‹æ–‡æ ‡ç­¾ã€‚

## ğŸ§  AIåˆ†æç­–ç•¥

### åœºæ™¯ç»´åº¦åˆ†æ
```python
class SceneAnalyzer:
    def analyze_scene(self, text: str) -> SceneInfo:
        return {
            "location": self._detect_location(text),      # åœ°ç‚¹
            "weather": self._detect_weather(text),        # å¤©æ°”
            "time": self._detect_time(text),              # æ—¶é—´
            "atmosphere": self._detect_atmosphere(text),   # æ°›å›´
            "action": self._detect_action(text),          # åŠ¨ä½œ
            "emotion": self._detect_emotion(text)         # æƒ…ç»ª
        }
```

### 1. åœ°ç‚¹æ£€æµ‹ (Location Detection)
**è§„åˆ™åº“ + AIæ¨¡å‹**
```python
LOCATION_KEYWORDS = {
    "indoor": ["æˆ¿é—´", "å±‹å­", "å®¢å…", "å§å®¤", "å¨æˆ¿", "åŠå…¬å®¤", "æ•™å®¤"],
    "outdoor": ["è¡—é“", "å…¬å›­", "èŠ±å›­", "å±±ä¸Š", "æµ·è¾¹", "æ£®æ—"],
    "transport": ["è½¦é‡Œ", "é£æœºä¸Š", "ç«è½¦ä¸Š", "èˆ¹ä¸Š"],
    "public": ["é¤å…", "å’–å•¡å…", "å•†åœº", "åŒ»é™¢", "å­¦æ ¡", "å›¾ä¹¦é¦†"],
    "special": ["åœ°ä¸‹å®¤", "é˜æ¥¼", "åºŸå¢Ÿ", "æ´ç©´", "å®«æ®¿"]
}

def _detect_location(self, text: str) -> str:
    # 1. å…³é”®è¯åŒ¹é…
    for location_type, keywords in LOCATION_KEYWORDS.items():
        for keyword in keywords:
            if keyword in text:
                return location_type
                
    # 2. AIè¯­ä¹‰ç†è§£
    prompt = f"åˆ†æè¿™æ®µæ–‡å­—çš„åœ°ç‚¹ç±»å‹: {text}"
    ai_result = self.ollama_client.analyze(prompt)
    return ai_result.location
```

### 2. å¤©æ°”æ£€æµ‹ (Weather Detection)
```python
WEATHER_PATTERNS = {
    "rainy": ["ä¸‹é›¨", "é›¨å¤©", "é›¨æ°´", "é›¨å£°", "æ¹¿æ¶¦", "é›¨æ»´"],
    "sunny": ["é˜³å…‰", "æ™´å¤©", "æ˜åªš", "æ¸©æš–", "æ™´æœ—"],
    "windy": ["å¤§é£", "é£å£°", "åˆ®é£", "å‘¼å‘¼", "å¾®é£"],
    "snowy": ["ä¸‹é›ª", "é›ªèŠ±", "é›ªåœ°", "å¯’å†·", "é›ªç™½"],
    "cloudy": ["é˜´å¤©", "å¤šäº‘", "ç°è’™è’™", "é˜´æ²‰"],
    "stormy": ["æš´é›¨", "é›·å£°", "é—ªç”µ", "æš´é£é›¨"]
}
```

### 3. æ—¶é—´æ£€æµ‹ (Time Detection)
```python
TIME_PATTERNS = {
    "morning": ["æ—©æ™¨", "ä¸Šåˆ", "é»æ˜", "æ¸…æ™¨", "æ—¥å‡º"],
    "afternoon": ["ä¸‹åˆ", "åˆå", "æ­£åˆ", "ä¸­åˆ"],
    "evening": ["å‚æ™š", "é»„æ˜", "å¤•é˜³", "æ—¥è½"],
    "night": ["å¤œæ™š", "æ·±å¤œ", "åŠå¤œ", "å¤œæ·±", "æœˆäº®"],
    "dawn": ["ç ´æ™“", "æ‹‚æ™“", "å¤©äº®", "ä¸œæ–¹"]
}
```

### 4. æ°›å›´æ£€æµ‹ (Atmosphere Detection)
```python
ATMOSPHERE_PATTERNS = {
    "tense": ["ç´§å¼ ", "ææƒ§", "æƒŠæ", "å®³æ€•", "ç„¦è™‘"],
    "calm": ["å¹³é™", "å®‰é™", "å®é™", "ç¥¥å’Œ", "æ”¾æ¾"],
    "romantic": ["æµªæ¼«", "æ¸©é¦¨", "ç”œèœœ", "çˆ±æ„", "æŸ”æƒ…"],
    "mysterious": ["ç¥ç§˜", "è¯¡å¼‚", "å¥‡æ€ª", "ä¸æ˜", "é˜´æ£®"],
    "exciting": ["æ¿€åŠ¨", "å…´å¥‹", "åˆºæ¿€", "çƒ­è¡€", "æ¾æ¹ƒ"],
    "sad": ["æ‚²ä¼¤", "éš¾è¿‡", "å“­æ³£", "å¿§éƒ", "ä¼¤å¿ƒ"]
}
```

## ğŸ”„ åœºæ™¯æŒç»­æ€§åˆ†æ

### åœºæ™¯åˆ‡æ¢æ£€æµ‹
```python
def detect_scene_change(self, current_scene: SceneInfo, previous_scene: SceneInfo) -> bool:
    """æ£€æµ‹åœºæ™¯æ˜¯å¦å‘ç”Ÿå˜åŒ–"""
    
    # ä¸»è¦å˜åŒ–æŒ‡æ ‡
    major_changes = [
        current_scene.location != previous_scene.location,
        current_scene.weather != previous_scene.weather,
        current_scene.time != previous_scene.time
    ]
    
    # æ°›å›´å˜åŒ– (æ¬¡è¦)
    atmosphere_change = current_scene.atmosphere != previous_scene.atmosphere
    
    return any(major_changes) or atmosphere_change
```

### åœºæ™¯æŒç»­æ—¶é•¿é¢„ä¼°
```python
def estimate_scene_duration(self, scene_segments: List[dict]) -> float:
    """é¢„ä¼°åœºæ™¯æŒç»­æ—¶é•¿"""
    
    total_chars = sum(len(seg["content"]) for seg in scene_segments)
    dialogue_count = sum(1 for seg in scene_segments if seg["type"] == "dialogue")
    
    # åŸºç¡€æ—¶é•¿ = å­—æ•° * 0.3ç§’ + å¯¹è¯åœé¡¿
    base_duration = total_chars * 0.3 + dialogue_count * 0.5
    
    return max(base_duration, 2.0)  # æœ€å°‘2ç§’
```

## ğŸµ ç¯å¢ƒéŸ³æ˜ å°„ç­–ç•¥

### æ™ºèƒ½éŸ³æ•ˆé€‰æ‹©
```python
class EnvironmentSoundMapper:
    def map_scene_to_sound(self, scene: SceneInfo) -> str:
        """å°†åœºæ™¯æ˜ å°„åˆ°å…·ä½“çš„ç¯å¢ƒéŸ³æ–‡ä»¶"""
        
        # æ„å»ºéŸ³æ•ˆæ ‡è¯†ç¬¦
        sound_id_parts = []
        
        # åŸºç¡€ç¯å¢ƒ
        if scene.location == "outdoor" and scene.weather == "rainy":
            sound_id_parts.append("rain")
        elif scene.location == "indoor":
            sound_id_parts.append("indoor")
        elif scene.location == "forest":
            sound_id_parts.append("forest")
            
        # å¤©æ°”ä¿®é¥°
        if scene.weather == "windy":
            sound_id_parts.append("windy")
        elif scene.weather == "stormy":
            sound_id_parts.append("storm")
            
        # æ—¶é—´ä¿®é¥°
        if scene.time == "night":
            sound_id_parts.append("night")
        elif scene.time == "morning":
            sound_id_parts.append("morning")
            
        # æ°›å›´ä¿®é¥°
        if scene.atmosphere == "tense":
            sound_id_parts.append("tense")
        elif scene.atmosphere == "calm":
            sound_id_parts.append("calm")
            
        return "_".join(sound_id_parts) + ".wav"
```

### éŸ³æ•ˆç»„åˆç­–ç•¥
```python
SOUND_COMBINATIONS = {
    "rainy_night_outdoor": {
        "primary": "rain_heavy.wav",
        "secondary": "night_ambience.wav", 
        "mix_ratio": 0.7  # primaryéŸ³é‡æ¯”ä¾‹
    },
    "forest_morning_calm": {
        "primary": "forest_birds.wav",
        "secondary": "wind_gentle.wav",
        "mix_ratio": 0.8
    },
    "indoor_night_tense": {
        "primary": "silence_tense.wav",
        "secondary": "clock_ticking.wav",
        "mix_ratio": 0.6
    }
}
```

## ğŸ“Š è¾“å‡ºæ•°æ®ç»“æ„

### SceneInfoæ•°æ®ç±»
```python
@dataclass
class SceneInfo:
    location: str           # "indoor", "outdoor", "forest", etc.
    weather: str           # "rainy", "sunny", "windy", etc.
    time: str             # "morning", "afternoon", "evening", "night"
    atmosphere: str       # "calm", "tense", "romantic", etc.
    action: str          # "walking", "sitting", "running", etc.
    emotion: str         # "happy", "sad", "angry", etc.
    confidence: float    # åˆ†æç½®ä¿¡åº¦ 0-1
    duration_estimate: float  # é¢„ä¼°æŒç»­æ—¶é—´(ç§’)
    environment_sounds: List[str]  # æ¨èçš„ç¯å¢ƒéŸ³æ–‡ä»¶åˆ—è¡¨
    scene_id: str        # å”¯ä¸€åœºæ™¯æ ‡è¯†ç¬¦
    transition_type: str # "instant", "fade", "cross_fade"
```

### APIæ¥å£è®¾è®¡
```python
@router.post("/api/v1/scene-analysis/analyze")
async def analyze_scene(request: SceneAnalysisRequest):
    """åˆ†ææ–‡æœ¬åœºæ™¯ä¿¡æ¯"""
    
    analyzer = SceneAnalyzer()
    scene_info = analyzer.analyze_scene(request.text)
    
    return {
        "success": True,
        "data": {
            "scene_info": scene_info,
            "suggested_sounds": scene_info.environment_sounds,
            "confidence": scene_info.confidence
        }
    }

@router.post("/api/v1/scene-analysis/batch")  
async def batch_analyze_scenes(request: BatchSceneAnalysisRequest):
    """æ‰¹é‡åˆ†æå¤šä¸ªæ–‡æœ¬æ®µçš„åœºæ™¯"""
    
    analyzer = SceneAnalyzer()
    results = []
    
    for i, text_segment in enumerate(request.segments):
        scene_info = analyzer.analyze_scene(text_segment.content)
        
        # æ£€æµ‹åœºæ™¯åˆ‡æ¢
        if i > 0:
            previous_scene = results[i-1]["scene_info"]
            scene_change = analyzer.detect_scene_change(scene_info, previous_scene)
            scene_info.is_scene_change = scene_change
            
        results.append({
            "segment_index": i,
            "scene_info": scene_info,
            "suggested_sounds": scene_info.environment_sounds
        })
    
    return {
        "success": True,
        "data": {
            "scenes": results,
            "total_scenes": len(results),
            "scene_changes": len([r for r in results if r["scene_info"].is_scene_change])
        }
    }
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### åœºæ™¯è¯†åˆ«æµ‹è¯•
```python
TEST_CASES = [
    {
        "text": "å¤œæ·±äº†ï¼Œå¤–é¢ä¸‹ç€å°é›¨ï¼Œå¼ ä¸‰ç‹¬è‡ªååœ¨æˆ¿é—´é‡Œã€‚",
        "expected": {
            "location": "indoor",
            "weather": "rainy", 
            "time": "night",
            "atmosphere": "calm"
        }
    },
    {
        "text": "çªç„¶ä¸€å£°å·¨å“ï¼Œé›·ç”µåˆ’ç ´äº†é»‘æš—çš„å¤œç©ºï¼",
        "expected": {
            "location": "outdoor",
            "weather": "stormy",
            "time": "night", 
            "atmosphere": "tense"
        }
    }
]
```

---

**ä¸‹ä¸€æ­¥**ï¼šå®ç°æ—¶é—´è½´ç”Ÿæˆå™¨ï¼Œå°†åœºæ™¯ä¿¡æ¯è½¬æ¢ä¸ºéŸ³é¢‘æ··åˆæ—¶é—´è½´