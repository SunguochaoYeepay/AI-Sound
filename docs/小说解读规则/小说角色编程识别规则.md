# å°è¯´è§’è‰²ç¼–ç¨‹è¯†åˆ«è§„åˆ™

**[MODE: SPECIFICATION]**

## ğŸ¯ è®¾è®¡ç†å¿µ

ä½¿ç”¨ç¼–ç¨‹è§„åˆ™å¼•æ“æ›¿ä»£å¤§æ¨¡å‹è¿›è¡Œå°è¯´è§’è‰²è¯†åˆ«ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
- âš¡ **é«˜æ•ˆå¿«é€Ÿ**ï¼šæ¯«ç§’çº§å“åº”ï¼Œæ— éœ€ç­‰å¾…å¤§æ¨¡å‹æ¨ç†
- ğŸ’° **æˆæœ¬ä½å»‰**ï¼šæ— APIè°ƒç”¨è´¹ç”¨ï¼Œé›¶è¿è¥æˆæœ¬  
- ğŸ¯ **ç²¾å‡†å¯æ§**ï¼šè§„åˆ™æ˜ç¡®ï¼Œç»“æœå¯é¢„æµ‹
- ğŸ”§ **æ˜“äºè°ƒè¯•**ï¼šè§„åˆ™é€æ˜ï¼Œé—®é¢˜å®šä½ç®€å•
- ğŸ“ˆ **å¯æ‰©å±•**ï¼šè§„åˆ™å¯æŒç»­ä¼˜åŒ–å’Œæ‰©å±•

## ğŸ“‹ æ ¸å¿ƒè¯†åˆ«è§„åˆ™

### 0. æ··åˆæ–‡æœ¬åˆ†ç¦»æ¨¡å¼ (æ–°å¢)
è¯†åˆ«å¹¶åˆ†ç¦»åŒ…å«å™è¿°+å¯¹è¯çš„æ··åˆæ–‡æœ¬

```javascript
// æ··åˆæ–‡æœ¬åˆ†ç¦»é€»è¾‘
function separateMixedText(text) {
  // åŒ¹é…"è§’è‰²å+åŠ¨ä½œ+å†’å·+å¼•å·"æ¨¡å¼
  const mixedPattern = /^(.+?)([ä¸€-é¾¯]{2,4}[è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤ºè‡ªè¨€è‡ªè¯­][:ï¼š])\s*[""''ã€Œã€ã€ã€](.+?)[""''ã€Œã€ã€ã€](.*)$/;
  const match = text.match(mixedPattern);
  
  if (match) {
    const [fullMatch, prefix, speakerAction, dialogue, suffix] = match;
    const speakerName = speakerAction.match(/([ä¸€-é¾¯]{2,4})/)[1];
    
    const segments = [];
    
    // å‰ç½®å™è¿°éƒ¨åˆ† (å¦‚æœå­˜åœ¨)
    if (prefix.trim()) {
      segments.push({
        text: prefix.trim(),
        speaker: "æ—ç™½",
        confidence: 0.9,
        detection_rule: "mixed_separation",
        text_type: "narration"
      });
    }
    
    // è¯´è¯åŠ¨ä½œéƒ¨åˆ† (æ—ç™½)
    segments.push({
      text: speakerAction,
      speaker: "æ—ç™½", 
      confidence: 0.9,
      detection_rule: "mixed_separation",
      text_type: "narration"
    });
    
    // å¯¹è¯å†…å®¹éƒ¨åˆ† (è§’è‰²)
    segments.push({
      text: `"${dialogue}"`,
      speaker: speakerName,
      confidence: 0.95,
      detection_rule: "mixed_separation", 
      text_type: "dialogue"
    });
    
    // åç»­å™è¿°éƒ¨åˆ† (å¦‚æœå­˜åœ¨)
    if (suffix.trim()) {
      segments.push({
        text: suffix.trim(),
        speaker: "æ—ç™½",
        confidence: 0.9,
        detection_rule: "mixed_separation",
        text_type: "narration"
      });
    }
    
    return segments;
  }
  
  return null;
}
```

**ç¤ºä¾‹åˆ†ç¦»**ï¼š
- è¾“å…¥: `"ç™½éª¨ç²¾ä¸èƒœæ¬¢å–œï¼Œè‡ªè¨€è‡ªè¯­é“ï¼š"é€ åŒ–ï¼éƒ½è¯´åƒäº†å”åƒ§è‚‰å¯ä»¥é•¿ç”Ÿä¸è€ã€‚ä»Šå¤©æœºä¼šæ¥äº†ï¼""`
- è¾“å‡º:
  ```javascript
  [
    {
      text: "ç™½éª¨ç²¾ä¸èƒœæ¬¢å–œï¼Œ",
      speaker: "æ—ç™½",
      text_type: "narration"
    },
    {
      text: "è‡ªè¨€è‡ªè¯­é“ï¼š",
      speaker: "æ—ç™½", 
      text_type: "narration"
    },
    {
      text: ""é€ åŒ–ï¼éƒ½è¯´åƒäº†å”åƒ§è‚‰å¯ä»¥é•¿ç”Ÿä¸è€ã€‚ä»Šå¤©æœºä¼šæ¥äº†ï¼"",
      speaker: "ç™½éª¨ç²¾",
      text_type: "dialogue"
    }
  ]
  ```

### 1. æ—ç™½è¯†åˆ«æ¨¡å¼
è¯†åˆ«çº¯å™è¿°æ–‡æœ¬ï¼Œç»Ÿä¸€åˆ†é…ç»™æ—ç™½è§’è‰²

```javascript
// æ—ç™½è¯†åˆ«é€»è¾‘
function detectNarration(text) {
  // 1. ä¸åŒ…å«ä»»ä½•å¯¹è¯æ ‡è®°çš„æ–‡æœ¬
  const hasDialogueMarkers = /[""''ã€Œã€ã€ã€ï¼š:][è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤º]/g.test(text);
  
  // 2. ä¸ä»¥è§’è‰²åå¼€å¤´çš„æè¿°æ€§æ–‡æœ¬  
  const startsWithCharacter = /^[ä¸€-é¾¯]{2,4}[è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤º]/g.test(text);
  
  // 3. åŒ…å«æè¿°æ€§è¯æ±‡çš„æ–‡æœ¬
  const narrativeWords = ['åªè§', 'å¿½ç„¶', 'æ­¤æ—¶', 'è¿™æ—¶', 'çªç„¶', 'æ¥ç€', 'ç„¶å', 'äºæ˜¯', 'ä¸€å¤©', 'å¸ˆå¾’', 'å±±åŠ¿', 'å³°å²©'];
  const hasNarrativeWords = narrativeWords.some(word => text.includes(word));
  
  if (!hasDialogueMarkers && !startsWithCharacter && (hasNarrativeWords || text.length > 50)) {
    return {
      speaker: "æ—ç™½",
      confidence: 0.9,
      detection_rule: "narration",
      text_type: "narration"
    };
  }
  
  return null;
}
```

**ç¤ºä¾‹åŒ¹é…**ï¼š
- âœ… `ä¸€å¤©ï¼Œå”åƒ§å¸ˆå¾’å››äººæ¥åˆ°ä¸€åº§é«˜å±±å‰ï¼Œåªè§å±±åŠ¿é™©å³»ï¼Œå³°å²©é‡å ã€‚`
- âœ… `æ‚Ÿç©ºåˆšèµ°ï¼Œå”åƒ§å°±è¢«å¦–æ€ªç™½éª¨ç²¾å‘ç°äº†ã€‚`
- âœ… `å¸ˆå¾’ä»¬åƒäº†æ¡ƒå­ç»§ç»­èµ¶è·¯ã€‚`
- âŒ `å”åƒ§è¯´ï¼š"æˆ‘ä»¬ä¼‘æ¯ä¸€ä¸‹å§ã€‚"` (å¯¹è¯ä¸æ˜¯æ—ç™½)

### 1. ç›´æ¥å¼•è¯­æ¨¡å¼
è¯†åˆ« `"è§’è‰²å+åŠ¨ä½œ+å¼•å·"` æ ¼å¼çš„å¯¹è¯

```regex
# æ¨¡å¼1: å°æ˜è¯´ï¼š"ä½ å¥½"
^([^""''ã€Œã€ã€ã€ï¼š:ï¼Œã€‚ï¼ï¼Ÿ\s]{1,6})[è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤º][:ï¼š][""''ã€Œã€ã€ã€]

# æ¨¡å¼2: å°æ˜è¯´ï¼Œ"ä½ å¥½"  
^([^""''ã€Œã€ã€ã€ï¼š:ï¼Œã€‚ï¼ï¼Ÿ\s]{1,6})[è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤º]ï¼Œ[""''ã€Œã€ã€ã€]

# æ¨¡å¼3: å°æ˜ï¼š"ä½ å¥½"
^([^""''ã€Œã€ã€ã€ï¼š:ï¼Œã€‚ï¼ï¼Ÿ\s]{1,6})[:ï¼š][""''ã€Œã€ã€ã€]
```

**ç¤ºä¾‹åŒ¹é…**ï¼š
- âœ… `å¼ ä¸‰è¯´ï¼š"æˆ‘ä»¬èµ°å§ï¼"`
- âœ… `æå››é“ï¼š"è¿™é‡Œå¾ˆå±é™©ã€‚"`  
- âœ… `ç‹äº”ï¼š"ä»€ä¹ˆæƒ…å†µï¼Ÿ"`
- âŒ `ä»–è¯´ï¼š"ä¸è¡Œã€‚"` (ä»£è¯ä¸ç®—è§’è‰²å)

### 2. å¯¹è¯æ ‡è®°æ¨¡å¼
è¯†åˆ« `"è§’è‰²å:"` æ ¼å¼çš„å¯¹è¯æ ‡è®°

```regex
# å†’å·æ ‡è®°
^([^ï¼š:ï¼Œã€‚ï¼ï¼Ÿ\s]{2,6})[:ï¼š]
```

**ç¤ºä¾‹åŒ¹é…**ï¼š
- âœ… `å¼ ä¸‰ï¼šæˆ‘çŸ¥é“äº†ã€‚`
- âœ… `æå››ï¼šçœŸçš„å—ï¼Ÿ`
- âŒ `ç¬¬ä¸€ï¼šè¿™æ˜¯åºå·` (éäººå)

### 3. å¼•å·å¯¹è¯æ¨¡å¼
è¯†åˆ«åŒ…å«å„ç§å¼•å·çš„å¯¹è¯å†…å®¹

```regex
# æ”¯æŒçš„å¼•å·ç±»å‹
å¼•å·ç±»å‹ = ['"', '"', '"', 'ã€Œ', 'ã€', 'ã€', 'ã€', "'", "'"]

# æå–æ¨¡å¼1: å¼€å¤´è§’è‰²å+å¼•å·
^([^""''ã€Œã€ã€ã€ï¼Œã€‚ï¼ï¼Ÿ\s]{2,6})[^""''ã€Œã€ã€ã€]{0,10}[""''ã€Œã€ã€ã€]

# æå–æ¨¡å¼2: å¼•å·ç»“å°¾+è§’è‰²å+è¯´è¯åŠ¨è¯
[""''ã€Œã€ã€ã€][^""''ã€Œã€ã€ã€]+[""''ã€Œã€ã€ã€][^ï¼Œã€‚ï¼ï¼Ÿ]*?([^ï¼Œã€‚ï¼ï¼Ÿ\s]{2,6})[è¯´é“]
```

### 4. å¯¹è¯åŠ¨è¯æ¨¡å¼
è¯†åˆ« `"è§’è‰²å+å¯¹è¯åŠ¨è¯"` æ ¼å¼

```regex
# å¯¹è¯åŠ¨è¯åˆ—è¡¨
å¯¹è¯åŠ¨è¯ = [è¯´, é“, è®², å«, å–Š, é—®, ç­”, å›å¤, è¡¨ç¤º]

# åŒ¹é…æ¨¡å¼
^([^ï¼Œã€‚ï¼ï¼Ÿ\s]{2,6})[è¯´é“è®²å«å–Šé—®ç­”å›å¤è¡¨ç¤º]
```

### 5. å§“åæ¨¡å¼è¯†åˆ«
è¯†åˆ«å¥é¦–çš„äººåæ ¼å¼

```regex
# ä¸­æ–‡å§“å (2-4ä¸ªæ±‰å­—)
^([ä¸€-é¾¯]{2,4})[^ä¸€-é¾¯]

# è‹±æ–‡å§“å (é¦–å­—æ¯å¤§å†™)
^([A-Z][a-z]+)[^a-z]
```

**æ’é™¤è¯æ±‡**ï¼š
```javascript
const excludedWords = [
  // æŒ‡ç¤ºè¯
  'è¿™ä¸ª', 'é‚£ä¸ª', 'ä»€ä¹ˆ', 'å“ªé‡Œ', 'ä¸ºä»€ä¹ˆ', 'æ€ä¹ˆ',
  // è¿è¯
  'å¯æ˜¯', 'ä½†æ˜¯', 'æ‰€ä»¥', 'å› ä¸º', 'å¦‚æœ', 'è™½ç„¶',
  // æ—¶åºè¯  
  'é‡åˆ°', 'æ…¢æ…¢', 'è€Œè¿™', 'è¿™ä¸€', 'é‚£ä¸€', 'å½“ä»–', 'å½“å¥¹',
  'æ­¤æ—¶', 'æ­¤å', 'ç„¶å', 'æ¥ç€', 'æœ€å', 'ä»é‚£', 'ç»è¿‡',
  // å¸¸è§éäººåè¯æ±‡
  'ç¥å¥‡', 'åœ¨ä¸€', 'æ­£å‘', 'æ— å¥ˆ', 'å°½ç®¡'
];
```

## ğŸ” è§’è‰²éªŒè¯è§„åˆ™

### é•¿åº¦éªŒè¯
```javascript
// è§’è‰²åé•¿åº¦é™åˆ¶
const isValidLength = (name) => {
  return name.length >= 2 && name.length <= 6;
};
```

### æ ¼å¼éªŒè¯
```javascript
// ä¸­æ–‡å§“åéªŒè¯
const isValidChineseName = (name) => {
  return /^[ä¸€-é¾¯]{2,4}$/.test(name);
};

// è‹±æ–‡å§“åéªŒè¯  
const isValidEnglishName = (name) => {
  return /^[A-Za-z\s]{2,8}$/.test(name);
};
```

### å†…å®¹éªŒè¯
```javascript
// æ’é™¤æ ‡ç‚¹ç¬¦å·
const hasNopunctuation = (name) => {
  return !name.includes('ã€‚') && !name.includes('ï¼Œ') && 
         !name.includes('ï¼') && !name.includes('ï¼Ÿ') && 
         !name.includes('ï¼›');
};

// æ’é™¤æ—¶é—´è¯æ±‡
const excludeTimeWords = (name) => {
  const timeWords = ['ä¹‹å', 'ä»¥å', 'å¼€å§‹', 'ç»“æŸ', 'æ—¶å€™', 'åœ°æ–¹'];
  return !timeWords.some(word => name.includes(word));
};
```

## ğŸ¯ è¯†åˆ«ä¼˜å…ˆçº§

æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œè§’è‰²è¯†åˆ«ï¼š

1. **æ··åˆæ–‡æœ¬åˆ†ç¦»æ¨¡å¼** (æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¤„ç†å¤æ‚æ–‡æœ¬)
2. **ç›´æ¥å¼•è¯­æ¨¡å¼** 
3. **å¯¹è¯æ ‡è®°æ¨¡å¼**
4. **å¼•å·å¯¹è¯æ¨¡å¼**  
5. **å¯¹è¯åŠ¨è¯æ¨¡å¼**
6. **å§“åæ¨¡å¼è¯†åˆ«**
7. **æ—ç™½è¯†åˆ«æ¨¡å¼** (æœ€ä½ä¼˜å…ˆçº§ï¼Œå…œåº•ç­–ç•¥)

## ğŸ˜Š æƒ…ç»ªè¯†åˆ«è§„åˆ™ (æ–°å¢)

### æƒ…ç»ªæ£€æµ‹æ¨¡å¼
æ ¹æ®å¯¹è¯å†…å®¹å’Œæè¿°è¯æ±‡è¯†åˆ«è¯´è¯æƒ…ç»ªï¼Œè°ƒæ•´TTSå‚æ•°

```javascript
// æƒ…ç»ªè¯†åˆ«å¼•æ“
class EmotionDetector {
  constructor() {
    this.emotionPatterns = {
      angry: {
        keywords: ['ç”Ÿæ°”', 'æ„¤æ€’', 'æ€’é“', 'æ€’å¼', 'å–é“', 'å¤§æ€’', 'æ°”æ„¤', 'æ¼æ€’'],
        punctuation: ['ï¼ï¼', 'ï¼ï¼Ÿ', 'ï¼Ÿï¼'],
                 tts_params: {
           time_step: 28,     // æ¨ç†æ­¥æ•°å‡å°‘(åŠ å¿«åˆæˆ)
           p_w: 1.6,          // æ™ºèƒ½åº¦æƒé‡å¢åŠ 
           t_w: 3.2           // ç›¸ä¼¼åº¦æƒé‡å¢åŠ 
         }
      },
      happy: {
        keywords: ['é«˜å…´', 'å¼€å¿ƒ', 'æ¬¢å–œ', 'å…´å¥‹', 'ç¬‘é“', 'å¤§ç¬‘', 'å“ˆå“ˆ', 'å˜»å˜»'],
        punctuation: ['å“ˆå“ˆ', 'å˜¿å˜¿', 'å‘µå‘µ'],
                 tts_params: {
           time_step: 30,     // æ¨ç†æ­¥æ•°ç¨å‡
           p_w: 1.2,          // æ™ºèƒ½åº¦æƒé‡ç¨å¢
           t_w: 2.8           // ç›¸ä¼¼åº¦æƒé‡ç¨å‡
         }
      },
      sad: {
        keywords: ['ä¼¤å¿ƒ', 'éš¾è¿‡', 'æ‚²ä¼¤', 'å“­æ³£', 'æµæ³ª', 'å“€æ±‚', 'å“€å‘Š', 'æ‚²é“'],
        punctuation: ['å‘œå‘œ', 'å˜¤å˜¤', 'å“'],
                 tts_params: {
           time_step: 40,     // æ¨ç†æ­¥æ•°å¢åŠ (æ›´ç²¾ç»†)
           p_w: 1.6,          // æ™ºèƒ½åº¦æƒé‡å¢åŠ 
           t_w: 3.5           // ç›¸ä¼¼åº¦æƒé‡å¢åŠ 
         }
      },
      surprise: {
        keywords: ['æƒŠè®¶', 'åƒæƒŠ', 'éœ‡æƒŠ', 'æƒŠå‘¼', 'å¤§æƒŠ', 'æƒŠé“'],
        punctuation: ['ï¼ï¼Ÿ', 'ï¼Ÿï¼', 'å•Šï¼'],
                 tts_params: {
           time_step: 25,     // æ¨ç†æ­¥æ•°å‡å°‘(å¿«é€Ÿåˆæˆ)
           p_w: 1.3,          // æ™ºèƒ½åº¦æƒé‡ç¨å¢
           t_w: 3.1           // ç›¸ä¼¼åº¦æƒé‡ç¨å¢
         }
      },
      calm: {
        keywords: ['å¹³é™', 'æ·¡ç„¶', 'æ— å¥ˆ', 'å¹æ¯', 'è½»å£°', 'æ·¡æ·¡'],
        punctuation: ['ã€‚', 'â€¦', '...'],
                 tts_params: {
           time_step: 32,     // æ ‡å‡†æ¨ç†æ­¥æ•°
           p_w: 1.4,          // æ ‡å‡†æ™ºèƒ½åº¦æƒé‡
           t_w: 3.0           // æ ‡å‡†ç›¸ä¼¼åº¦æƒé‡
         }
      }
    };
  }

  detectEmotion(text, context = '') {
    const fullText = context + text;
    let maxScore = 0;
    let detectedEmotion = 'calm';
    
    for (const [emotion, config] of Object.entries(this.emotionPatterns)) {
      let score = 0;
      
      // å…³é”®è¯åŒ¹é…
      for (const keyword of config.keywords) {
        if (fullText.includes(keyword)) {
          score += 2;
        }
      }
      
      // æ ‡ç‚¹ç¬¦å·åŒ¹é…
      for (const punct of config.punctuation) {
        if (fullText.includes(punct)) {
          score += 1;
        }
      }
      
      if (score > maxScore) {
        maxScore = score;
        detectedEmotion = emotion;
      }
    }
    
    return {
      emotion: detectedEmotion,
      confidence: Math.min(maxScore / 3, 1.0),
      tts_params: this.emotionPatterns[detectedEmotion].tts_params
    };
  }
}
```

### æƒ…ç»ªåº”ç”¨ç¤ºä¾‹
```javascript
const emotionDetector = new EmotionDetector();

// ç”Ÿæ°”æƒ…ç»ª
const angry = emotionDetector.detectEmotion(
  '"ä½ ä¸ºä½•ä¸å¬åŠè¯´ï¼ŒæŠŠäººæ‰“æ­»ä¸€ä¸ªï¼Œåˆæ‰“æ­»ä¸€ä¸ªï¼Ÿ"', 
  'å”åƒ§å–é“ï¼š'
);
// ç»“æœ: { emotion: 'angry', confidence: 0.67, tts_params: {...} }

// æƒŠè®¶æƒ…ç»ª  
const surprise = emotionDetector.detectEmotion(
  '"æˆ‘åªå­¦è¿‡ç´§ç®å’’ï¼Œå´æ²¡æœ‰ä»€ä¹ˆæ¾ç®å’’å„¿ï¼"',
  'å”åƒ§å¤§æƒŠï¼š'
);
// ç»“æœ: { emotion: 'surprise', confidence: 0.67, tts_params: {...} }
```

## ğŸ“Š JSONè¾“å‡ºæ ¼å¼ (å®Œæ•´ç‰ˆ)

### è§’è‰²è¯†åˆ«ç»“æœ (å«æ—ç™½+æƒ…ç»ª)
```json
{
  "segments": [
    {
      "text": "ä¸€å¤©ï¼Œå”åƒ§å¸ˆå¾’å››äººæ¥åˆ°ä¸€åº§é«˜å±±å‰ï¼Œåªè§å±±åŠ¿é™©å³»ï¼Œå³°å²©é‡å ã€‚",
      "speaker": "æ—ç™½",
      "confidence": 0.9,
      "detection_rule": "narration",
      "text_type": "narration",
      "emotion": "calm",
      "emotion_confidence": 1.0,
      "voice_id": null,
             "tts_params": {
         "time_step": 32,
         "p_w": 1.4,
         "t_w": 3.0
       }
    },
         {
       "text": "ç™½éª¨ç²¾ä¸èƒœæ¬¢å–œï¼Œ",
       "speaker": "æ—ç™½",
       "confidence": 0.9,
       "detection_rule": "mixed_separation",
       "text_type": "narration",
       "emotion": "calm",
       "emotion_confidence": 1.0,
       "voice_id": null,
       "tts_params": {
         "time_step": 32,
         "p_w": 1.4,
         "t_w": 3.0
       }
     },
     {
       "text": "è‡ªè¨€è‡ªè¯­é“ï¼š",
       "speaker": "æ—ç™½",
       "confidence": 0.9,
       "detection_rule": "mixed_separation",
       "text_type": "narration",
       "emotion": "calm",
       "emotion_confidence": 1.0,
       "voice_id": null,
       "tts_params": {
         "time_step": 32,
         "p_w": 1.4,
         "t_w": 3.0
       }
     },
     {
       "text": "\"é€ åŒ–ï¼éƒ½è¯´åƒäº†å”åƒ§è‚‰å¯ä»¥é•¿ç”Ÿä¸è€ã€‚ä»Šå¤©æœºä¼šæ¥äº†ï¼\"",
       "speaker": "ç™½éª¨ç²¾",
       "confidence": 0.95,
       "detection_rule": "mixed_separation",
       "text_type": "dialogue",
       "emotion": "happy",
       "emotion_confidence": 0.67,
       "voice_id": null,
       "tts_params": {
         "time_step": 30,
         "p_w": 1.2,
         "t_w": 2.8
       }
     }, 
    {
      "text": "å”åƒ§å–é“ï¼š\"ä½ ä¸ºä½•ä¸å¬åŠè¯´ï¼ŒæŠŠäººæ‰“æ­»ä¸€ä¸ªï¼Œåˆæ‰“æ­»ä¸€ä¸ªï¼Ÿ\"",
      "speaker": "å”åƒ§",
      "confidence": 0.95,
      "detection_rule": "direct_quote",
      "text_type": "dialogue",
      "emotion": "angry",
      "emotion_confidence": 0.67,
      "voice_id": null,
             "tts_params": {
         "time_step": 28,
         "p_w": 1.6,
         "t_w": 3.2
       }
    },
    {
      "text": "å”åƒ§å¤§æƒŠï¼š\"æˆ‘åªå­¦è¿‡ç´§ç®å’’ï¼Œå´æ²¡æœ‰ä»€ä¹ˆæ¾ç®å’’å„¿ï¼\"",
      "speaker": "å”åƒ§",
      "confidence": 0.95,
      "detection_rule": "direct_quote", 
      "text_type": "dialogue",
      "emotion": "surprise",
      "emotion_confidence": 0.67,
      "voice_id": null,
             "tts_params": {
         "time_step": 25,
         "p_w": 1.3,
         "t_w": 3.1
       }
    }
  ],
  "characters": [
    {
      "name": "æ—ç™½",
      "frequency": 8,
      "gender": "neutral",
      "recommended_voice": "ä¸“ä¸šä¸»æ’­",
      "default_emotion": "calm"
    },
    {
      "name": "å”åƒ§",
      "frequency": 6,
      "gender": "unknown",
      "recommended_voice": "æ²‰ç¨³é•¿è€…",
      "emotion_distribution": {
        "angry": 2,
        "surprise": 1, 
        "calm": 3
      }
    },
    {
      "name": "æ‚Ÿç©º", 
      "frequency": 4,
      "gender": "unknown",
      "recommended_voice": "æ´»æ³¼ç”·å£°",
      "emotion_distribution": {
        "calm": 4
      }
    },
    {
      "name": "ç™½éª¨ç²¾",
      "frequency": 1,
      "gender": "unknown",
      "recommended_voice": "æ¸©æŸ”å¥³å£°",
      "emotion_distribution": {
        "happy": 1
      }
    }
  ],
  "statistics": {
    "total_segments": 19,
    "dialogue_segments": 11,
    "narration_segments": 8,
    "total_characters": 4,
    "avg_confidence": 0.93,
    "emotion_distribution": {
      "calm": 12,
      "angry": 2,
      "surprise": 1,
      "happy": 1
    },
    "processing_time_ms": 25
  }
}
```

## ğŸ”§ å®ç°æ¶æ„

### è§„åˆ™å¼•æ“æ ¸å¿ƒç±»
```javascript
class NovelCharacterDetector {
  constructor() {
    this.rules = [
      new DirectQuoteRule(),
      new ColonMarkerRule(), 
      new QuoteDialogueRule(),
      new DialogueVerbRule(),
      new NamePatternRule()
    ];
  }

  detectSpeaker(text) {
    for (const rule of this.rules) {
      const result = rule.match(text);
      if (result.matched) {
        return {
          speaker: result.speaker,
          confidence: result.confidence,
          rule: rule.name
        };
      }
    }
    return { speaker: "æ¸©æŸ”å¥³å£°", confidence: 0.0, rule: "default" };
  }

  processText(text) {
    const segments = this.segmentText(text);
    const results = segments.map(segment => ({
      text: segment,
      ...this.detectSpeaker(segment)
    }));
    
    return this.formatOutput(results);
  }
}
```

### è§„åˆ™åŸºç±»
```javascript
class DetectionRule {
  constructor(name, patterns, priority) {
    this.name = name;
    this.patterns = patterns;
    this.priority = priority;
  }

  match(text) {
    for (const pattern of this.patterns) {
      const match = pattern.exec(text);
      if (match) {
        const speaker = this.extractSpeaker(match);
        if (this.validateSpeaker(speaker)) {
          return {
            matched: true,
            speaker: speaker,
            confidence: this.calculateConfidence(match)
          };
        }
      }
    }
    return { matched: false };
  }

  validateSpeaker(speaker) {
    // åŸºç¡€éªŒè¯é€»è¾‘
    return speaker && 
           speaker.length >= 2 && 
           speaker.length <= 6 &&
           !this.isExcluded(speaker);
  }
}
```

## ğŸ® ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•
```javascript
const detector = new NovelCharacterDetector();
const text = `
å¼ ä¸‰è¯´ï¼š"æˆ‘ä»¬ä»Šå¤©å»å“ªé‡Œï¼Ÿ"
æå››ï¼š"å»å…¬å›­å§ï¼Œå¤©æ°”ä¸é”™ã€‚"  
"å¥½ä¸»æ„ï¼"ç‹äº”å…´å¥‹åœ°è¯´é“ã€‚
`;

const result = detector.processText(text);
console.log(JSON.stringify(result, null, 2));
```

### é«˜çº§é…ç½®
```javascript
const detector = new NovelCharacterDetector({
  enableGenderDetection: false,  // å…³é—­æ€§åˆ«æ£€æµ‹
  defaultVoice: "æ¸©æŸ”å¥³å£°",      // é»˜è®¤éŸ³è‰²
  confidenceThreshold: 0.8,     // ç½®ä¿¡åº¦é˜ˆå€¼
  maxCharacterLength: 4,        // æœ€å¤§è§’è‰²åé•¿åº¦
  excludeWords: ['æ—ç™½', 'æç¤º'] // è‡ªå®šä¹‰æ’é™¤è¯
});
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–
- ä½¿ç”¨é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
- é¿å…è´ªå©ªåŒ¹é…
- é™åˆ¶å›æº¯æ·±åº¦

### 2. å†…å­˜ç®¡ç†
- å¤ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
- åŠæ—¶æ¸…ç†ä¸´æ—¶å˜é‡
- ä½¿ç”¨å¯¹è±¡æ± æ¨¡å¼

### 3. å¹¶è¡Œå¤„ç†
- æ–‡æœ¬åˆ†æ®µå¹¶è¡Œå¤„ç†
- è§„åˆ™åŒ¹é…å¹¶è¡Œæ‰§è¡Œ
- ç»“æœåˆå¹¶å¼‚æ­¥å¤„ç†

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### åŸºç¡€æµ‹è¯•
```javascript
describe('è§’è‰²è¯†åˆ«æµ‹è¯•', () => {
  test('ç›´æ¥å¼•è¯­è¯†åˆ«', () => {
    const text = 'å¼ ä¸‰è¯´ï¼š"ä½ å¥½ä¸–ç•Œï¼"';
    const result = detector.detectSpeaker(text);
    expect(result.speaker).toBe('å¼ ä¸‰');
    expect(result.confidence).toBeGreaterThan(0.9);
  });

  test('å¯¹è¯æ ‡è®°è¯†åˆ«', () => {
    const text = 'æå››ï¼šä»Šå¤©å¤©æ°”çœŸå¥½ã€‚';
    const result = detector.detectSpeaker(text);  
    expect(result.speaker).toBe('æå››');
  });
});
```

### è¾¹ç•Œæµ‹è¯•
```javascript
describe('è¾¹ç•Œæƒ…å†µæµ‹è¯•', () => {
  test('ç©ºæ–‡æœ¬å¤„ç†', () => {
    const result = detector.detectSpeaker('');
    expect(result.speaker).toBe('æ¸©æŸ”å¥³å£°');
  });

  test('æ— è§’è‰²æ–‡æœ¬', () => {
    const result = detector.detectSpeaker('è¿™æ˜¯ä¸€æ®µçº¯ç²¹çš„å™è¿°æ–‡å­—ã€‚');
    expect(result.speaker).toBe('æ¸©æŸ”å¥³å£°');
  });
});
```

## ğŸ”„ æŒç»­ä¼˜åŒ–

### 1. è§„åˆ™è¿­ä»£
- æ”¶é›†è¯†åˆ«é”™è¯¯æ¡ˆä¾‹
- åˆ†ææ¨¡å¼ç¼ºå¤±æƒ…å†µ
- æŒç»­ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼

### 2. æ€§èƒ½ç›‘æ§
- ç›‘æ§è¯†åˆ«å‡†ç¡®ç‡
- è·Ÿè¸ªå¤„ç†æ—¶é—´
- ä¼˜åŒ–èµ„æºä½¿ç”¨

### 3. ç”¨æˆ·åé¦ˆ
- æ”¶é›†ç”¨æˆ·æ ‡æ³¨æ•°æ®
- åˆ†æè¯†åˆ«è´¨é‡
- è°ƒæ•´è§„åˆ™æƒé‡

## ğŸ“– ç« èŠ‚çº§å¤„ç†å¢å¼º (æ–°å¢)

### ç« èŠ‚ä¸Šä¸‹æ–‡ç®¡ç†
ä¸ºæ”¯æŒæŒ‰ç« èŠ‚å¤„ç†å¤§å‹å°è¯´ï¼Œå¢åŠ ç« èŠ‚çº§çš„è§’è‰²è¯†åˆ«å’ŒçŠ¶æ€ç®¡ç†ï¼š

```javascript
class ChapterAwareDetector extends NovelCharacterDetector {
  constructor(config = {}) {
    super(config);
    this.chapterContext = {
      chapterId: null,
      chapterTitle: '',
      globalCharacters: new Map(), // å…¨å±€è§’è‰²æ˜ å°„
      chapterCharacters: new Map(), // å½“å‰ç« èŠ‚è§’è‰²
      previousChapterContext: null // å‰ä¸€ç« èŠ‚ä¸Šä¸‹æ–‡
    };
  }

  // å¤„ç†å•ä¸ªç« èŠ‚
  processChapter(chapterText, chapterInfo) {
    this.chapterContext.chapterId = chapterInfo.id;
    this.chapterContext.chapterTitle = chapterInfo.title;
    
    // ç»§æ‰¿å…¨å±€è§’è‰²æ˜ å°„
    this.inheritGlobalCharacters();
    
    // æ‰§è¡Œç« èŠ‚å†…å®¹åˆ†æ
    const result = this.processText(chapterText);
    
    // æ›´æ–°ç« èŠ‚è§’è‰²æ˜ å°„
    this.updateChapterCharacters(result.detectedCharacters);
    
    return {
      chapter_id: chapterInfo.id,
      chapter_title: chapterInfo.title,
      chapter_number: chapterInfo.number,
      detected_characters: result.detectedCharacters,
      segments: result.segments,
      character_mapping: this.getChapterCharacterMapping(),
      processing_stats: {
        total_segments: result.segments.length,
        character_count: result.detectedCharacters.length,
        processing_time: result.processingTime,
        word_count: chapterText.length
      }
    };
  }
  
  // ç»§æ‰¿å…¨å±€è§’è‰²è®¾ç½®
  inheritGlobalCharacters() {
    // ä»å…¨å±€è§’è‰²æ˜ å°„ä¸­ç»§æ‰¿å·²é…ç½®çš„è§’è‰²
    for (const [charName, charConfig] of this.chapterContext.globalCharacters) {
      this.chapterContext.chapterCharacters.set(charName, charConfig);
    }
  }
  
  // æ›´æ–°ç« èŠ‚è§’è‰²æ˜ å°„
  updateChapterCharacters(detectedChars) {
    detectedChars.forEach(char => {
      if (!this.chapterContext.chapterCharacters.has(char.name)) {
        // æ–°å‘ç°çš„è§’è‰²ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        this.chapterContext.chapterCharacters.set(char.name, {
          name: char.name,
          voice_id: null, // å¾…ç”¨æˆ·é…ç½®
          first_appearance_chapter: this.chapterContext.chapterId,
          appearance_count: 1,
          default_emotion: 'calm'
        });
      } else {
        // å·²å­˜åœ¨è§’è‰²ï¼Œæ›´æ–°å‡ºç°æ¬¡æ•°
        const existing = this.chapterContext.chapterCharacters.get(char.name);
        existing.appearance_count++;
      }
    });
  }
  
  // è·å–ç« èŠ‚è§’è‰²æ˜ å°„
  getChapterCharacterMapping() {
    const mapping = {};
    for (const [name, config] of this.chapterContext.chapterCharacters) {
      mapping[name] = {
        voice_id: config.voice_id,
        tts_params: this.getDefaultTTSParams(config.default_emotion),
        character_info: {
          first_appearance: config.first_appearance_chapter,
          appearance_count: config.appearance_count
        }
      };
    }
    return mapping;
  }
}
```

### å…¨å±€è§’è‰²æ˜ å°„ç®¡ç†
```javascript
class GlobalCharacterManager {
  constructor() {
    this.globalMapping = new Map();
    this.characterRelations = new Map(); // è§’è‰²å…³ç³»å›¾
  }
  
  // æ·»åŠ å…¨å±€è§’è‰²é…ç½®
  addGlobalCharacter(name, config) {
    this.globalMapping.set(name, {
      name: name,
      voice_id: config.voice_id,
      default_emotion: config.default_emotion || 'calm',
      character_type: config.character_type || 'main', // main, supporting, minor
      voice_settings: config.voice_settings || {},
      description: config.description || ''
    });
  }
  
  // è·å–ç« èŠ‚è§’è‰²é…ç½®
  getChapterConfiguration(chapterCharacters) {
    const chapterConfig = {};
    
    chapterCharacters.forEach(charName => {
      if (this.globalMapping.has(charName)) {
        // ä½¿ç”¨å…¨å±€é…ç½®
        chapterConfig[charName] = this.globalMapping.get(charName);
      } else {
        // ä½¿ç”¨é»˜è®¤é…ç½®
        chapterConfig[charName] = this.createDefaultConfig(charName);
      }
    });
    
    return chapterConfig;
  }
  
  // åˆ›å»ºé»˜è®¤è§’è‰²é…ç½®
  createDefaultConfig(name) {
    return {
      name: name,
      voice_id: null, // éœ€è¦ç”¨æˆ·é…ç½®
      default_emotion: 'calm',
      character_type: 'minor',
      voice_settings: {
        time_step: 32,
        p_w: 1.4,
        t_w: 3.0
      },
      needs_configuration: true
    };
  }
}
```

### ç« èŠ‚å¤„ç†APIè®¾è®¡
```javascript
// ç« èŠ‚åˆ†æAPIè°ƒç”¨ç¤ºä¾‹
async function analyzeChapter(chapterId, options = {}) {
  const response = await fetch(`/api/v1/chapters/${chapterId}/analyze`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      use_global_mapping: options.useGlobalMapping || true,
      detection_method: 'programming',
      emotion_detection: options.emotionDetection || true,
      inherit_previous_context: options.inheritContext || false
    })
  });
  
  return await response.json();
}

// æ‰¹é‡ç« èŠ‚å¤„ç†
async function batchAnalyzeChapters(chapterIds, options = {}) {
  const response = await fetch('/api/v1/chapters/batch-analyze', {
    method: 'POST', 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chapter_ids: chapterIds,
      parallel_count: options.parallelCount || 3,
      continue_on_error: options.continueOnError || true,
      use_global_mapping: options.useGlobalMapping || true
    })
  });
  
  return await response.json();
}
```

---

**æ€»ç»“**ï¼šç¼–ç¨‹æ–¹å¼è§’è‰²è¯†åˆ«é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„è§„åˆ™å¼•æ“ï¼Œæ”¯æŒç« èŠ‚çº§å¢é‡å¤„ç†ï¼Œèƒ½å¤Ÿé«˜æ•ˆã€å‡†ç¡®åœ°è¯†åˆ«å°è¯´ä¸­çš„è§’è‰²ï¼Œä¸ºåˆ†ç« èŠ‚è¯­éŸ³åˆæˆæä¾›å¯é çš„åŸºç¡€æ•°æ®ã€‚ç›¸æ¯”å¤§æ¨¡å‹æ–¹æ¡ˆï¼Œå…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€æˆæœ¬å’Œå¯æ§æ€§ä¼˜åŠ¿ã€‚