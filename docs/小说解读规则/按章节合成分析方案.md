# å°è¯´æŒ‰ç« èŠ‚åˆæˆåˆ†ææ–¹æ¡ˆ

**[MODE: ARCHITECTURE]**

## ğŸ¯ é—®é¢˜åˆ†æ

å½“å‰ç³»ç»Ÿå­˜åœ¨çš„é—®é¢˜ï¼š
1. **å¤„ç†è§„æ¨¡è¿‡å¤§**ï¼šä¸€æ¬¡æ€§å¤„ç†ä¸Šä¸‡å­—å°è¯´ä¸ç°å®
2. **ç”¨æˆ·ä½“éªŒå·®**ï¼šæ— æ³•åˆ†ç« èŠ‚ç®¡ç†è¿›åº¦  
3. **èµ„æºæ¶ˆè€—é«˜**ï¼šå¤§æ–‡æœ¬å¤„ç†æ¶ˆè€—å†…å­˜å’Œæ—¶é—´
4. **é”™è¯¯æ¢å¤éš¾**ï¼šå¤±è´¥åéœ€è¦é‡æ–°å¼€å§‹

## ğŸ—ï¸ è§£å†³æ–¹æ¡ˆï¼šåˆ†ç« èŠ‚å¤„ç†æ¶æ„

### æ ¸å¿ƒè®¾è®¡ç†å¿µ
- âœ… **ç« èŠ‚ä¸ºå•ä½**ï¼šä»¥ç« èŠ‚ä¸ºæœ€å°å¤„ç†å•å…ƒ
- âœ… **å¢é‡å¤„ç†**ï¼šæ”¯æŒæš‚åœã€ç»§ç»­ã€é‡è¯•
- âœ… **å¹¶è¡Œå¤„ç†**ï¼šå¤šç« èŠ‚å¯å¹¶è¡Œåˆ†æåˆæˆ
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šç²¾ç¡®è·Ÿè¸ªæ¯ç« å¤„ç†çŠ¶æ€

## ğŸ“‹ æ•°æ®åº“è®¾è®¡ä¼˜åŒ–

### 1. ç« èŠ‚çŠ¶æ€ç®¡ç†
```sql
-- ç« èŠ‚è¡¨å¢å¼º
ALTER TABLE book_chapters ADD COLUMN character_analysis_result TEXT;
ALTER TABLE book_chapters ADD COLUMN synthesis_progress INTEGER DEFAULT 0;
ALTER TABLE book_chapters ADD COLUMN estimated_duration INTEGER;
ALTER TABLE book_chapters ADD COLUMN error_message TEXT;

-- ç« èŠ‚å¤„ç†çŠ¶æ€æšä¸¾
-- analysis_status: pending, processing, completed, failed
-- synthesis_status: pending, processing, completed, failed
```

### 2. é¡¹ç›®ç« èŠ‚å…³è”
```sql
-- é¡¹ç›®ç« èŠ‚è¡¨ (ç®¡ç†é¡¹ç›®åŒ…å«å“ªäº›ç« èŠ‚)
CREATE TABLE project_chapters (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    chapter_id INTEGER NOT NULL,
    chapter_order INTEGER NOT NULL,
    character_mapping TEXT, -- è¯¥ç« èŠ‚çš„è§’è‰²æ˜ å°„
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES novel_projects(id),
    FOREIGN KEY (chapter_id) REFERENCES book_chapters(id)
);
```

## ğŸ”„ å¤„ç†æµç¨‹è®¾è®¡

### é˜¶æ®µ1: ä¹¦ç±å¯¼å…¥ä¸ç« èŠ‚æ£€æµ‹
```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ å°è¯´] --> B[è‡ªåŠ¨ç« èŠ‚æ£€æµ‹]
    B --> C[ç« èŠ‚åˆ—è¡¨é¢„è§ˆ]
    C --> D[ç”¨æˆ·ç¡®è®¤/è°ƒæ•´]
    D --> E[ä¿å­˜ç« èŠ‚ç»“æ„]
    E --> F[å¯åˆ›å»ºé¡¹ç›®]
```

### é˜¶æ®µ2: é¡¹ç›®åˆ›å»ºä¸ç« èŠ‚é€‰æ‹©
```mermaid
graph TD
    A[åˆ›å»ºæœ—è¯»é¡¹ç›®] --> B[é€‰æ‹©ç›®æ ‡ä¹¦ç±]
    B --> C[é€‰æ‹©è¦å¤„ç†çš„ç« èŠ‚]
    C --> D[è®¾ç½®å…¨å±€è§’è‰²æ˜ å°„]
    D --> E[ç”Ÿæˆé¡¹ç›®è®¡åˆ’]
    E --> F[å¼€å§‹åˆ†ç« èŠ‚å¤„ç†]
```

### é˜¶æ®µ3: åˆ†ç« èŠ‚è§’è‰²åˆ†æ
```mermaid
graph TD
    A[å¼€å§‹ç« èŠ‚åˆ†æ] --> B[åº”ç”¨ç¼–ç¨‹è¯†åˆ«è§„åˆ™]
    B --> C[ç”Ÿæˆè§’è‰²åˆ—è¡¨]
    C --> D[ä¸å…¨å±€è§’è‰²æ˜ å°„åˆå¹¶]
    D --> E[ä¿å­˜ç« èŠ‚åˆ†æç»“æœ]
    E --> F[æ›´æ–°ç« èŠ‚çŠ¶æ€]
    F --> G{è¿˜æœ‰å¾…å¤„ç†ç« èŠ‚?}
    G -->|æ˜¯| A
    G -->|å¦| H[åˆ†æå®Œæˆ]
```

### é˜¶æ®µ4: åˆ†ç« èŠ‚è¯­éŸ³åˆæˆ
```mermaid
graph TD
    A[å¼€å§‹ç« èŠ‚åˆæˆ] --> B[åŠ è½½ç« èŠ‚è§’è‰²æ˜ å°„]
    B --> C[æ–‡æœ¬åˆ†æ®µå¤„ç†]
    C --> D[é€æ®µè°ƒç”¨TTS3]
    D --> E[éŸ³é¢‘ç‰‡æ®µåˆæˆ]
    E --> F[ç« èŠ‚éŸ³é¢‘åˆå¹¶]
    F --> G[ä¿å­˜ç« èŠ‚éŸ³é¢‘]
    G --> H{è¿˜æœ‰å¾…å¤„ç†ç« èŠ‚?}
    H -->|æ˜¯| A
    H -->|å¦| I[é¡¹ç›®å®Œæˆ]
```

## ğŸ’» APIæ¥å£è®¾è®¡

### 1. ç« èŠ‚ç®¡ç†æ¥å£
```javascript
// è·å–ä¹¦ç±ç« èŠ‚åˆ—è¡¨
GET /api/v1/books/{book_id}/chapters
Response: {
  chapters: [
    {
      id: 1,
      chapter_number: 1,
      title: "ç¬¬ä¸€ç«  åˆå…¥ä»™é—¨",
      word_count: 2580,
      analysis_status: "completed",
      synthesis_status: "pending",
      character_count: 8,
      estimated_duration: "3åˆ†25ç§’"
    }
  ]
}

// åˆ†æå•ä¸ªç« èŠ‚
POST /api/v1/chapters/{chapter_id}/analyze
Request: {
  use_global_mapping: true,
  detection_rules: "programming" // ä½¿ç”¨ç¼–ç¨‹è§„åˆ™
}
Response: {
  success: true,
  analysis_result: {
    characters: ["å”åƒ§", "æ‚Ÿç©º", "å…«æˆ’", "æ²™åƒ§"],
    segments: [...],
    processing_time: 120 // æ¯«ç§’
  }
}

// åˆæˆå•ä¸ªç« èŠ‚
POST /api/v1/chapters/{chapter_id}/synthesize
Request: {
  character_mapping: {
    "å”åƒ§": { voice_id: 1, tts_params: {...} },
    "æ‚Ÿç©º": { voice_id: 2, tts_params: {...} }
  }
}
```

### 2. é¡¹ç›®ç« èŠ‚æ¥å£
```javascript
// åˆ›å»ºé¡¹ç›®å¹¶é€‰æ‹©ç« èŠ‚
POST /api/v1/projects/create-with-chapters
Request: {
  name: "è¥¿æ¸¸è®°æœ—è¯»é¡¹ç›®",
  book_id: 1,
  selected_chapters: [1, 2, 3, 4, 5], // ç« èŠ‚IDåˆ—è¡¨
  global_character_mapping: {...}
}

// æ‰¹é‡å¤„ç†ç« èŠ‚
POST /api/v1/projects/{project_id}/process-chapters
Request: {
  operation: "analyze", // analyze | synthesize | both
  chapter_ids: [1, 2, 3],
  parallel_count: 2,
  continue_on_error: true
}

// è·å–é¡¹ç›®è¿›åº¦
GET /api/v1/projects/{project_id}/progress
Response: {
  total_chapters: 10,
  completed_analysis: 8,
  completed_synthesis: 5,
  current_processing: ["ç¬¬3ç« ", "ç¬¬4ç« "],
  estimated_remaining: "25åˆ†é’Ÿ"
}
```

## ğŸ“Š å‰ç«¯ç•Œé¢è®¾è®¡

### 1. ç« èŠ‚ç®¡ç†é¡µé¢
```vue
<template>
  <div class="chapter-management">
    <!-- ç« èŠ‚åˆ—è¡¨ -->
    <a-table :dataSource="chapters" :columns="chapterColumns">
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'status'">
          <a-tag :color="getStatusColor(record.analysis_status)">
            {{ getStatusText(record.analysis_status) }}
          </a-tag>
        </template>
        
        <template v-if="column.key === 'actions'">
          <a-space>
            <a-button @click="analyzeChapter(record)" size="small">
              åˆ†æ
            </a-button>
            <a-button @click="synthesizeChapter(record)" size="small">
              åˆæˆ
            </a-button>
            <a-button @click="previewChapter(record)" size="small">
              é¢„è§ˆ
            </a-button>
          </a-space>
        </template>
      </template>
    </a-table>
    
    <!-- æ‰¹é‡æ“ä½œ -->
    <div class="batch-operations">
      <a-button-group>
        <a-button @click="batchAnalyze">æ‰¹é‡åˆ†æ</a-button>
        <a-button @click="batchSynthesize">æ‰¹é‡åˆæˆ</a-button>
        <a-button @click="batchExport">æ‰¹é‡å¯¼å‡º</a-button>
      </a-button-group>
    </div>
  </div>
</template>
```

### 2. é¡¹ç›®è¿›åº¦ç›‘æ§
```vue
<template>
  <div class="project-progress">
    <!-- æ€»ä½“è¿›åº¦ -->
    <a-card title="é¡¹ç›®è¿›åº¦æ€»è§ˆ">
      <a-progress 
        :percent="Math.round(progressData.completed / progressData.total * 100)"
        status="active"
      />
      <p>å·²å®Œæˆ {{ progressData.completed }} / {{ progressData.total }} ç« èŠ‚</p>
    </a-card>
    
    <!-- è¯¦ç»†è¿›åº¦ -->
    <a-card title="ç« èŠ‚è¯¦æƒ…">
      <div v-for="chapter in detailedProgress" :key="chapter.id" class="chapter-progress">
        <div class="chapter-header">
          <h4>{{ chapter.title }}</h4>
          <a-tag :color="getStatusColor(chapter.status)">
            {{ chapter.status }}
          </a-tag>
        </div>
        
        <a-progress 
          v-if="chapter.status === 'processing'"
          :percent="chapter.progress"
          size="small"
        />
        
        <div v-if="chapter.error" class="error-message">
          <a-alert :message="chapter.error" type="error" size="small" />
        </div>
      </div>
    </a-card>
  </div>
</template>
```

## ğŸ”§ æ ¸å¿ƒæœåŠ¡å®ç°

### 1. ç« èŠ‚åˆ†ææœåŠ¡
```python
class ChapterAnalysisService:
    def __init__(self, character_detector: NovelCharacterDetector):
        self.detector = character_detector
    
    async def analyze_chapter(self, chapter_id: int, config: AnalysisConfig):
        """åˆ†æå•ä¸ªç« èŠ‚"""
        chapter = await self.get_chapter(chapter_id)
        
        # æ›´æ–°çŠ¶æ€
        await self.update_chapter_status(chapter_id, "processing")
        
        try:
            # åº”ç”¨ç¼–ç¨‹è¯†åˆ«è§„åˆ™
            result = self.detector.processText(chapter.content)
            
            # ä¿å­˜åˆ†æç»“æœ
            await self.save_analysis_result(chapter_id, result)
            
            # æ›´æ–°çŠ¶æ€
            await self.update_chapter_status(chapter_id, "completed")
            
            return result
            
        except Exception as e:
            await self.update_chapter_status(chapter_id, "failed", str(e))
            raise
    
    async def batch_analyze_chapters(self, chapter_ids: List[int], parallel_count: int = 3):
        """æ‰¹é‡åˆ†æç« èŠ‚"""
        semaphore = asyncio.Semaphore(parallel_count)
        
        async def analyze_with_semaphore(chapter_id):
            async with semaphore:
                return await self.analyze_chapter(chapter_id)
        
        tasks = [analyze_with_semaphore(cid) for cid in chapter_ids]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        return results
```

### 2. ç« èŠ‚åˆæˆæœåŠ¡
```python
class ChapterSynthesisService:
    def __init__(self, tts_client):
        self.tts_client = tts_client
    
    async def synthesize_chapter(self, chapter_id: int, character_mapping: Dict):
        """åˆæˆå•ä¸ªç« èŠ‚"""
        chapter = await self.get_chapter(chapter_id)
        analysis_result = await self.get_analysis_result(chapter_id)
        
        # æ›´æ–°çŠ¶æ€
        await self.update_synthesis_status(chapter_id, "processing")
        
        try:
            audio_segments = []
            total_segments = len(analysis_result.segments)
            
            for i, segment in enumerate(analysis_result.segments):
                # è·å–è§’è‰²éŸ³è‰²é…ç½®
                voice_config = character_mapping.get(segment.speaker)
                
                # è°ƒç”¨TTSåˆæˆ
                audio_data = await self.tts_client.synthesize(
                    text=segment.text,
                    voice_id=voice_config.voice_id,
                    tts_params=voice_config.tts_params
                )
                
                audio_segments.append(audio_data)
                
                # æ›´æ–°è¿›åº¦
                progress = int((i + 1) / total_segments * 100)
                await self.update_synthesis_progress(chapter_id, progress)
            
            # åˆå¹¶éŸ³é¢‘
            final_audio = await self.merge_audio_segments(audio_segments)
            
            # ä¿å­˜éŸ³é¢‘æ–‡ä»¶
            audio_url = await self.save_chapter_audio(chapter_id, final_audio)
            
            # æ›´æ–°çŠ¶æ€
            await self.update_synthesis_status(chapter_id, "completed")
            
            return audio_url
            
        except Exception as e:
            await self.update_synthesis_status(chapter_id, "failed", str(e))
            raise
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¹¶è¡Œå¤„ç†
- æ”¯æŒå¤šç« èŠ‚å¹¶è¡Œåˆ†æ
- ç« èŠ‚å†…æ®µè½å¹¶è¡Œåˆæˆ
- éŸ³é¢‘å¤„ç†å¼‚æ­¥åŒ–

### 2. å†…å­˜ç®¡ç†
- åˆ†æ®µåŠ è½½å¤§ç« èŠ‚å†…å®¹
- åŠæ—¶é‡Šæ”¾éŸ³é¢‘å†…å­˜
- ä½¿ç”¨æµå¼å¤„ç†

### 3. ç¼“å­˜ç­–ç•¥
- è§’è‰²åˆ†æç»“æœç¼“å­˜
- éŸ³é¢‘ç‰‡æ®µå¤ç”¨ç¼“å­˜
- é…ç½®å‚æ•°ç¼“å­˜

### 4. é”™è¯¯æ¢å¤
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- å¤±è´¥é‡è¯•æœºåˆ¶
- éƒ¨åˆ†æˆåŠŸä¿å­˜

## ğŸ® ç”¨æˆ·ä½¿ç”¨æµç¨‹

### 1. å¯¼å…¥å°è¯´
1. ä¸Šä¼ å°è¯´æ–‡ä»¶
2. è‡ªåŠ¨æ£€æµ‹ç« èŠ‚ç»“æ„
3. é¢„è§ˆå¹¶è°ƒæ•´ç« èŠ‚åˆ†å‰²
4. ä¿å­˜ç« èŠ‚æ•°æ®

### 2. åˆ›å»ºé¡¹ç›®
1. é€‰æ‹©ç›®æ ‡ä¹¦ç±
2. é€‰æ‹©è¦å¤„ç†çš„ç« èŠ‚èŒƒå›´
3. é…ç½®å…¨å±€è§’è‰²æ˜ å°„
4. åˆ›å»ºé¡¹ç›®

### 3. åˆ†ç« èŠ‚å¤„ç†
1. é€‰æ‹©å¤„ç†æ¨¡å¼ï¼ˆåˆ†æ/åˆæˆ/å…¨éƒ¨ï¼‰
2. è®¾ç½®å¹¶è¡Œå¤„ç†æ•°é‡
3. å¼€å§‹æ‰¹é‡å¤„ç†
4. å®æ—¶ç›‘æ§è¿›åº¦

### 4. ç»“æœç®¡ç†
1. æŸ¥çœ‹å„ç« èŠ‚çŠ¶æ€
2. é¢„è§ˆåˆ†æç»“æœ
3. è¯•å¬åˆæˆéŸ³é¢‘
4. è°ƒæ•´æœ‰é—®é¢˜çš„ç« èŠ‚

---

**æ€»ç»“**ï¼šé€šè¿‡åˆ†ç« èŠ‚å¤„ç†æ¶æ„ï¼Œå°†å¤§å‹å°è¯´åˆ†è§£ä¸ºå¯ç®¡ç†çš„å°å•å…ƒï¼Œå®ç°å¢é‡å¤„ç†ã€å¹¶è¡Œä¼˜åŒ–å’Œç²¾ç¡®çŠ¶æ€ç®¡ç†ï¼Œå¤§å¹…æå‡å¤„ç†æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚ 