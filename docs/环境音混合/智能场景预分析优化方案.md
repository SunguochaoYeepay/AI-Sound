# æ™ºèƒ½åœºæ™¯é¢„åˆ†æä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

å°†åœºæ™¯åˆ†æèƒ½åŠ›å‰ç½®åˆ°**ç¯å¢ƒéŸ³ç®¡ç†**æ¨¡å—ï¼Œé€šè¿‡æ™ºèƒ½é¢„åˆ†æå’Œæ‰¹é‡ç”Ÿæˆï¼Œå¤§å¹…æå‡ç¯å¢ƒéŸ³æ··åˆçš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

## ğŸš€ ä¼˜åŒ–å‰åå¯¹æ¯”

### âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆå®æ—¶ç”Ÿæˆï¼‰
```
ç”¨æˆ·ç‚¹å‡»ç¯å¢ƒéŸ³æ··åˆ 
â†’ åˆ†æéŸ³é¢‘æ–‡ä»¶æ—¶é•¿ 
â†’ å®æ—¶åœºæ™¯åˆ†æ 
â†’ è°ƒç”¨TangoFluxç”Ÿæˆç¯å¢ƒéŸ³ï¼ˆæ…¢ï¼‰
â†’ éŸ³é¢‘æ··åˆ 
â†’ ç”¨æˆ·ç­‰å¾…5-10åˆ†é’Ÿ
```

### âœ… ä¼˜åŒ–æ–¹å¼ï¼ˆé¢„ç”Ÿæˆç¼“å­˜ï¼‰
```
é¢„å…ˆé˜¶æ®µï¼š
ç¯å¢ƒéŸ³ç®¡ç† â†’ æ™ºèƒ½åœºæ™¯åˆ†æ â†’ æ‰¹é‡ç”Ÿæˆå¸¸ç”¨ç¯å¢ƒéŸ³ â†’ å­˜å‚¨åˆ°éŸ³é¢‘åº“

å®æ—¶é˜¶æ®µï¼š
ç”¨æˆ·ç‚¹å‡»ç¯å¢ƒéŸ³æ··åˆ 
â†’ åˆ†æéŸ³é¢‘æ–‡ä»¶æ—¶é•¿ 
â†’ æ™ºèƒ½åœºæ™¯åŒ¹é… 
â†’ ä»éŸ³é¢‘åº“è°ƒç”¨ï¼ˆå¿«ï¼‰æˆ–æŒ‰éœ€ç”Ÿæˆ 
â†’ éŸ³é¢‘æ··åˆ 
â†’ ç”¨æˆ·ç­‰å¾…1-2åˆ†é’Ÿ
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1. æ™ºèƒ½åœºæ™¯é¢„åˆ†ææœåŠ¡
```python
class IntelligentScenePreAnalyzer:
    """æ™ºèƒ½åœºæ™¯é¢„åˆ†æå™¨"""
    
    def __init__(self):
        self.scene_analyzer = SequentialTimelineGenerator()
        self.common_scenes = self._load_common_scenes()
        
    def analyze_text_for_scenes(self, text: str) -> List[SceneInfo]:
        """åˆ†ææ–‡æœ¬ï¼Œæå–æ‰€æœ‰å¯èƒ½çš„åœºæ™¯"""
        
    def generate_scene_variations(self, base_scenes: List[SceneInfo]) -> List[SceneInfo]:
        """ç”Ÿæˆåœºæ™¯å˜ä½“ï¼ˆä¸åŒæ—¶é•¿ã€éŸ³é‡ç­‰ï¼‰"""
        
    def batch_generate_environment_sounds(self, scenes: List[SceneInfo]) -> List[EnvironmentSound]:
        """æ‰¹é‡ç”Ÿæˆç¯å¢ƒéŸ³å¹¶å­˜å‚¨åˆ°éŸ³é¢‘åº“"""
```

### 2. ç¯å¢ƒéŸ³æ™ºèƒ½ç®¡ç†
```python
class EnvironmentSoundManager:
    """ç¯å¢ƒéŸ³æ™ºèƒ½ç®¡ç†å™¨"""
    
    def find_matching_environment_sound(self, scene_info: SceneInfo, duration: float) -> Optional[EnvironmentSound]:
        """æ™ºèƒ½åŒ¹é…ç°æœ‰ç¯å¢ƒéŸ³"""
        
    def generate_on_demand(self, scene_info: SceneInfo, duration: float) -> EnvironmentSound:
        """æŒ‰éœ€ç”Ÿæˆç¯å¢ƒéŸ³"""
        
    def optimize_cache(self) -> None:
        """ä¼˜åŒ–ç¼“å­˜ç­–ç•¥"""
```

### 3. ä¼˜åŒ–åçš„æ··åˆæµç¨‹
```python
class OptimizedSequentialSynthesisCoordinator:
    """ä¼˜åŒ–ç‰ˆé¡ºåºåˆæˆåè°ƒå™¨"""
    
    async def _stage_3_environment_generation_optimized(self, timeline, project_id):
        """ä¼˜åŒ–ç‰ˆç¯å¢ƒéŸ³ç”Ÿæˆ"""
        environment_files = []
        
        for track in timeline.environment_tracks:
            # ğŸš€ ä¼˜å…ˆä»éŸ³é¢‘åº“æŸ¥æ‰¾
            existing_sound = environment_manager.find_matching_environment_sound(
                track.scene_info, track.duration
            )
            
            if existing_sound:
                logger.info(f"ğŸµ ä½¿ç”¨ç¼“å­˜ç¯å¢ƒéŸ³: {existing_sound.filename}")
                environment_files.append(existing_sound.to_file_info())
            else:
                logger.info(f"ğŸ”„ æŒ‰éœ€ç”Ÿæˆç¯å¢ƒéŸ³: {track.scene_prompt}")
                new_sound = await environment_manager.generate_on_demand(
                    track.scene_info, track.duration
                )
                environment_files.append(new_sound.to_file_info())
        
        return environment_files
```

## ğŸµ å‰ç«¯ç•Œé¢å¢å¼º

### 1. ç¯å¢ƒéŸ³ç®¡ç†é¡µé¢æ–°å¢åŠŸèƒ½
```vue
<!-- æ™ºèƒ½åœºæ™¯åˆ†æé¢æ¿ -->
<div class="scene-analysis-panel">
  <h3>ğŸ§  æ™ºèƒ½åœºæ™¯åˆ†æ</h3>
  
  <!-- æ–‡æœ¬åˆ†æè¾“å…¥ -->
  <a-textarea 
    v-model:value="analysisText" 
    placeholder="ç²˜è´´å°è¯´æ–‡æœ¬ï¼ŒAIå°†æ™ºèƒ½åˆ†æåœºæ™¯å¹¶é¢„ç”Ÿæˆç¯å¢ƒéŸ³"
    :rows="6"
  />
  
  <!-- åˆ†æç»“æœ -->
  <div class="scene-results">
    <div v-for="scene in analyzedScenes" :key="scene.id" class="scene-item">
      <a-tag :color="getSceneColor(scene.atmosphere)">
        {{ scene.location }} - {{ scene.atmosphere }}
      </a-tag>
      <span class="confidence">ç½®ä¿¡åº¦: {{ scene.confidence }}%</span>
      <a-button size="small" @click="generateEnvironmentSound(scene)">
        ç”Ÿæˆç¯å¢ƒéŸ³
      </a-button>
    </div>
  </div>
  
  <!-- æ‰¹é‡ç”Ÿæˆæ§åˆ¶ -->
  <div class="batch-controls">
    <a-button type="primary" @click="batchGenerateCommonScenes">
      ğŸš€ æ‰¹é‡ç”Ÿæˆå¸¸ç”¨åœºæ™¯
    </a-button>
    <a-button @click="optimizeCache">
      ğŸ§¹ ä¼˜åŒ–ç¼“å­˜
    </a-button>
  </div>
</div>
```

### 2. ç¯å¢ƒéŸ³åº“æ™ºèƒ½åˆ†ç±»
```vue
<!-- æŒ‰åœºæ™¯åˆ†ç±»æ˜¾ç¤º -->
<a-tabs v-model:activeKey="activeTab">
  <a-tab-pane key="indoor" tab="ğŸ  å®¤å†…åœºæ™¯">
    <environment-sound-grid :sounds="indoorSounds" />
  </a-tab-pane>
  <a-tab-pane key="outdoor" tab="ğŸŒ² æˆ·å¤–åœºæ™¯">
    <environment-sound-grid :sounds="outdoorSounds" />
  </a-tab-pane>
  <a-tab-pane key="weather" tab="ğŸŒ§ï¸ å¤©æ°”éŸ³æ•ˆ">
    <environment-sound-grid :sounds="weatherSounds" />
  </a-tab-pane>
  <a-tab-pane key="atmosphere" tab="ğŸ˜° æ°›å›´éŸ³ä¹">
    <environment-sound-grid :sounds="atmosphereSounds" />
  </a-tab-pane>
</a-tabs>
```

## ğŸ’¾ æ•°æ®åº“æ‰©å±•

### æ–°å¢è¡¨ç»“æ„
```sql
-- åœºæ™¯ä¿¡æ¯è¡¨
CREATE TABLE scene_analysis_cache (
    id SERIAL PRIMARY KEY,
    text_hash VARCHAR(64) UNIQUE,  -- æ–‡æœ¬å†…å®¹å“ˆå¸Œ
    analyzed_scenes JSONB,         -- åˆ†æå‡ºçš„åœºæ™¯ä¿¡æ¯
    confidence_score FLOAT,        -- æ•´ä½“ç½®ä¿¡åº¦
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- ç¯å¢ƒéŸ³ä½¿ç”¨ç»Ÿè®¡
CREATE TABLE environment_sound_usage (
    id SERIAL PRIMARY KEY,
    environment_sound_id INTEGER REFERENCES environment_sounds(id),
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMP,
    scene_match_accuracy FLOAT     -- åœºæ™¯åŒ¹é…å‡†ç¡®åº¦
);

-- æ™ºèƒ½åŒ¹é…ç´¢å¼•
CREATE INDEX idx_env_sounds_scene ON environment_sounds 
USING GIN ((metadata->>'scene_info'));
```

### EnvironmentSoundæ¨¡å‹æ‰©å±•
```python
class EnvironmentSound(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢æ™ºèƒ½åŒ¹é…å­—æ®µ
    scene_info = Column(JSON)  # åœºæ™¯ä¿¡æ¯ {"location": "forest", "atmosphere": "tense"}
    scene_tags = Column(JSON)  # åœºæ™¯æ ‡ç­¾ ["forest", "wind", "dramatic"]
    usage_count = Column(Integer, default=0)  # ä½¿ç”¨æ¬¡æ•°
    match_accuracy = Column(Float, default=0.0)  # åŒ¹é…å‡†ç¡®åº¦
    generation_source = Column(String(50), default='manual')  # ç”Ÿæˆæ¥æº: manual/auto/batch
    
    def match_scene(self, target_scene: SceneInfo) -> float:
        """è®¡ç®—ä¸ç›®æ ‡åœºæ™¯çš„åŒ¹é…åº¦"""
        
    def is_suitable_for_duration(self, target_duration: float, tolerance: float = 0.2) -> bool:
        """åˆ¤æ–­æ˜¯å¦é€‚åˆæŒ‡å®šæ—¶é•¿"""
```

## ğŸ§  æ™ºèƒ½åŒ¹é…ç®—æ³•

### åœºæ™¯ç›¸ä¼¼åº¦è®¡ç®—
```python
def calculate_scene_similarity(scene1: SceneInfo, scene2: SceneInfo) -> float:
    """è®¡ç®—ä¸¤ä¸ªåœºæ™¯çš„ç›¸ä¼¼åº¦åˆ†æ•°"""
    similarity = 0.0
    
    # åœ°ç‚¹åŒ¹é… (æƒé‡: 40%)
    if scene1.location == scene2.location:
        similarity += 0.4
    elif scene1.location in SIMILAR_LOCATIONS.get(scene2.location, []):
        similarity += 0.2
    
    # æ°›å›´åŒ¹é… (æƒé‡: 35%)
    if scene1.atmosphere == scene2.atmosphere:
        similarity += 0.35
    elif scene1.atmosphere in SIMILAR_ATMOSPHERES.get(scene2.atmosphere, []):
        similarity += 0.15
    
    # å¤©æ°”åŒ¹é… (æƒé‡: 25%)
    if scene1.weather == scene2.weather:
        similarity += 0.25
    elif scene1.weather in SIMILAR_WEATHER.get(scene2.weather, []):
        similarity += 0.1
    
    return similarity

# ç›¸ä¼¼åœºæ™¯æ˜ å°„
SIMILAR_LOCATIONS = {
    "forest": ["outdoor", "nature", "mountain"],
    "indoor": ["room", "house", "building"],
    "city": ["urban", "street", "downtown"]
}

SIMILAR_ATMOSPHERES = {
    "tense": ["scary", "suspense", "dramatic"],
    "calm": ["peaceful", "relaxing", "serene"],
    "romantic": ["gentle", "soft", "intimate"]
}
```

### æ™ºèƒ½ç¼“å­˜ç­–ç•¥
```python
class EnvironmentSoundCache:
    """ç¯å¢ƒéŸ³æ™ºèƒ½ç¼“å­˜ç®¡ç†"""
    
    def __init__(self):
        self.cache_policies = {
            "common_scenes": ["indoor_calm", "outdoor_day", "forest_peaceful"],
            "popular_atmospheres": ["tense", "romantic", "action"],
            "weather_effects": ["rainy", "windy", "stormy"]
        }
    
    def should_cache(self, scene_info: SceneInfo) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¼“å­˜æ­¤åœºæ™¯"""
        
    def get_cache_priority(self, scene_info: SceneInfo) -> int:
        """è·å–ç¼“å­˜ä¼˜å…ˆçº§"""
        
    def cleanup_unused_cache(self, days: int = 30) -> None:
        """æ¸…ç†æœªä½¿ç”¨çš„ç¼“å­˜"""
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡

### ä¼˜åŒ–ç›®æ ‡
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„å¹…åº¦ |
|------|--------|--------|----------|
| ç¯å¢ƒéŸ³æ··åˆç­‰å¾…æ—¶é—´ | 5-10åˆ†é’Ÿ | 1-2åˆ†é’Ÿ | 70-80% â¬‡ï¸ |
| CPUä½¿ç”¨ç‡å³°å€¼ | 90-95% | 60-70% | 25-30% â¬‡ï¸ |
| GPUæ˜¾å­˜å ç”¨ | æŒç»­å ç”¨ | æŒ‰éœ€å ç”¨ | 50-60% â¬‡ï¸ |
| ç¯å¢ƒéŸ³è´¨é‡ä¸€è‡´æ€§ | 70% | 90% | 20% â¬†ï¸ |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 60-80% | å…¨æ–°åŠŸèƒ½ |

### ç›‘æ§æŒ‡æ ‡
```python
@dataclass
class PerformanceMetrics:
    cache_hit_rate: float           # ç¼“å­˜å‘½ä¸­ç‡
    avg_generation_time: float      # å¹³å‡ç”Ÿæˆæ—¶é—´
    scene_match_accuracy: float     # åœºæ™¯åŒ¹é…å‡†ç¡®åº¦
    user_satisfaction_score: float  # ç”¨æˆ·æ»¡æ„åº¦
    resource_utilization: float     # èµ„æºåˆ©ç”¨ç‡
```

## ğŸ¯ å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„ (1å‘¨)
- [x] åˆ›å»ºIntelligentScenePreAnalyzeræœåŠ¡
- [x] æ‰©å±•EnvironmentSoundæ¨¡å‹
- [x] å®ç°åŸºç¡€åœºæ™¯åŒ¹é…ç®—æ³•

### Phase 2: å‰ç«¯ç•Œé¢ (1å‘¨)  
- [ ] ç¯å¢ƒéŸ³ç®¡ç†é¡µé¢å¢åŠ æ™ºèƒ½åˆ†æé¢æ¿
- [ ] åœºæ™¯åˆ†ç±»æµè§ˆç•Œé¢
- [ ] æ‰¹é‡ç”Ÿæˆæ§åˆ¶é¢æ¿

### Phase 3: ä¼˜åŒ–é›†æˆ (1å‘¨)
- [ ] é›†æˆåˆ°ç°æœ‰ç¯å¢ƒéŸ³æ··åˆæµç¨‹
- [ ] å®ç°æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- [ ] æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

### Phase 4: æµ‹è¯•ä¼˜åŒ– (1å‘¨)
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç¼“å­˜ç­–ç•¥è°ƒä¼˜

## ğŸ’¡ é¢å¤–åˆ›æ–°ç‚¹

### 1. ç”¨æˆ·å­¦ä¹ åŠŸèƒ½
```python
class UserPreferenceManager:
    """ç”¨æˆ·åå¥½å­¦ä¹ ç®¡ç†å™¨"""
    
    def record_user_feedback(self, scene_info: SceneInfo, environment_sound_id: int, rating: float):
        """è®°å½•ç”¨æˆ·åé¦ˆï¼Œä¼˜åŒ–åŒ¹é…ç®—æ³•"""
        
    def get_personalized_recommendations(self, user_id: int, scene_info: SceneInfo) -> List[EnvironmentSound]:
        """åŸºäºç”¨æˆ·åå¥½æ¨èç¯å¢ƒéŸ³"""
```

### 2. æ™ºèƒ½è´¨é‡è¯„ä¼°
```python
class EnvironmentSoundQualityAnalyzer:
    """ç¯å¢ƒéŸ³è´¨é‡åˆ†æå™¨"""
    
    def analyze_audio_quality(self, audio_path: str) -> QualityScore:
        """åˆ†æéŸ³é¢‘è´¨é‡æŒ‡æ ‡"""
        
    def suggest_improvements(self, environment_sound: EnvironmentSound) -> List[str]:
        """å»ºè®®æ”¹è¿›æ–¹æ¡ˆ"""
```

---

**ğŸ‰ æ€»ç»“**: è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡**æ™ºèƒ½é¢„åˆ†æ + ç¼“å­˜å¤ç”¨**ï¼Œå°†ç¯å¢ƒéŸ³æ··åˆä»"å®æ—¶è®¡ç®—"å‡çº§ä¸º"æ™ºèƒ½åŒ¹é…"ï¼Œå¤§å¹…æå‡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶é™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—ã€‚è¿™æ˜¯çœŸæ­£çš„**ä¼ä¸šçº§ä¼˜åŒ–ç­–ç•¥**ï¼ 