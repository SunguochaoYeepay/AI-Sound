# æ—¶é—´è½´ç”Ÿæˆå™¨è®¾è®¡

## ğŸ¯ æ ¸å¿ƒä»·å€¼

åŸºäºé¡ºåºç”Ÿæˆç­–ç•¥ï¼Œä¸ºç¯å¢ƒéŸ³æ··åˆæä¾›ç²¾ç¡®çš„æ—¶é—´è½´æ§åˆ¶ï¼Œè§£å†³TTSæ—¶é•¿ä¸å¯é¢„çŸ¥çš„é—®é¢˜ã€‚

## âš¡ é¡ºåºç”Ÿæˆä¼˜åŠ¿

### è§£å†³ä¼ ç»Ÿéš¾é¢˜
```
âŒ ä¼ ç»Ÿé—®é¢˜: TTSæ—¶é•¿æ— æ³•é¢„çŸ¥
âœ… é¡ºåºæ–¹æ¡ˆ: å…ˆç”ŸæˆTTSè·å–å®é™…æ—¶é•¿ï¼Œå†ç”Ÿæˆç¯å¢ƒéŸ³

âŒ ä¼ ç»Ÿé—®é¢˜: å¤šè½¨åè°ƒå¤æ‚
âœ… é¡ºåºæ–¹æ¡ˆ: åŸºäºå®é™…éŸ³é¢‘æ–‡ä»¶ç²¾ç¡®è®¡ç®—æ—¶é—´è½´

âŒ ä¼ ç»Ÿé—®é¢˜: åœºæ™¯è¾¹ç•Œæ¨¡ç³Š
âœ… é¡ºåºæ–¹æ¡ˆ: å¤§æ¨¡å‹ç²¾ç¡®åˆ†æåœºæ™¯åˆ‡æ¢ç‚¹
```

## ğŸ”§ é¡ºåºæ—¶é—´è½´ç”Ÿæˆ

### åŸºäºå®é™…éŸ³é¢‘çš„æ—¶é—´è½´
```python
class SequentialTimelineGenerator:
    def generate_timeline(self, dialogue_files: List[AudioFile], scene_info: List[SceneInfo]) -> Timeline:
        # åŸºäºTTS3å®é™…ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶åˆ›å»ºæ—¶é—´è½´
        timeline = Timeline()
        current_time = 0.0
        
        for i, dialogue_file in enumerate(dialogue_files):
            # è·å–å®é™…éŸ³é¢‘æ—¶é•¿
            actual_duration = get_audio_duration(dialogue_file.path)
            
            # æ·»åŠ å¯¹è¯æ®µ
            timeline.add_dialogue_segment({
                "start": current_time,
                "end": current_time + actual_duration,
                "file": dialogue_file.path,
                "duration": actual_duration,
                "scene": scene_info[i]
            })
            
            current_time += actual_duration
        
        # åŸºäºå¯¹è¯æ—¶é—´è½´ç”Ÿæˆç¯å¢ƒéŸ³æ—¶é—´è½´
        timeline.environment_tracks = self._generate_environment_timeline(
            timeline.dialogue_segments, scene_info
        )
        
        return timeline
```

### ç¯å¢ƒéŸ³æ—¶é—´è½´æ˜ å°„
```python
def _generate_environment_timeline(self, dialogue_segments: List[dict], scenes: List[SceneInfo]) -> List[EnvironmentTrack]:
    """æ ¹æ®åœºæ™¯å˜åŒ–ç”Ÿæˆç¯å¢ƒéŸ³æ—¶é—´è½´"""
    
    env_tracks = []
    current_scene = None
    scene_start_time = 0.0
    
    for segment in dialogue_segments:
        scene = segment["scene"]
        
        # æ£€æµ‹åœºæ™¯åˆ‡æ¢
        if self._is_scene_change(current_scene, scene):
            # ç»“æŸå½“å‰åœºæ™¯ç¯å¢ƒéŸ³
            if current_scene:
                env_tracks.append(EnvironmentTrack(
                    start=scene_start_time,
                    end=segment["start"],
                    scene_prompt=self._build_tango_prompt(current_scene),
                    volume=self._get_volume_for_scene(current_scene)
                ))
            
            # å¼€å§‹æ–°åœºæ™¯
            scene_start_time = segment["start"]
            current_scene = scene
    
    return env_tracks
```

## ğŸ¨ TangoFluxæç¤ºè¯ç”Ÿæˆ

### æ™ºèƒ½æç¤ºè¯æ„å»º
```python
def _build_tango_prompt(self, scene_info: SceneInfo) -> str:
    """ä¸ºTangoFluxæ„å»ºä¸“ä¸šéŸ³æ•ˆæç¤ºè¯"""
    
    # åŸºç¡€ç¯å¢ƒ
    base_prompt = f"{scene_info.location} {scene_info.weather} {scene_info.time}"
    
    # æ°›å›´å¢å¼º
    atmosphere_map = {
        "tense": "dramatic, intense, suspenseful",
        "calm": "peaceful, serene, gentle", 
        "romantic": "warm, intimate, soft",
        "mysterious": "dark, eerie, ambient"
    }
    atmosphere = atmosphere_map.get(scene_info.atmosphere, "ambient")
    
    # åˆ›æ„å»ºè®®ï¼ˆæ¥è‡ªå¤§æ¨¡å‹ï¼‰
    creative_elements = " ".join(scene_info.creative_suggestions[:3])  # å–å‰3ä¸ªå»ºè®®
    
    return f"{base_prompt}, {atmosphere}, {creative_elements}, cinematic quality"

def _get_volume_for_scene(self, scene_info: SceneInfo) -> float:
    """æ ¹æ®åœºæ™¯å†³å®šç¯å¢ƒéŸ³éŸ³é‡"""
    
    base_volume = 0.3  # åŸºç¡€éŸ³é‡30%
    
    # æ ¹æ®ç´§å¼ åº¦è°ƒèŠ‚
    tension_factor = scene_info.tension_level / 10.0
    volume_adjustment = tension_factor * 0.2  # æœ€å¤šå¢åŠ 20%
    
    return min(0.6, base_volume + volume_adjustment)  # æœ€é«˜60%
```

## ğŸ“Š è¾“å‡ºæ—¶é—´è½´ç»“æ„

```python
@dataclass
class Timeline:
    dialogue_segments: List[DialogueSegment]   # å¯¹è¯æ—¶é—´è½´
    environment_tracks: List[EnvironmentTrack] # ç¯å¢ƒéŸ³æ—¶é—´è½´
    total_duration: float                      # æ€»æ—¶é•¿
    
@dataclass
class EnvironmentTrack:
    start: float              # å¼€å§‹æ—¶é—´
    end: float               # ç»“æŸæ—¶é—´
    scene_prompt: str        # TangoFluxæç¤ºè¯
    volume: float           # éŸ³é‡çº§åˆ«
    fade_in: float = 0.5    # æ·¡å…¥æ—¶é•¿
    fade_out: float = 0.5   # æ·¡å‡ºæ—¶é•¿
```

---

**æ ¸å¿ƒä»·å€¼**: é¡ºåºç”Ÿæˆç¡®ä¿æ—¶é—´è½´ç²¾ç¡®ï¼Œå¤§æ¨¡å‹æä¾›åˆ›æ„éŸ³æ•ˆå»ºè®®ï¼