# MegaTTS3 项目执行计划

## 零、当前进度总结（更新于 2025年6月）

**核心功能已完成**：
- 完成MegaTTS3引擎集成与48GB显存优化配置
- 实现了批量处理队列系统，支持任务恢复
- 完成情感参数映射系统，支持多种情感类型
- 构建PC端管理后台框架，实现任务监控
- 完成FastAPI服务器搭建与基础HTTP接口
- 完成声场处理实现，支持立体声角色定位
- 完成批量渲染性能优化，支持多GPU并行处理
- 实现声纹特征提取与管理系统，支持自定义角色声音
- 完成角色声音映射功能，可自动识别小说角色并分配声音
- 实现角色声音自动分析与推荐系统

**待完善部分**：
- 小说管理与配置界面需要进一步完善（T008进行中）
- 任务监控页面需要对接真实API数据（T009进行中）
- API响应模型与实际返回数据存在不匹配问题
- DIFY集成示例开发尚未开始（T012待开始）

**下一步计划**：
- 修复API响应模型与实际返回数据不匹配的问题
- 完成管理界面与API的完全对接
- 优化批量渲染性能，支持超大型小说
- 开始用户手册编写

## 零（A）、最新工作计划（更新于 2025年5月19日）

### 短期计划（1-2周内）
1. **API接口完善**（优先级最高）
   - 实现`/api/system/info`接口 - 返回系统状态、GPU信息等
   - 实现`/api/stats`接口 - 返回处理任务数量、音频数等统计信息
   - 目标：让控制面板能够正确显示系统信息和统计数据
   - 【补充】实现TTS推理API支持自定义声纹特征（.wav/.npy）动态切换，推理参数（p_w、t_w）灵活配置，提升音色还原度和可控性

2. **前端管理界面完善**
   - 修复控制面板数据显示问题
   - 完善任务监控页面功能
   - 添加音频预览功能
   - 【新增】按照《[前端功能实施计划](./frontend_implementation_plan.md)》进行开发，优先完成声纹特征管理功能

3. **恢复被注释的功能模块**
   - 恢复小说管理页面（优先）
   - 恢复音频库基础功能
   - 确保菜单与路由一致

【补充】声纹特征动态切换API开发任务清单

#### 1. 需求描述
- 支持用户上传自定义声纹特征（.wav/.npy），每次TTS推理时可动态指定声纹，实现多角色/多音色灵活切换。
- 推理参数（p_w、t_w）对外暴露，前端可灵活配置，提升音色还原度和可控性。

#### 2. 关键开发任务
- [ ] 后端API设计：/api/tts/text、/api/tts/novel等接口支持声纹文件上传与参数传递
- [ ] 声纹特征管理：实现声纹文件的存储、校验、缓存与热加载机制
- [ ] 推理流程改造：每次推理动态加载指定声纹特征，支持多用户/多任务并发
- [ ] 参数校验与异常处理：对声纹文件、推理参数进行有效性校验，异常时友好提示
- [ ] 前端UI开发：支持声纹文件上传、切换，参数调节滑块，试听与批量任务配置
- [ ] 测试用例编写：覆盖声纹切换、参数边界、异常场景、批量任务等
- [ ] 文档补充：API使用说明、参数解释、常见问题FAQ

#### 3. 预期交付物
- 支持声纹特征动态切换的TTS推理API（含接口文档）
- 前端声纹上传/切换与参数调节功能
- 完整的测试用例与验收报告

#### 4. 验收标准
- 用户可上传/切换声纹特征，合成音频音色与目标声纹高度一致
- p_w、t_w参数可由前端灵活配置，合成效果可控
- 支持多用户/多任务并发，接口稳定无异常
- 文档齐全，常见问题有解答

### 中期计划（3-4周内）
1. **完善小说处理流程**
   - 实现小说内容解析与章节分段
   - 添加角色识别与音色映射功能
   - 开发批量生成控制界面

2. **音频质量提升**
   - 实现声场处理功能
   - 添加音频后处理选项
   - 开发音频质量检测工具

3. **DIFY集成开发**
   - 设计DIFY对接接口
   - 实现示例应用

### 任务优先级排序
1. `/api/system/info`和`/api/stats`接口实现
2. 控制面板数据集成修复
3. 小说管理页面功能恢复
4. 任务监控功能增强
5. 音频库功能恢复
6. 【补充】TTS推理API支持声纹特征动态切换、推理参数灵活控制

### 风险更新
前端与API集成问题已被确认为系统短板，需要优先解决，目前缺少两个关键API端点导致控制面板显示不完整，将在第一周内解决这个问题。

## 一、项目定位与目标

### 1.1 核心定位
基于MegaTTS3的PC端小说批量转语音系统，提供专业的有声书生产工具。

### 1.2 阶段目标
- **短期目标**（1-2个月）：完成PC端批量生成系统，支持基础音色与情感
- **中期目标**（3-4个月）：增强情感表达与音质，优化声场构建
- **远期目标**（6个月+）：实现交互叙事与商业生态扩展

### 1.3 MVP核心功能（短期）
```
【核心MVP】PC端小说批量生成系统
├── 小说输入：文本上传/URL抓取
├── 内容解析：章节分段与角色识别
├── 批量合成：MegaTTS3引擎驱动
└── 音频输出：章节化MP3文件
```

## 二、技术架构统一

### 2.1 技术选型确认

| 组件     | 选型               | 说明                           |
|----------|-------------------|--------------------------------|
| 核心引擎  | MegaTTS3          | 统一使用该引擎，不再考虑其他TTS引擎 |
| 部署模式  | 单机多GPU支持      | 针对48GB显存优化，不考虑分布式集群 |
| 情感控制  | 基础参数系统        | 音高、语速、能量的简化情感映射    |
| 前端框架  | Vue3+Ant Design   | PC端管理后台                    |
| API设计   | FastAPI           | 支持DIFY等第三方系统集成         |
| 存储系统  | 本地文件系统       | 短期不考虑云存储方案             |

### 2.2 架构调整要点

1. **模块重新聚焦**
   - 保留：小说内容采集、情感语音引擎、基础声场处理
   - 延后：交互式叙事、创作者生态、IP衍生

2. **系统部署简化**
   - 单机多GPU模式替代分布式集群
   - 批处理优化取代实时处理

3. **接口范围界定**
   - 管理API：PC端后台使用
   - 集成API：供DIFY等系统调用
   - 批处理API：长文本异步处理

## 三、核心里程碑规划

| 阶段 | 时间点 | 交付内容 | 状态 | 负责人 |
|------|--------|----------|------|-------|
| 环境搭建 | T+1周 | 开发环境与MegaTTS3模型部署 | ✅ 已完成 | TBD |
| 基础功能 | T+3周 | 小说解析与批量合成引擎 | ✅ 已完成 | TBD |
| PC后台 | T+5周 | 管理界面与处理流程 | 🔄 进行中 | TBD |
| API服务 | T+7周 | HTTP接口与DIFY集成 | ⚠️ 部分完成 | TBD |
| 产品测试 | T+8周 | 全流程测试与优化 | ⏳ 未开始 | TBD |

## 四、任务分解表

| 编号 | 任务名称 | 优先级 | 工期 | 前置任务 | 状态 |
|------|----------|--------|------|----------|------|
| T001 | 环境准备与MegaTTS3安装 | P0 | 2d | - | 已完成 |
| T002 | 48GB显存优化配置 | P0 | 1d | T001 | 已完成 |
| T003 | 实现小说内容解析模块 | P0 | 5d | T001 | 已完成 |
| T004 | 开发批量处理队列系统 | P0 | 4d | T001 | 已完成 |
| T005 | 情感参数映射系统 | P1 | 5d | T001 | 已完成 |
| T006 | 基础声场处理实现 | P1 | 4d | T005 | 已完成 |
| T007 | PC端管理后台框架 | P0 | 3d | - | 已完成 |
| T008 | 小说管理与配置界面 | P0 | 4d | T007 | 进行中 |
| T009 | 任务监控与音频预览 | P0 | 3d | T007、T004 | 已完成 |
| T010 | FastAPI服务搭建 | P1 | 2d | - | 已完成 |
| T011 | 基础HTTP接口实现 | P1 | 4d | T010 | 已完成 |
| T012 | DIFY集成示例开发 | P2 | 3d | T011 | 待开始 |
| T013 | 音频质量检测工具 | P2 | 4d | T005 | 待开始 |
| T014 | 批量渲染性能优化 | P1 | 5d | T004 | 已完成 |
| T015 | 用户手册编写 | P2 | 3d | T008 | 待开始 |

## 五、技术冲突解决方案

### 5.1 情感表达与声音艺术化

**原冲突**：Product.md描述三层次情感参数，但实现方案简化

**解决方案**：
- 短期：实现基础情感映射表（如`implementation.md`中所示）
- 中期：分阶段增加以下参数组：
  ```
  // 基础参数（短期）
  {pitch, speed, energy}  
  
  // 情感参数（中期）
  {vibrato, breathiness, tension}
  
  // 风格参数（远期）
  {dialect_strength, tone_style}
  ```

### 5.2 三维声场处理

**原冲突**：声场技术细节缺失，无法实现产品规划中的特性

**解决方案**：
- 短期：基于立体声的简化声场处理
  ```python
  # 简化版立体声定位
  def place_audio_source(audio, position_x):
      # -1.0(左) 到 1.0(右)
      left_gain = 1.0 - max(0, min(1.0, (position_x + 1.0) / 2.0))
      right_gain = max(0, min(1.0, (position_x + 1.0) / 2.0))
      return apply_stereo_panning(audio, left_gain, right_gain)
  ```
- 中期：引入基础的Ambisonics技术
- 远期：完整的三维声场系统

### 5.3 小说内容解析深度

**原冲突**：语义图谱与人物关系识别能力不足

**解决方案**：
- 短期：基于正则表达式的对话与角色提取
  ```python
  # 基础角色识别示例
  def extract_characters(text):
      # 基本模式：引号内对话 + "xx说/道"模式识别
      dialogue_pattern = r'"([^"]+)"\s*[，,。.！!？?]?\s*([^，,。.！!？?"\n]+)说道?'
      characters = set()
      for match in re.finditer(dialogue_pattern, text):
          speaker = match.group(2).strip()
          if len(speaker) <= 5:  # 避免误匹配过长内容
              characters.add(speaker)
      return list(characters)
  ```
- 中期：增加基于NLP的角色关系图谱

### 5.4 API与商业生态

**原冲突**：API设计未能支持产品规划中的商业模式

**解决方案**：
- 短期：专注实现基础的文本转语音与小说处理API
- 中期：预留接口扩展点，如：
  ```
  // API预留扩展点
  POST /api/tts/novel
  {
    // 当前支持的基础参数
    "novel_content": "...",
    "title": "...",
    "narrator_voice": "female_mature",
    
    // 预留未来扩展字段（当前不实现）
    "interactive_mode": false,
    "monetization_enabled": false
  }
  ```

## 六、风险管理

| 风险点 | 影响程度 | 当前状态 | 应对策略 |
|--------|----------|----------|----------|
| 48GB显存不足支持大批量处理 | 高 | ✅ 已解决 | 已实现动态分段策略和显存优化 |
| 小说内容解析准确率不足 | 中 | ⚠️ 部分解决 | 基础解析已实现，需增加人工校对和算法改进 | 
| MegaTTS3音色与预期有差距 | 中 | 🔄 正在评估 | 情感参数系统已完成，正在进行质量测试 |
| 音频合成速度不满足需求 | 高 | 🔄 正在优化 | 已实现批处理，进一步优化进行中 |
| API服务负载能力受限 | 中 | ⚠️ 需测试 | 已实现队列系统，需进行负载测试 |
| 前端与API集成问题 | 中 | 🔄 正在解决 | 任务监控页面需对接真实API数据 |

## 七、资源配置需求

### 7.1 硬件资源
- 开发/测试服务器: 48GB显存GPU + 128GB内存
- 存储: 至少2TB SSD（音频文件占用大）
- 网络: 100Mbps+带宽（支持批量下载）

### 7.2 软件资源
- MegaTTS3模型资源: 基础模型 + 至少5种音色变体
- 开发环境: Python 3.9+, CUDA 12.1, PyTorch 2.3.0
- 监控工具: Prometheus + Grafana (性能监控)

## 八、后续迭代规划

### 8.1 中期迭代（完成MVP后）
1. 增强情感表达系统
2. 完善三维声场技术
3. 支持更多音色定制
4. 提升小说解析准确率

### 8.2 远期规划（视市场反馈）
1. 交互式叙事体验
2. 创作者经济模型
3. 分布式渲染集群
4. IP衍生拓展

---

## 附录：现有文档一致性调整建议

1. **dev.md调整**:
   - 增加批处理优化部分
   - 明确48GB显存的具体参数配置

2. **implementation.md调整**:
   - 重点强化情感引擎和批处理部分
   - 简化或标记延后实现的叙事交互功能

3. **system_architecture.md调整**:
   - 确认单机多GPU架构设计
   - 强化API与DIFY集成细节

4. **Product.md调整**:
   - 标记远期功能与短期功能
   - 保留核心创新点，调整实现优先级 

# MegaTTS3 项目开发计划

## 开发阶段和目标

### 阶段一：基础框架搭建（1周）

**目标**：完成基础环境配置、核心功能模块的架构设计，并确定技术栈和工作流程。

**关键任务**：
1. 配置Python开发环境，安装必要的库和依赖
2. 克隆MegaTTS3仓库并熟悉代码结构
3. 搭建本地测试环境，包括GPU支持
4. 确定项目架构和模块划分
5. 创建版本控制仓库并设置初始项目结构

**验收标准**：
- 开发环境能正常运行MegaTTS3示例
- 项目架构文档完成
- 代码仓库初始化完毕

### 阶段二：核心功能开发（3周）

**目标**：实现基础TTS功能、声纹特征提取系统和情感控制模块。

**关键任务**：
1. **基础TTS实现**
   - 集成MegaTTS3引擎
   - 实现文本预处理流程
   - 完成基础音频合成功能

2. **情感化语音引擎**
   - 实现情感参数控制接口
   - 开发情感映射算法
   - 构建情感调节流水线

3. **声纹特征提取与管理**
   - 开发音频特征提取组件
   - 实现声纹特征保存与加载
   - 构建声纹特征库管理系统
   - 设计声纹元数据标签系统
   - 实现角色-声音映射功能

4. **API接口开发**
   - 设计RESTful API规范
   - 实现核心TTS接口
   - 添加声音管理接口
   - 开发批处理接口

**验收标准**：
- 能够成功进行基础文本到语音的转换
- 支持情感参数调节并有明显效果
- 能从音频中提取声纹特征并保存为NPY文件
- 支持基于提取的声纹特征生成音频
- API接口能正常响应并返回正确结果

### 阶段三：交互式功能开发（2周）

**目标**：增强用户交互体验，实现声场构建和交互式功能。

**关键任务**：
1. **声景空间构建**
   - 实现三维音频生成
   - 开发环境音效处理
   - 集成音频后处理流水线

2. **交互式叙事系统**
   - 实现分支故事体系
   - 开发实时选择接口
   - 构建情感过渡机制

3. **小说角色识别**
   - 开发对话检测算法
   - 实现角色说话者识别
   - 构建角色声音映射系统

**验收标准**：
- 能够生成具有空间感的三维音频
- 支持交互式故事分支选择
- 能自动识别小说中的角色并分配适当的声音

### 阶段四：PC端后台管理系统（2周）

**目标**：开发用户友好的管理界面，提供完整的管理功能。

**关键任务**：
1. **前端框架搭建**
   - 配置Vue3 + Ant Design Vue环境
   - 设计UI组件和布局

2. **核心功能页面**
   - 实现小说上传与管理
   - 开发音频预览与导出
   - 构建系统设置界面
   - 添加声音库管理界面
   - 实现角色映射编辑功能

3. **监控与日志**
   - 实现系统状态监控
   - 开发任务队列管理
   - 添加错误日志查看

**验收标准**：
- 完整的管理界面能够正常工作
- 支持所有核心功能的操作
- 界面美观且用户友好

### 阶段五：批量处理优化（1周）

**目标**：优化长篇小说处理性能，提高渲染质量与效率。

**关键任务**：
1. **并行处理优化**
   - 实现多线程/多进程处理
   - 优化GPU资源利用
   - 添加任务队列管理

2. **批量渲染流水线**
   - 开发自动分段机制
   - 实现批量音频合成
   - 构建自动合并系统

3. **质量控制**
   - 添加自动质量检测
   - 实现问题音频标记
   - 开发修复建议系统

**验收标准**：
- 能有效处理长篇小说（10万字以上）
- 处理速度相比单线程提升至少3倍
- 生成的音频质量稳定一致

### 阶段六：系统测试与Bug修复（1周）

**目标**：确保系统稳定性和性能，修复发现的问题。

**关键任务**：
1. **全面系统测试**
   - 进行功能测试
   - 执行性能压力测试
   - 进行用户体验测试

2. **Bug修复与优化**
   - 修复发现的Bug
   - 优化性能瓶颈
   - 提升用户体验

3. **文档完善**
   - 编写用户手册
   - 完善API文档
   - 整理开发文档

**验收标准**：
- 系统无重大Bug
- 性能达到预期目标
- 文档完整且清晰

### 阶段七：部署与上线（1周）

**目标**：系统完成部署并顺利上线，确保生产环境稳定运行。

**关键任务**：
1. **环境部署**
   - 配置生产服务器
   - 安装必要的依赖
   - 设置数据备份

2. **Docker容器化**
   - 创建Docker镜像
   - 配置docker-compose
   - 测试容器部署

3. **监控与告警**
   - 设置系统监控
   - 配置异常告警
   - 建立日志收集

**验收标准**：
- 系统成功部署到生产环境
- 能够处理实际业务请求
- 监控系统正常工作

## 进度安排

| 阶段 | 时间 | 负责人 | 目标 |
|------|------|-------|------|
| 阶段一 | 第1周 | 全体 | 基础框架搭建 |
| 阶段二 | 第2-4周 | 开发组 | 核心功能开发 |
| 阶段三 | 第5-6周 | 开发组 | 交互式功能开发 |
| 阶段四 | 第7-8周 | 前端组 | PC端后台管理系统 |
| 阶段五 | 第9周 | 开发组 | 批量处理优化 |
| 阶段六 | 第10周 | 测试组 | 系统测试与Bug修复 |
| 阶段七 | 第11周 | 运维组 | 部署与上线 |

## 风险管理

1. **技术风险**：
   - MegaTTS3模型适配可能存在兼容性问题
   - 解决方案：提前测试，准备备选方案

2. **进度风险**：
   - 核心功能开发可能超出预期时间
   - 解决方案：设置中间里程碑，及时调整计划

3. **资源风险**：
   - GPU资源不足可能影响开发效率
   - 解决方案：优先分配GPU资源，必要时使用云服务

4. **质量风险**：
   - 语音合成质量可能不满足预期
   - 解决方案：建立质量评估标准，及时调整模型参数 